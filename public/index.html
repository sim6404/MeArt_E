<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeArt - AI ÏïÑÌä∏ ÏÉùÏÑ±Í∏∞</title>
    <!-- Google Fonts: Pretendard, Inter, Noto Sans Îì± -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="api.js"></script>
    <script src="net-utils.js"></script>
    
    <!-- üîß ÏÑúÎπÑÏä§ÏõåÏª§ Îì±Î°ù (Railway Î∞∞Ìè¨ ÏµúÏ†ÅÌôî) -->
    <script>
    if ('serviceWorker' in navigator) {
      (async () => {
        try {
          // Íµ¨ Ï∫êÏãú Ï†ïÎ¶¨ (Render‚ÜíRailway Ï†ÑÌôò ÌõÑ)
          const keys = await caches.keys();
          for (const k of keys) {
            if (/meart-|render/i.test(k)) {
              console.log('üßπ Íµ¨ Ï∫êÏãú ÏÇ≠Ï†ú:', k);
              await caches.delete(k);
            }
          }
          
          const reg = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
          // ÏÉà SWÍ∞Ä Ïò§Î©¥ ÍµêÏ≤¥
          if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
          reg.addEventListener('updatefound', () => {
            const sw = reg.installing;
            if (!sw) return;
            sw.addEventListener('statechange', () => {
              if (sw.state === 'installed' && navigator.serviceWorker.controller) {
                // Í∞ïÏ†ú ÏÉàÎ°úÍ≥†Ïπ®ÏúºÎ°ú Íµ¨ Ï∫êÏãú/Íµ¨ Ïò§Î¶¨ÏßÑ Î¨∏Ï†ú Ï†úÍ±∞
                location.reload();
              }
            });
          });
          navigator.serviceWorker.addEventListener('message', (e) => {
            if (e.data === 'reload') location.reload();
          });
        } catch (e) {
          console.warn('SW register failed', e);
        }
      })();
    }
    </script>
    
    <!-- üîß Ïù∏Ìä∏Î°ú Î≤ÑÌäºÏö© Ï¶âÏãú ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ìï®ÏàòÎì§ -->
    <script>
        // Firebase Ïù∏Ï¶ù Ìï®ÏàòÎì§ÏùÑ Ï¶âÏãú Î°úÎìú
        function showLoginModal() {
            console.log('üîò showLoginModal Ìò∏Ï∂úÎê®');
            
            // Î™®Îì† ÏöîÏÜå Ï°¥Ïû¨ ÌôïÏù∏
            const modal = document.getElementById('authModal');
            const title = document.getElementById('authModalTitle');
            const submitBtn = document.getElementById('authSubmitBtn');
            const username = document.getElementById('authUsername');
            const form = document.getElementById('authForm');
            
            console.log('üîç Î™®Îã¨ ÏöîÏÜå ÌôïÏù∏:', {
                modal: !!modal,
                title: !!title,
                submitBtn: !!submitBtn,
                username: !!username,
                form: !!form
            });
            
            if (!modal) {
                console.error('‚ùå authModal ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
                alert('Î°úÍ∑∏Ïù∏ Î™®Îã¨ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // Î™®Îã¨ ÏÑ§Ï†ï
            if (title) title.textContent = 'Î°úÍ∑∏Ïù∏';
            if (submitBtn) submitBtn.textContent = 'Î°úÍ∑∏Ïù∏';
            if (username) {
                username.style.display = 'none';
                username.removeAttribute('required');
            }
            if (form) form.onsubmit = handleLogin;
            
            // Î™®Îã¨ ÌëúÏãú (Í∞ïÏ†úÎ°ú ÏµúÏÉÅÏúÑÏóê ÌëúÏãú)
            modal.style.display = 'flex';
            modal.style.position = 'fixed';
            modal.style.zIndex = '999999';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            console.log('‚úÖ Î°úÍ∑∏Ïù∏ Î™®Îã¨ ÌëúÏãú ÏôÑÎ£å');
        }

        function showSignupModal() {
            console.log('üîò showSignupModal Ìò∏Ï∂úÎê®');
            document.getElementById('authModalTitle').textContent = 'ÌöåÏõêÍ∞ÄÏûÖ';
            document.getElementById('authSubmitBtn').textContent = 'ÌöåÏõêÍ∞ÄÏûÖ';
            document.getElementById('authUsername').style.display = 'block';
            document.getElementById('authUsername').setAttribute('required', 'required');
            document.getElementById('authForm').onsubmit = handleSignup;
            document.getElementById('authModal').style.display = 'flex';
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            document.getElementById('authForm').reset();
            // required ÏÜçÏÑ± Ï¥àÍ∏∞Ìôî
            document.getElementById('authUsername').removeAttribute('required');
            document.getElementById('authUsername').style.display = 'none';
        }

        // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Îì±Î°ù
        window.showLoginModal = showLoginModal;
        window.showSignupModal = showSignupModal;
        window.closeAuthModal = closeAuthModal;
    </script>

    
    <style>
        :root {
            /* üé® ÏÉâÏÉÅ ÏãúÏä§ÌÖú */
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --primary-50: rgba(99, 102, 241, 0.05);
            --primary-100: rgba(99, 102, 241, 0.1);
            --primary-500: rgba(99, 102, 241, 0.5);
            
            --accent: #f59e0b;
            --accent-light: #fbbf24;
            --accent-dark: #d97706;
            
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            
            /* üåà Î∞∞Í≤Ω & ÌëúÎ©¥ */
            --background: #f8fafc;
            --background-secondary: #f1f5f9;
            --surface: #ffffff;
            --surface-secondary: #f8fafc;
            --surface-elevated: #ffffff;
            
            /* üìù ÌÖçÏä§Ìä∏ */
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --text-disabled: #94a3b8;
            --text-on-primary: #ffffff;
            
            /* üî≤ Í≤ΩÍ≥ÑÏÑ† */
            --border-primary: #e2e8f0;
            --border-secondary: #cbd5e1;
            --border-focus: var(--primary);
            
            /* üåä Í∑∏Î¶ºÏûê */
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            
            /* üìê Îë•Í∑º Î™®ÏÑúÎ¶¨ */
            --radius-xs: 4px;
            --radius-sm: 8px;
            --radius: 12px;
            --radius-md: 16px;
            --radius-lg: 20px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            /* üìè Í∞ÑÍ≤© */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space: 1rem;
            --space-md: 1.5rem;
            --space-lg: 2rem;
            --space-xl: 3rem;
            --space-2xl: 4rem;
            
            /* ‚ú® Ïï†ÎãàÎ©îÏù¥ÏÖò */
            --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-out: cubic-bezier(0, 0, 0.2, 1);
            --ease-in: cubic-bezier(0.4, 0, 1, 1);
            
            /* üé® Í∑∏ÎùºÎîîÏñ∏Ìä∏ */
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-surface: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            --gradient-glass: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            
            /* üì± Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
            --touch-target: 44px;
            --mobile-padding: 1rem;
            --mobile-gap: 0.75rem;
        }
        /* üèóÔ∏è Í∏∞Î≥∏ Î†àÏù¥ÏïÑÏõÉ */
        * {
            box-sizing: border-box;
        }
        
        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }
        
        html, body {
            font-family: 'Inter', 'Pretendard', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            font-size: 16px;
            scroll-behavior: smooth;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: var(--gradient-surface);
            overflow-x: hidden;
        }
        
        /* üéØ Ìè¨Ïª§Ïä§ Ï†ëÍ∑ºÏÑ± */
        *:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        /* üì± ÌÑ∞Ïπò ÏµúÏ†ÅÌôî */
        @media (hover: none) and (pointer: coarse) {
            * {
                -webkit-tap-highlight-color: transparent;
            }
        }
        
        /* üîß Î™®Î∞îÏùº ÌôîÎ©¥ Ï†ÑÌôò Í∞ïÏ†ú Ï≤òÎ¶¨ */
        .intro-screen.hidden-force {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            z-index: -9999 !important;
            position: absolute !important;
            top: -9999px !important;
            left: -9999px !important;
            pointer-events: none !important;
        }
        /* üß≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
        .nav {
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: var(--shadow-sm);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space) var(--space-lg);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-primary);
            transition: var(--transition);
        }
        
        .nav:hover {
            box-shadow: var(--shadow-md);
        }
        .nav-logo {
            font-size: 2.2rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1.5px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .nav-logo-img {
            height: 4.4rem; /* 2.2rem ‚Üí 4.4remÏúºÎ°ú 2Î∞∞ Ï¶ùÍ∞Ä */
            width: auto;
        }
        .nav-menu {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .nav-menu button, .nav-menu .btn {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.95rem;
            padding: 0.7rem 1.5rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        .nav-menu button.active, .nav-menu .btn.active, .nav-menu button:hover, .nav-menu .btn:hover {
            background: var(--gradient-primary);
            color: #fff;
            border-color: transparent;
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        .nav-avatar {
            min-width: 38px; height: 38px;
            border-radius: 999px;
            background: var(--primary);
            color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 0.98rem;
            margin-left: 0.7rem;
            padding: 0 1.2rem;
            box-shadow: 0 2px 8px rgba(90,111,240,0.08);
            border: none;
            transition: var(--transition);
            cursor: pointer;
        }
        .nav-avatar:hover {
            background: var(--primary-dark);
        }
        /* üì¶ Ïª®ÌÖåÏù¥ÎÑà & Ïπ¥Îìú */
        .container {
            max-width: 600px;
            margin: var(--space-lg) auto 0 auto;
            padding: 0 var(--mobile-padding) var(--space-xl) var(--mobile-padding);
        }
        
        .card {
            background: var(--surface-elevated);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: var(--space-xl) var(--space-lg) var(--space-lg) var(--space-lg);
            margin-bottom: var(--space-xl);
            transition: var(--transition);
            border: 1px solid var(--border-primary);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-glass);
            opacity: 0;
            transition: var(--transition);
            pointer-events: none;
        }
        
        .card:hover::after {
            opacity: 1;
        }
        .card-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            text-align: center;
            position: relative;
        }
        .upload-area {
            border: 2.5px dashed var(--primary);
            border-radius: var(--radius);
            background: #f3f6ff;
            padding: 2.5rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 1.2rem;
        }
        .upload-area:hover, .upload-area.dragover {
            background: #e7eaff;
            border-color: var(--accent);
        }
        .upload-icon {
            font-size: 2.7rem;
            color: var(--primary);
            margin-bottom: 0.7rem;
        }
        .upload-text {
            font-size: 1.1rem;
            color: #444;
            margin-bottom: 0.3rem;
        }
        .upload-hint {
            font-size: 0.92rem;
            color: #888;
        }
        #fileInput { display: none; }
        .image-preview {
            display: flex !important;
            gap: 1.2rem;
            justify-content: center !important;
            margin: 1.2rem auto 0.5rem auto !important;
            flex-wrap: wrap;
            align-items: center !important;
        }
        .preview-container {
            text-align: center !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            /* Ï∂îÍ∞Ä: Îçî Î™ÖÌôïÌïú Ï§ëÏïô Ï†ïÎ†¨ */
            width: 100% !important;
            max-width: 300px !important;
            min-height: 220px;
            margin: 0 auto !important;
        }
        .preview-image {
            max-width: 180px;
            max-height: 180px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(60,60,120,0.08);
            border: 2px solid #f0f0f0;
            object-fit: contain !important;
            /* Ï∂îÍ∞Ä: ÏôÑÎ≤ΩÌïú Ï§ëÏïô Ï†ïÎ†¨ */
            display: block !important;
            margin: 0 auto !important;
            object-position: center center !important;
        }
        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1.2rem 0 0.5rem 0;
            flex-wrap: wrap;
        }
        /* üîò Î≤ÑÌäº ÏãúÏä§ÌÖú */
        .btn {
            /* Í∏∞Î≥∏ Ïä§ÌÉÄÏùº */
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            line-height: 1.5;
            cursor: pointer;
            transition: var(--transition);
            background: var(--gradient-primary);
            color: var(--text-on-primary);
            box-shadow: var(--shadow-sm);
            
            /* Î†àÏù¥ÏïÑÏõÉ */
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            text-decoration: none;
            text-align: center;
            white-space: nowrap;
            
            /* ÌÑ∞Ïπò ÏπúÌôîÏ†Å */
            min-height: var(--touch-target);
            min-width: var(--touch-target);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), transparent);
            opacity: 0;
            transition: var(--transition-fast);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            filter: brightness(1.05);
        }
        
        .btn:hover::before {
            opacity: 1;
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        
        /* Î≤ÑÌäº Î≥ÄÌòï */
        .btn.secondary {
            background: var(--surface-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--border-primary);
            box-shadow: var(--shadow-xs);
        }
        
        .btn.secondary:hover {
            background: var(--surface);
            color: var(--text-primary);
            border-color: var(--primary);
        }
        
        .btn.outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn.outline:hover {
            background: var(--primary);
            color: var(--text-on-primary);
        }
        
        .btn.ghost {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            box-shadow: none;
        }
        
        .btn.ghost:hover {
            background: var(--primary-50);
            color: var(--primary);
        }
        
        /* Î≤ÑÌäº ÌÅ¨Í∏∞ */
        .btn.sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            min-height: 36px;
        }
        
        .btn.lg {
            padding: 1rem 2rem;
            font-size: 1rem;
            min-height: 52px;
        }
        
        .btn.xl {
            padding: 1.25rem 2.5rem;
            font-size: 1.125rem;
            min-height: 60px;
            font-weight: 700;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            filter: none;
        }
        
        .btn:disabled:hover {
            transform: none;
            box-shadow: var(--shadow-xs);
        }
        /* üîÑ Î°úÎî© & Ïä§ÌîºÎÑà */
        .loading {
            display: none;
            text-align: center;
            padding: var(--space-lg) 0;
        }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space);
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-primary);
            border-top: 4px solid var(--primary);
            border-radius: var(--radius-full);
            animation: spin 1s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }
        
        .spinner.sm {
            width: 24px;
            height: 24px;
            border-width: 2px;
        }
        
        .spinner.lg {
            width: 64px;
            height: 64px;
            border-width: 6px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* üîî ÌÜ†Ïä§Ìä∏ ÏïåÎ¶º */
        .toast {
            position: fixed;
            left: 50%;
            bottom: var(--space-xl);
            transform: translateX(-50%);
            background: var(--surface-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-lg);
            padding: var(--space) var(--space-lg);
            font-size: 0.875rem;
            font-weight: 600;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition);
            backdrop-filter: blur(20px);
            max-width: 90vw;
        }
        
        .toast.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(-50%) translateY(-8px);
        }
        
        .toast.success {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        
        .toast.error {
            background: var(--error);
            color: white;
            border-color: var(--error);
        }
        
        .toast.warning {
            background: var(--warning);
            color: white;
            border-color: var(--warning);
        }
        .emotion-feedback {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: #fff;
            border-radius: var(--radius);
            padding: 1.2rem 1rem;
            margin: 1.2rem 0;
            text-align: center;
            box-shadow: 0 4px 16px rgba(90,111,240,0.13);
            animation: fadeInUp 0.6s ease-out;
        }
        .emotion-feedback h3 {
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
            font-weight: 700;
        }
        .emotion-feedback p {
            font-size: 1rem;
            line-height: 1.5;
            margin: 0;
        }
        .emotion-icon {
            font-size: 2.1rem;
            margin-bottom: 0.3rem;
            display: block;
            border-radius: 0 !important;
            overflow: visible !important;
        }
        .emotion-img {
            width: 128px !important;
            height: 128px !important;
            min-width: 128px !important;
            min-height: 128px !important;
            max-width: 128px !important;
            max-height: 128px !important;
            border-radius: 0 !important;
            border: none !important;
            object-fit: contain !important;
            object-position: center center !important;
            margin: 20px auto 10px auto !important;
            padding: 0 !important;
            box-sizing: border-box !important;
            display: block !important;
            clip-path: none !important;
            mask: none !important;
        }
        /* ‚ú® Ïï†ÎãàÎ©îÏù¥ÏÖò ÎùºÏù¥Î∏åÎü¨Î¶¨ */
        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes fadeInDown {
            from { 
                opacity: 0; 
                transform: translateY(-30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes fadeInLeft {
            from { 
                opacity: 0; 
                transform: translateX(-30px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
        
        @keyframes fadeInRight {
            from { 
                opacity: 0; 
                transform: translateX(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
        
        @keyframes scaleIn {
            from { 
                opacity: 0; 
                transform: scale(0.8); 
            }
            to { 
                opacity: 1; 
                transform: scale(1); 
            }
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
            }
            50% { 
                transform: scale(1.05); 
            }
        }
        
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translateY(0);
            }
            40%, 43% {
                transform: translateY(-15px);
            }
            70% {
                transform: translateY(-7px);
            }
            90% {
                transform: translateY(-3px);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: calc(200px + 100%) 0;
            }
        }
        
        /* Ïï†ÎãàÎ©îÏù¥ÏÖò Ïú†Ìã∏Î¶¨Ìã∞ ÌÅ¥ÎûòÏä§ */
        .animate-fadeInUp {
            animation: fadeInUp 0.6s var(--ease-out);
        }
        
        .animate-fadeInDown {
            animation: fadeInDown 0.6s var(--ease-out);
        }
        
        .animate-fadeInLeft {
            animation: fadeInLeft 0.6s var(--ease-out);
        }
        
        .animate-fadeInRight {
            animation: fadeInRight 0.6s var(--ease-out);
        }
        
        .animate-scaleIn {
            animation: scaleIn 0.4s var(--ease-out);
        }
        
        .animate-pulse {
            animation: pulse 2s infinite;
        }
        
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        
        /* Ìò∏Î≤Ñ Ìö®Í≥ºÎì§ */
        .hover-lift {
            transition: var(--transition);
        }
        
        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .hover-scale {
            transition: var(--transition);
        }
        
        .hover-scale:hover {
            transform: scale(1.02);
        }
        
        .hover-glow {
            transition: var(--transition);
        }
        
        .hover-glow:hover {
            box-shadow: 0 0 20px var(--primary-100);
        }
        .result-section {
            margin-top: 1.5rem;
            text-align: center !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
        }
        .result-image {
            max-width: 320px;
            max-height: 320px;
            border-radius: 14px;
            box-shadow: 0 8px 24px rgba(60,60,120,0.13);
            margin: 1rem auto !important;
            display: block !important;
            object-fit: contain !important;
            object-position: center center !important;
        }
        #brushResultSection {
            border-top: 2px solid #e0e4f7;
            padding-top: 24px;
            margin-top: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        #brushResultSection h3 {
            color: #764ba2;
            font-weight: 700;
        }
        /* üì• Îã§Ïö¥Î°úÎìú Î≤ÑÌäº */
        .download-btn {
            background: var(--success);
            color: var(--text-on-primary);
            padding: var(--space-sm) var(--space-lg);
            border: none;
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: var(--space-sm);
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            box-shadow: var(--shadow-sm);
            min-height: var(--touch-target);
        }
        
        .download-btn:hover {
            background: var(--success);
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .download-btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-xs);
        }
        /* üé® Î™ÖÌôî Ï∂îÏ≤ú ÏÑπÏÖò */
        .artwork-recommendations {
            margin-top: var(--space-lg);
            padding: var(--space-lg) var(--space);
            background: var(--primary-50);
            border-radius: var(--radius-lg);
            border: 1px solid var(--primary-100);
            transition: var(--transition);
        }
        
        .artwork-recommendations:hover {
            background: var(--primary-100);
            border-color: var(--primary);
        }
        
        .artwork-recommendations h3 {
            text-align: center;
            margin-bottom: var(--space);
            color: var(--primary-dark);
            font-size: 1.125rem;
            font-weight: 700;
        }
        
        .artwork-grid {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space);
            margin-top: var(--space-sm);
            justify-content: center;
            padding: 0 var(--space-xs);
        }
        
        .artwork-item {
            background: var(--surface-elevated);
            border-radius: var(--radius);
            padding: var(--space-sm);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border-primary);
            box-shadow: var(--shadow-xs);
            flex: 0 0 120px;
            position: relative;
            overflow: hidden;
        }
        
        .artwork-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-glass);
            opacity: 0;
            transition: var(--transition);
            pointer-events: none;
        }
        
        .artwork-item:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }
        
        .artwork-item:hover::before {
            opacity: 1;
        }
        
        .artwork-item:active {
            transform: translateY(-2px) scale(1.01);
            box-shadow: var(--shadow-sm);
        }
        
        .artwork-thumbnail {
            width: 100%;
            height: 90px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-sm);
            transition: var(--transition);
            background: var(--background-tertiary);
            position: relative;
        }
        
        .artwork-thumbnail.loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255,255,255,0.2), 
                transparent
            );
            animation: shimmer 1.5s infinite;
        }
        
        .artwork-thumbnail.loaded {
            opacity: 1;
        }
        
        .artwork-thumbnail.error {
            background: var(--background-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
            font-size: 0.75rem;
        }
        
        .artwork-thumbnail.error::after {
            content: 'üñºÔ∏è';
            font-size: 1.5rem;
        }
        
        .artwork-item:hover .artwork-thumbnail {
            transform: scale(1.05);
        }
        
        .artwork-info {
            position: relative;
            z-index: 1;
        }
        
        .artwork-info h4 {
            margin: 0 0 var(--space-xs) 0;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 600;
            line-height: 1.3;
        }
        
        .artwork-info p {
            margin: 0;
            color: var(--text-tertiary);
            font-size: 0.75rem;
            font-style: italic;
            line-height: 1.2;
        }
        /* ü¶∂ Ìë∏ÌÑ∞ */
        .footer {
            text-align: center;
            color: var(--text-tertiary);
            margin-top: var(--space-2xl);
            padding: var(--space-lg) 0;
            font-size: 0.875rem;
            border-top: 1px solid var(--border-primary);
            background: var(--surface-secondary);
        }
        
        /* üì± Ï∂îÍ∞Ä Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
        @media (max-width: 320px) {
            :root {
                --mobile-padding: 0.75rem;
                --mobile-gap: 0.5rem;
            }
            
            .card {
                padding: var(--space) var(--mobile-padding);
            }
            
            .btn {
                padding: 0.6rem 0.75rem;
                font-size: 0.8rem;
            }
            
            .artwork-item {
                flex: 0 0 100px;
            }
            
            .artwork-thumbnail {
                height: 75px;
            }
        }
        /* Í∞§Îü¨Î¶¨ */
        .gallery-section {
            margin-top: 2.5rem;
            padding: 2rem;
            background: var(--card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }
        .gallery-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2rem;
        }
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
        }
        .gallery-item {
            background: #fff;
            border-radius: 12px;
            padding: 0.7rem 0.5rem;
            box-shadow: 0 2px 8px rgba(60,60,120,0.07);
            transition: var(--transition);
            position: relative;
        }
        .gallery-item:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 8px 24px rgba(90,111,240,0.13);
        }
        .gallery-item img {
            width: 100%;
            height: 90px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        .gallery-item h4 {
            margin: 0 0 4px 0;
            color: var(--primary-dark);
            font-size: 0.98rem;
        }
        .gallery-item p {
            margin: 0 0 4px 0;
            color: #666;
            font-size: 0.85rem;
        }
        .gallery-item .emotion-tag {
            display: inline-block;
            padding: 2px 8px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: #fff;
            border-radius: 999px;
            font-size: 0.8rem;
            margin-bottom: 4px;
        }
        .gallery-item .delete-btn {
            position: absolute;
            top: 8px; right: 8px;
            background: #dc3545;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 24px; height: 24px;
            cursor: pointer;
            font-size: 13px;
            transition: var(--transition);
        }
        .gallery-item .delete-btn:hover { background: #c82333; }
        /* Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            .container { 
                max-width: 100%; 
                padding: 0 1rem 2rem 1rem; 
                margin: 1.5rem auto 0 auto;
            }
            .nav { 
                padding: 0.8rem 1.5rem; 
                border-radius: 0 0 var(--radius) var(--radius);
            }
            .nav-logo {
                font-size: 1.8rem;
            }
            .card { 
                padding: 2rem 1.5rem 1.5rem 1.5rem; 
                margin-bottom: 2rem;
            }
            .card-title {
                font-size: 1.5rem;
            }
            .camera-btn {
                width: 150px;
                height: 150px;
            }
            .camera-btn .camera-icon {
                font-size: 2.5rem;
            }
            .camera-btn .camera-text {
                font-size: 0.9rem;
            }
            .gallery-grid, .artwork-grid { 
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
                gap: 0.8rem;
            }
        }
        @media (max-width: 480px) {
            .nav { 
                flex-direction: column; 
                gap: 1rem; 
                padding: 1rem;
            }
            .nav-logo { 
                font-size: 1.6rem; 
            }
            .nav-menu { 
                gap: 0.5rem; 
                flex-wrap: wrap;
                justify-content: center;
            }
            .nav-menu button, .nav-menu .btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
            .container { 
                padding: 0 0.5rem 1.5rem 0.5rem; 
                margin: 1rem auto 0 auto;
            }
            .card { 
                padding: 1.5rem 1rem 1rem 1rem; 
                margin-bottom: 1.5rem;
            }
            .card-title {
                font-size: 1.3rem;
            }
            .camera-section {
                padding: 1.5rem;
                min-height: 160px;
            }
            .camera-btn {
                width: 120px;
                height: 120px;
                gap: 0.5rem;
            }
            .camera-btn .camera-icon {
                font-size: 2rem;
            }
            .camera-btn .camera-text {
                font-size: 0.8rem;
            }
            .gallery-grid, .artwork-grid { 
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 0.6rem;
            }
            .gallery-section {
                padding: 1.5rem 1rem;
            }
        }
        
        /* ===== Ï∂îÍ∞Ä Ïù¥ÎØ∏ÏßÄ Ï§ëÏïô Ï†ïÎ†¨ Í∞ïÌôî ===== */
        #processedImage {
            display: block !important;
            margin: 1rem auto !important;
            object-fit: contain !important;
            object-position: center center !important;
            max-width: 100% !important;
        }
        
        /* Ïù∏Ï¶ù Î™®Îã¨ (Î°úÍ∑∏Ïù∏/ÌöåÏõêÍ∞ÄÏûÖ) */
        .auth-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw; height: 100vh;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        .auth-modal-content {
            background: var(--card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            padding: 2.5rem 2rem 2rem 2rem;
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.5s ease-out;
        }
        .auth-modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        .auth-modal-content h2 {
            color: var(--primary-dark);
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 1.2rem;
            text-align: center;
        }
        .auth-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .auth-form input {
            width: 100%;
            padding: 0.85rem 1.1rem;
            border: 1.5px solid #e0e4f7;
            border-radius: 999px;
            font-size: 1rem;
            background: #f6f7fb;
            color: #222;
            outline: none;
            transition: border 0.2s;
        }
        .auth-form input:focus {
            border-color: var(--primary);
            background: #f3f6ff;
        }
        .auth-form button.btn {
            margin-top: 0.5rem;
            width: 100%;
            padding: 0.85rem 0;
            font-size: 1.08rem;
        }
        .auth-modal .btn.secondary {
            width: 100%;
            margin-top: 0.5rem;
        }
        @media (max-width: 480px) {
            .auth-modal-content {
                padding: 1.2rem 0.5rem 1rem 0.5rem;
                max-width: 98vw;
            }
            .auth-form input, .auth-form button.btn, .auth-modal .btn.secondary {
                font-size: 0.98rem;
                padding: 0.7rem 0.7rem;
            }
        }
        
        /* Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal { position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;}
        .modal-content { background:#fff;padding:32px 24px;border-radius:12px;min-width:400px;position:relative;}
        .close { position:absolute;top:12px;right:18px;font-size:2rem;cursor:pointer;}
        .btn.danger { background:#dc3545;color:#fff; }
        .btn.danger:hover { background:#b52a37; }
        .btn.warning { background:#f59e0b;color:#fff; }
        .btn.warning:hover { background:#d97706; }
        
        /* Ïπ¥Î©îÎùº ÏÑπÏÖò Ïä§ÌÉÄÏùº */
        .camera-section {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            padding: 2rem;
        }
        
        .camera-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            width: 180px;
            height: 180px;
            border: none;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: #fff;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }
        
        .camera-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .camera-btn:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 25px 50px rgba(102, 126, 234, 0.4);
        }
        
        .camera-btn:hover::before {
            opacity: 1;
        }
        
        .camera-btn .camera-icon {
            font-size: 3rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        
        .camera-btn .camera-text {
            font-size: 0.95rem;
            font-weight: 600;
            text-align: center;
            line-height: 1.3;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        /* Ïù∏Ìä∏Î°ú ÌôîÎ©¥ Ïä§ÌÉÄÏùº */
        .intro-screen {
            position: fixed;
            z-index: 9999;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: url('intro.png') center/cover no-repeat;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            overflow: hidden;
        }
        
        .intro-nav {
            width: 100%;
            padding: 2rem 3rem 0 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .intro-logo {
            font-size: 2.5rem;
            font-weight: 800;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            letter-spacing: -1px;
        }
        
        .intro-nav-buttons {
            display: flex;
            gap: 1rem;
        }
        
        .intro-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-decoration: none;
            outline: none;
        }
        
        .intro-btn-outline {
            background: transparent;
            color: #fff;
            border-color: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .intro-btn-outline:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        .intro-btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .intro-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }
        
        .intro-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 2rem;
        }
        
        .intro-hero {
            margin-bottom: 3rem;
        }
        
        .intro-title {
            font-size: 4.5rem;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            letter-spacing: -3px;
            margin: 0 0 1rem 0;
            line-height: 1;
            background: linear-gradient(135deg, #fff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .intro-logo-img {
            max-height: 9rem;
            width: auto;
            filter: drop-shadow(0 4px 20px rgba(0, 0, 0, 0.3));
        }
        
        .intro-subtitle {
            font-size: 2.5rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            margin-bottom: 2rem;
            letter-spacing: -1px;
        }
        
        .intro-description {
            font-size: 1.4rem;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.8;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
        }
        
        .intro-description p {
            margin: 0.5rem 0;
        }
        
        .intro-action {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        
        .intro-start-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            font-size: 2.5rem;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .intro-start-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .intro-start-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }
        
        .intro-start-btn:hover::before {
            opacity: 1;
        }
        
        .camera-icon {
            font-size: 2.5rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            transform: translateY(-5px);
        }
        
        .intro-action-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
        }
        
        .intro-footer {
            width: 100%;
            padding: 2rem 3rem 3rem 3rem;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.05);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .intro-features {
            display: flex;
            justify-content: center;
            gap: 0; /* Ïó¨Î∞± ÏôÑÏ†Ñ ÏÇ≠Ï†ú */
            max-width: 600px;
            margin: 0 auto;
        }
        
        .feature-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            text-align: center;
        }
        
        .feature-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        
        /* üì± ÌÉúÎ∏îÎ¶ø Î∞òÏùëÌòï (768px Ïù¥Ìïò) */
        @media (max-width: 768px) {
            :root {
                --mobile-padding: 1.5rem;
                --mobile-gap: 1rem;
            }
            
            .nav {
                padding: var(--space-sm) var(--mobile-padding);
                border-radius: 0 0 var(--radius) var(--radius);
            }
            
            .nav-logo {
                font-size: 1.75rem;
            }
            
            .nav-menu {
                gap: var(--space-sm);
            }
            
            .nav-menu button, .nav-menu .btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.875rem;
            }
            
            .container {
                max-width: 100%;
                padding: 0 var(--mobile-padding) var(--space-lg) var(--mobile-padding);
                margin-top: var(--space);
            }
            
            .card {
                margin-bottom: var(--space-lg);
                padding: var(--space-lg) var(--mobile-padding) var(--mobile-padding) var(--mobile-padding);
                border-radius: var(--radius-lg);
            }
            
            .card-title {
                font-size: 1.5rem;
                margin-bottom: var(--space);
            }
            
            /* Ïù∏Ìä∏Î°ú ÌôîÎ©¥ */
            .intro-nav {
                padding: var(--space) var(--mobile-padding) 0 var(--mobile-padding);
            }
            
            .intro-logo {
                font-size: 2rem;
            }
            
            .intro-btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.875rem;
            }
            
            .intro-title {
                font-size: 3.5rem;
                letter-spacing: -2px;
            }
            
            .intro-subtitle {
                font-size: 2rem;
            }
            
            .intro-description {
                font-size: 1.2rem;
                padding: 0 var(--mobile-padding);
            }
            
            .intro-start-btn {
                width: 80px;
                height: 80px;
                font-size: 2rem;
            }
            
            .intro-footer {
                padding: var(--space-lg) var(--mobile-padding) var(--space-xl) var(--mobile-padding);
            }
            
            .intro-features {
                gap: var(--mobile-gap);
            }
        }
        
        /* üì± Î™®Î∞îÏùº Ï†ÑÏö© (480px Ïù¥Ìïò) */
        @media (max-width: 480px) {
            :root {
                --mobile-padding: 1rem;
                --mobile-gap: 0.75rem;
                --touch-target: 48px; /* Îçî ÌÅ∞ ÌÑ∞Ïπò ÏòÅÏó≠ */
            }
            
            /* üß≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
            .nav {
                padding: var(--space-sm) var(--mobile-padding);
                flex-wrap: wrap;
                gap: var(--space-sm);
            }
            
            .nav-logo {
                font-size: 1.5rem;
            }
            
            .nav-menu {
                flex-wrap: wrap;
                gap: var(--space-xs);
            }
            
            .nav-menu button, .nav-menu .btn {
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
                min-height: 40px;
            }
            
            /* üì¶ Ïª®ÌÖåÏù¥ÎÑà & Ïπ¥Îìú */
            .container {
                padding: 0 var(--mobile-padding) var(--space-lg) var(--mobile-padding);
                margin-top: var(--space-sm);
            }
            
            .card {
                margin-bottom: var(--space);
                padding: var(--space) var(--mobile-padding);
                border-radius: var(--radius);
                box-shadow: var(--shadow);
            }
            
            .card-title {
                font-size: 1.25rem;
                margin-bottom: var(--mobile-gap);
            }
            
            /* üîò Î≤ÑÌäº */
            .btn {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                min-height: var(--touch-target);
                gap: var(--space-xs);
            }
            
            .btn.sm {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
                min-height: 40px;
            }
            
            .btn.lg {
                padding: 1rem 1.5rem;
                font-size: 1rem;
                min-height: 56px;
            }
            
            /* üì∏ Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ */
            .preview-container {
                padding: var(--space-sm);
                max-width: 100%;
            }
            
            .preview-image {
                max-width: 160px;
                max-height: 160px;
                border-radius: var(--radius);
            }
            
            /* üé® Î™ÖÌôî Ï∂îÏ≤ú */
            .artwork-grid {
                padding: 0 var(--space-xs);
                gap: var(--space-xs);
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .artwork-grid::-webkit-scrollbar {
                display: none;
            }
            
            .artwork-item {
                flex: 0 0 80px;
                width: 80px;
                height: 80px;
                min-width: 80px;
                border-radius: var(--radius-sm);
                overflow: hidden;
                transition: var(--transition);
            }
            
            .artwork-item:hover {
                transform: scale(1.05);
            }
            
            .artwork-item img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: var(--radius-sm);
            }
            
            /* üì± Ïù∏Ìä∏Î°ú ÌôîÎ©¥ */
            .intro-nav {
                padding: var(--mobile-padding);
                flex-direction: column;
                gap: var(--space);
                text-align: center;
            }
            
            .intro-logo {
                font-size: 1.75rem;
            }
            
            .intro-nav-buttons {
                gap: var(--space-sm);
                justify-content: center;
            }
            
            .intro-btn {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
                min-height: 40px;
            }
            
            .intro-title {
                font-size: 2.5rem;
                letter-spacing: -1px;
                margin-bottom: var(--space);
            }
            
            .intro-subtitle {
                font-size: 1.5rem;
                margin-bottom: var(--space);
            }
            
            .intro-description {
                font-size: 1rem;
                padding: 0 var(--space);
                line-height: 1.6;
            }
            
            .intro-start-btn {
                width: 70px;
                height: 70px;
                font-size: 1.75rem;
            }
            
            .intro-footer {
                padding: var(--space) var(--mobile-padding) var(--space-lg) var(--mobile-padding);
            }
            
            .intro-features {
                flex-direction: column;
                gap: var(--space);
                max-width: 100%;
            }
            
            .feature-item {
                flex-direction: row;
                gap: var(--space);
                text-align: left;
                justify-content: flex-start;
            }
            
            .feature-icon {
                font-size: 1.5rem;
                margin-bottom: 0;
                flex-shrink: 0;
            }
            
            /* üé® ÏóÖÎ°úÎìú ÏòÅÏó≠ */
            .upload-area {
                padding: var(--space-lg) var(--space);
                border-width: 2px;
            }
            
            .upload-icon {
                font-size: 2rem;
            }
            
            .upload-text {
                font-size: 1rem;
            }
            
            .upload-hint {
                font-size: 0.8rem;
            }
            
            /* üìä Í∞êÏ†ï ÌîºÎìúÎ∞± */
            .emotion-feedback {
                padding: var(--space) var(--mobile-gap);
                margin: var(--space) 0;
                border-radius: var(--radius);
            }
            
            .emotion-img {
                width: 96px !important;
                height: 96px !important;
                min-width: 96px !important;
                min-height: 96px !important;
                max-width: 96px !important;
                max-height: 96px !important;
                margin: var(--space-sm) auto !important;
            }
            
            /* üèûÔ∏è Í≤∞Í≥º Ïù¥ÎØ∏ÏßÄ */
            .result-image {
                max-width: 280px;
                max-height: 280px;
                border-radius: var(--radius);
                margin: var(--space) auto !important;
            }
            
            /* üé® Ïπ¥Î©îÎùº ÏÑπÏÖò */
            .camera-section {
                padding: var(--space-sm);
                min-height: 100px;
            }
            
            .camera-btn {
                width: 80px;
                height: 80px;
                font-size: 1.25rem;
                border-radius: var(--radius-full);
            }
        }

        /* Î°úÍ≥† Ïù¥ÎØ∏ÏßÄ Ïä§ÌÉÄÏùº */
        .logo-img {
            width: 32px;
            height: 32px;
            vertical-align: middle;
            margin-right: 8px;
        }

        /* Í∞êÏ†ï Ïù¥ÎØ∏ÏßÄ Ïä§ÌÉÄÏùº */
        .emotion-img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
        }

        /* Ïπ¥Î©îÎùº Î≤ÑÌäº ÌÖçÏä§Ìä∏ Ï†úÍ±∞ ÌõÑ Ï°∞Ï†ï */
        .camera-btn {
            width: 120px;
            height: 120px;
        }

        /* üé¨ Splash ÌôîÎ©¥ Ïä§ÌÉÄÏùº */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000; /* Ïù∏Ìä∏Î°ú ÌôîÎ©¥Î≥¥Îã§ ÏúÑÏóê */
            overflow: hidden;
            cursor: pointer;
        }

        .splash-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            background: #000;
        }
        
        /* ÌÑ∞Ïπò Ïú†ÎèÑ ÌÖçÏä§Ìä∏ */
        .splash-touch-hint {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            z-index: 10001;
            animation: pulseGlow 2s ease-in-out infinite;
            pointer-events: none;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        
        @keyframes pulseGlow {
            0%, 100% {
                opacity: 0.6;
                transform: translateX(-50%) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateX(-50%) scale(1.05);
            }
        }

        /* Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
        @media (max-width: 768px) {
            .splash-video {
                /* Î™®Î∞îÏùºÏóêÏÑú ÏÑ±Îä• ÏµúÏ†ÅÌôîÎ•º ÏúÑÌïú ÏÑ§Ï†ï */
                will-change: transform;
                transform: translateZ(0);
            }
        }

        /* Splash ÌôîÎ©¥ ÌéòÏù¥ÎìúÏïÑÏõÉ Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .splash-screen.fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        @media (max-width: 768px) {
            .preview-image {
                max-width: 100%;
                height: auto;
                object-fit: contain;
                /* Ï∂îÍ∞Ä: Î™®Î∞îÏùºÏóêÏÑúÎèÑ ÏôÑÎ≤ΩÌïú Ï§ëÏïô Ï†ïÎ†¨ */
                display: block;
                margin: 0 auto;
                object-position: center center;
                width: auto;
                max-height: 300px;
            }
            
            .image-preview {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 1rem;
                padding: 1rem;
            }
            
            .preview-container {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
        }

        /* Î∏åÎü¨Ïãú Í≤∞Í≥º Ïù¥ÎØ∏ÏßÄ Ï§ëÏïô Ï†ïÎ†¨ Í∞ïÌôî */
        #processedImage {
            display: block !important;
            margin: 0 auto !important;
            object-position: center center !important;
            text-align: center;
        }

        /* Í≤∞Í≥º ÏÑπÏÖò Ï†ÑÏ≤¥ Ï§ëÏïô Ï†ïÎ†¨ */
        .result-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Splash ÌôîÎ©¥ -->
    <div id="splashScreen" class="splash-screen">
        <video id="splashVideo" class="splash-video" autoplay muted playsinline>
            <source src="/Splash_meart.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <div class="splash-touch-hint">
            üì± ÌÑ∞ÏπòÌïòÏó¨ ÏãúÏûëÌïòÍ∏∞
        </div>
    </div>

    <!-- Ïù∏Ìä∏Î°ú ÌôîÎ©¥ -->
    <div id="introScreen" class="intro-screen" style="display: none;">
        <!-- ÏÉÅÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
        <div class="intro-nav">
            <div class="intro-nav-buttons">
                <button class="intro-btn intro-btn-outline" id="introLoginBtn" onclick="console.log('üîò Î°úÍ∑∏Ïù∏ Î≤ÑÌäº ÌÅ¥Î¶≠Îê®'); try { window.showLoginModal(); } catch(e) { console.error('‚ùå Î™®Îã¨ Ïò§Î•ò:', e); alert('Î°úÍ∑∏Ïù∏ Î™®Îã¨ Ïò§Î•ò: ' + e.message); }">Î°úÍ∑∏Ïù∏</button>
                <button class="intro-btn intro-btn-primary" id="introSignupBtn" onclick="console.log('üîò ÌöåÏõêÍ∞ÄÏûÖ Î≤ÑÌäº ÌÅ¥Î¶≠Îê®'); try { window.showSignupModal(); } catch(e) { console.error('‚ùå Î™®Îã¨ Ïò§Î•ò:', e); alert('ÌöåÏõêÍ∞ÄÏûÖ Î™®Îã¨ Ïò§Î•ò: ' + e.message); }">ÌöåÏõêÍ∞ÄÏûÖ</button>
        </div>
        </div>
        
        <!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† -->
        <div class="intro-content">
            <div class="intro-hero">
                <h1 class="intro-title"><img src="/logo_intro.png" alt="MeArt" class="intro-logo-img"></h1>
                <div class="intro-description">
                    <p>Í∞êÏ†ïÏùÑ ÏòàÏà†Î°ú Î∞îÍæ∏Îäî Ìïú ÏàúÍ∞Ñ,</p>
                    <p>ÎÇòÎßåÏùò Î™ÖÌôîÍ∞Ä ÏãúÏûëÎê©ÎãàÎã§</p>
                </div>
            </div>
            
            <div class="intro-action">
                <button id="startBtn" class="intro-start-btn">
                    <span class="camera-icon">üì∏</span>
                </button>
                <div class="intro-action-text">ÏÇ¨ÏßÑ Ï¥¨ÏòÅ/ÏóÖÎ°úÎìú</div>
            </div>
        </div>
        
        <!-- ÌïòÎã® Ï†ïÎ≥¥ -->
        <div class="intro-footer">
            <div class="intro-features">
                <div class="feature-item">
                    <span class="feature-icon">üé≠</span>
                    <span>AI Í∞êÏ†ï Î∂ÑÏÑù</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">üñºÔ∏è</span>
                    <span>Î™ÖÌôî Î∞∞Í≤Ω Ìï©ÏÑ±</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">üé®</span>
                    <span>Î∏åÎü¨Ïãú Ìö®Í≥º</span>
                </div>
            </div>
        </div>
    </div>
    <nav class="nav">
        <div class="nav-logo"><img src="/logo_icon.png" alt="MeArt" class="nav-logo-img"></div>
        <div class="nav-menu" id="navMenu">
            <button class="btn secondary" onclick="showGallery()">Í∞§Îü¨Î¶¨</button>
            <button class="btn secondary" onclick="showLoginModal()" id="navLoginBtn">Î°úÍ∑∏Ïù∏</button>
            <button class="btn secondary" onclick="showSignupModal()" id="navSignupBtn">ÌöåÏõêÍ∞ÄÏûÖ</button>
            <button class="nav-avatar btn secondary" id="navAvatar" style="display:none; border:none;">U</button>
            <button class="btn secondary" onclick="logout()" id="navLogoutBtn" style="display:none;">Î°úÍ∑∏ÏïÑÏõÉ</button>
        </div>
    </nav>
    <div class="container" id="mainContainer" style="display:none;">
        <div class="card" id="photoCard">
            <div class="card-title">ÏÇ¨ÏßÑ Ï¥¨ÏòÅ/ÏóÖÎ°úÎìú</div>
            <div class="camera-section">
                <button id="cameraBtn" class="camera-btn">
                    <span class="camera-icon">üì∏</span>
                </button>
                <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none;">
            </div>
            <!-- ÏõêÎ≥∏/Ï≤òÎ¶¨Îêú Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏÑπÏÖò ÏÇ≠Ï†úÎê® -->
            <div class="controls" id="controls" style="display: none;">
                <button class="btn secondary" onclick="resetImage()">Îã§Ïãú ÏãúÏûë</button>
                <button class="btn warning" id="retryBgRemovalBtn" onclick="retryBackgroundRemoval()" style="display: none;">üîÑ Î∞∞Í≤Ω Ï†úÍ±∞ Ïû¨ÏãúÎèÑ</button>
            </div>
            <div id="message"></div>
            <div id="emotionFeedback" style="display: none;" class="emotion-feedback">
                <span id="emotionIcon" class="emotion-icon">
                    <img id="emotionImg" src="/neutral.png" alt="Í∞êÏ†ï Î∂ÑÏÑù Ï§ë" class="emotion-img" style="width: 128px !important; height: 128px !important; border-radius: 0 !important; border: none !important; object-fit: contain !important; object-position: center center !important; margin: 20px auto 10px auto !important; padding: 0 !important; box-sizing: border-box !important; display: block !important; clip-path: none !important; mask: none !important;">
                </span>
                <h3 id="emotionTitle">Í∞êÏ†ï Î∂ÑÏÑù Í≤∞Í≥º</h3>
                <p id="emotionMessage">ÎãπÏã†Ïùò Í∞êÏ†ïÏùÑ Î∂ÑÏÑùÌïòÍ≥† ÏûàÏñ¥Ïöî...</p>
            </div>
            <div id="artworkRecommendationsContainer"></div>
            <div class="result-section" id="resultSection" style="display: none;">
                <h3>1Îã®Í≥Ñ: Î∞∞Í≤Ω Ìï©ÏÑ± Í≤∞Í≥º</h3>
                <img id="previewImage" class="result-image" alt="ÎØ∏Î¶¨Î≥¥Í∏∞ Ïù¥ÎØ∏ÏßÄ">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Ïù¥ÎØ∏ÏßÄÎ•º Ï≤òÎ¶¨ÌïòÍ≥† ÏûàÏäµÎãàÎã§...</p>
                </div>
                <br>
                <button id="brushEffectBtn" class="btn" style="display: none; margin: 16px auto; background: #764ba2; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600;">
                    üé® Ïù∏Î¨ºÎ∏åÎü¨Ïâ¨Ìö®Í≥º Ï†ÅÏö©
                </button>
                <div id="brushResultSection" style="display: none; margin-top: 24px;">
                    <h3>2Îã®Í≥Ñ: Î∏åÎü¨Ïâ¨ Ìö®Í≥º Ï†ÅÏö© Í≤∞Í≥º</h3>
                    <img id="brushResultImage" class="result-image" alt="Î∏åÎü¨Ïâ¨ Ìö®Í≥º Í≤∞Í≥º Ïù¥ÎØ∏ÏßÄ">
                    <br>
                    <div class="result-actions" style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;">
                        <a id="downloadLink" class="download-btn" download="meart_result.png">Îã§Ïö¥Î°úÎìú</a>
                        <button id="saveToGalleryBtn" class="btn" onclick="saveToGallery()" style="background: #28a745; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600;">
                            üíæ Í∞§Îü¨Î¶¨Ïóê Ï†ÄÏû•
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="gallerySection" class="gallery-section" style="display: none;">
            <div class="gallery-header">
                <h3>üé® Me Gallery (Î°úÏª¨ Î™®Îìú)</h3>
                <button class="btn" onclick="loadGallery()">ÏÉàÎ°úÍ≥†Ïπ®</button>
                <!-- Î°úÏª¨ Í∞§Îü¨Î¶¨ÏóêÏÑúÎäî ÏÇ≠Ï†ú Í∏∞Îä• ÏùºÏãú ÎπÑÌôúÏÑ±Ìôî -->
                <!--<button class="btn secondary" id="selectAllBtn" onclick="toggleSelectAllGallery()" style="margin-left:8px;">Ï†ÑÏ≤¥ÏÑ†ÌÉù</button>
                <button class="btn danger" id="batchDeleteBtn" onclick="deleteSelectedGallery()" style="margin-left:8px;display:none;">ÏÑ†ÌÉù ÏÇ≠Ï†ú</button>-->
            </div>
            <div id="galleryGrid" class="gallery-grid"></div>
        </div>
        <div class="footer">
                            <p>&copy; 2025 MeArt. AI ÏïÑÌä∏ ÏÉùÏÑ±Í∏∞ by 4Dvision</p>
        </div>
    </div>
    <!-- Ïù∏Ï¶ù Î™®Îã¨ -->
    <div id="authModal" class="auth-modal" style="display:none;">
        <div class="auth-modal-content" style="max-width:350px;">
            <h2 id="authModalTitle">Î°úÍ∑∏Ïù∏</h2>
            <form id="authForm" class="auth-form">
                <input type="text" id="authUsername" placeholder="ÏÇ¨Ïö©ÏûêÎ™Ö" required>
                <input type="email" id="authEmail" placeholder="Ïù¥Î©îÏùº" required>
                <input type="password" id="authPassword" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" required>
                <button type="submit" id="authSubmitBtn" class="btn">Î°úÍ∑∏Ïù∏</button>
            </form>
            <button onclick="closeAuthModal()" class="btn secondary" style="margin-top: 10px;">Ï∑®ÏÜå</button>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    <!-- Í∞§Îü¨Î¶¨ ÏÉÅÏÑ∏ Î™®Îã¨: Í≤∞Í≥º Ïù¥ÎØ∏ÏßÄÎßå Î≥¥Ïó¨Ï£ºÎèÑÎ°ù ÏàòÏ†ï -->
    <div id="galleryModal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close" onclick="closeGalleryModal()">&times;</span>
        <h3 id="modalTitle"></h3>
        <div style="display:flex;gap:24px;justify-content:center;">
          <div style="text-align:center;">
            <h4>Í≤∞Í≥º Ïù¥ÎØ∏ÏßÄ</h4>
            <img id="modalResult" style="max-width:420px;max-height:420px;">
          </div>
        </div>
        <p id="modalDate"></p>
      </div>
    </div>
    <script>
        let currentFile = null;
        let processedImageUrl = null;
        let currentUser = null;
        let authToken = null;
        let nobgBlob = null;
        let lastNobgPath = null; // üéØ ÎßàÏßÄÎßâ nobg ÌååÏùº Í≤ΩÎ°ú Ï†ÄÏû•
        let isBrushProcessing = false; // üéØ Î∏åÎü¨Ïãú Ìö®Í≥º Ï≤òÎ¶¨ Ï§ë ÏÉÅÌÉú
        let pendingBrushUpdate = null; // üéØ ÎåÄÍ∏∞ Ï§ëÏù∏ Î∏åÎü¨Ïãú ÏóÖÎç∞Ïù¥Ìä∏
        let currentEmotion = 'neutral'; // üéØ ÌòÑÏû¨ Í∞êÏ†ï ÏÉÅÌÉú Ï†ÄÏû•
        let currentBackground = ''; // üéØ ÌòÑÏû¨ Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ Í≤ΩÎ°ú Ï†ÄÏû•

        // ÌååÏùºÏùÑ Base64Î°ú Î≥ÄÌôòÌïòÎäî Ìï®Ïàò
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Î∞∞Í≤Ω Ìï©ÏÑ± Ìï®Ïàò (ÏõêÎ≥∏ ÎπÑÏú®/ÌÅ¨Í∏∞ Ïú†ÏßÄ)
        async function compositeBackground(foregroundImage, backgroundImage) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                const fgImg = new Image();
                const bgImg = new Image();

                fgImg.onload = function() {
                    // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞Î•º Ï†ÑÍ≤Ω(ÏóÖÎ°úÎìú ÏõêÎ≥∏) Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞Î°ú Í≥†Ï†ï
                    canvas.width = fgImg.naturalWidth;
                    canvas.height = fgImg.naturalHeight;

                    bgImg.onload = function() {
                        // Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìú ÏõêÎ≥∏ ÌÅ¨Í∏∞Î°ú ÎßûÏ∂∞ÏÑú Í∑∏Î¶º (crop/stretch)
                        ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
                        // Î∞∞Í≤Ω Ï†úÍ±∞Îêú ÏñºÍµ¥ Ïù¥ÎØ∏ÏßÄÎ•º (0,0)ÏóêÏÑú ÏõêÎ≥∏ ÌÅ¨Í∏∞Î°ú Í∑∏Î¶º
                        ctx.drawImage(fgImg, 0, 0, canvas.width, canvas.height);

                        // Í≤∞Í≥ºÎ•º Base64Î°ú Î≥ÄÌôò
                        const result = canvas.toDataURL('image/png');
                        resolve(result);
                    };
                    bgImg.onerror = () => reject(new Error('Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®'));
                    bgImg.src = backgroundImage;
                };
                fgImg.onerror = () => reject(new Error('Ï†ÑÍ≤Ω Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®'));
                fgImg.src = foregroundImage;
            });
        }



        // DOM ÏöîÏÜåÎì§
        // const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview'); // ÏÇ≠Ï†úÎêú ÏöîÏÜå - nullÏù¥ Îê† Ïàò ÏûàÏùå
        const originalImage = document.getElementById('originalImage'); // ÏÇ≠Ï†úÎêú ÏöîÏÜå - nullÏù¥ Îê† Ïàò ÏûàÏùå
        const processedImage = document.getElementById('processedImage'); // ÏÇ≠Ï†úÎêú ÏöîÏÜå - nullÏù¥ Îê† Ïàò ÏûàÏùå
        const controls = document.getElementById('controls');
        const loading = document.getElementById('loading');
        const message = document.getElementById('message');
        const resultSection = document.getElementById('resultSection');
        const previewImage = document.getElementById('previewImage');
        const brushResultSection = document.getElementById('brushResultSection');
        const brushResultImage = document.getElementById('brushResultImage');
        const downloadLink = document.getElementById('downloadLink');
        const emotionFeedback = document.getElementById('emotionFeedback');
        const emotionIcon = document.getElementById('emotionIcon');
        const emotionTitle = document.getElementById('emotionTitle');
        const emotionMessage = document.getElementById('emotionMessage');

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        // uploadArea.addEventListener('click', () => fileInput.click());
        // uploadArea.addEventListener('dragover', handleDragOver);
        // uploadArea.addEventListener('dragleave', handleDragLeave);
        // uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);

        // function handleDragOver(e) {
        //     e.preventDefault();
        //     uploadArea.classList.add('dragover');
        // }

        // function handleDragLeave(e) {
        //     e.preventDefault();
        //     uploadArea.classList.remove('dragover');
        // }

        // function handleDrop(e) {
        //     e.preventDefault();
        //     uploadArea.classList.remove('dragover');
        //     const files = e.dataTransfer.files;
        //     if (files.length > 0) {
        //         handleFile(files[0]);
        //     }
        // }

        // Î™®Î∞îÏùº ÏµúÏ†ÅÌôîÎêú Ïù¥ÎØ∏ÏßÄ Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï®Ïàò (ÏÑ±Îä• Í∞úÏÑ†)
        async function resizeImageIfMobile(file, maxSize = 800) {
            if (!isMobileDevice()) return file;
            
            // ÌååÏùº ÌÅ¨Í∏∞Í∞Ä Ïù¥ÎØ∏ ÏûëÏúºÎ©¥ Î¶¨ÏÇ¨Ïù¥Ï¶à ÏÉùÎûµ
            if (file.size < 500 * 1024) return file; // 500KB ÎØ∏ÎßåÏùÄ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
            
            return new Promise((resolve) => {
                const img = new Image();
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    img.onload = () => {
                        let { width, height } = img;
                        
                        // Ïù¥ÎØ∏ Ï†ÅÏ†àÌïú ÌÅ¨Í∏∞Î©¥ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
                        if (width <= maxSize && height <= maxSize) {
                            resolve(file);
                return;
            }
                        
                        // ÎπÑÏú® Ïú†ÏßÄÌïòÎ©∞ Î¶¨ÏÇ¨Ïù¥Ï¶à
                        const scale = Math.min(maxSize / width, maxSize / height);
                        width = Math.round(width * scale);
                        height = Math.round(height * scale);
                        
                        // Ïò§ÌîÑÏä§ÌÅ¨Î¶∞ Ï∫îÎ≤ÑÏä§ ÏÇ¨Ïö© (ÏÑ±Îä• Í∞úÏÑ†)
                        let canvas;
                        if (typeof OffscreenCanvas !== 'undefined') {
                            canvas = new OffscreenCanvas(width, height);
                        } else {
                            canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                        }
                        
                        const ctx = canvas.getContext('2d');
                        // Ïù¥ÎØ∏ÏßÄ ÌíàÏßà ÏÑ§Ï†ï (Î™®Î∞îÏùº ÏµúÏ†ÅÌôî)
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'medium';
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // ÏïïÏ∂ïÎ•† Ï°∞Ï†ï (Î™®Î∞îÏùº: Îçî ÎÜíÏùÄ ÏïïÏ∂ï)
                        const quality = file.size > 2 * 1024 * 1024 ? 0.7 : 0.85; // 2MB Ïù¥ÏÉÅÏù¥Î©¥ Îçî ÏïïÏ∂ï
                        
                        // OffscreenCanvas ÎòêÎäî ÏùºÎ∞ò CanvasÏóê Îî∞Î•∏ blob ÏÉùÏÑ±
                        if (typeof OffscreenCanvas !== 'undefined' && canvas instanceof OffscreenCanvas) {
                            canvas.convertToBlob({ type: 'image/jpeg', quality }).then(blob => {
                                const resizedFile = new File([blob], file.name, { type: 'image/jpeg' });
                                console.log(`üì± Î™®Î∞îÏùº Î¶¨ÏÇ¨Ïù¥Ï¶à (OffscreenCanvas): ${file.size} ‚Üí ${resizedFile.size} bytes`);
                                resolve(resizedFile);
                            });
                        } else {
                            canvas.toBlob((blob) => {
                                const resizedFile = new File([blob], file.name, { type: 'image/jpeg' });
                                console.log(`üì± Î™®Î∞îÏùº Î¶¨ÏÇ¨Ïù¥Ï¶à (Canvas): ${file.size} ‚Üí ${resizedFile.size} bytes`);
                                resolve(resizedFile);
                            }, 'image/jpeg', quality);
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // handleFileSelectÎ•º asyncÎ°ú Î≥ÄÍ≤ΩÌïòÏó¨ Î¶¨ÏÇ¨Ïù¥Ï¶à Ï†ÅÏö©
        async function handleFileSelect(e) {
            let file = e.target.files[0];
            if (file) {
                file = await resizeImageIfMobile(file);
                handleFile(file);
            }
        }

        // FileReader.readAsDataURL, URL.createObjectURL Îì± data: URL, blob: URL ÏÇ¨Ïö© Î∂ÄÎ∂ÑÏùÑ Î™®Îëê Ï†úÍ±∞
        // Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞, Ìï©ÏÑ± Îì± Î™®Îì† Îã®Í≥ÑÏóêÏÑú processedImageUrl(ÏÑúÎ≤Ñ URL)Îßå ÏÇ¨Ïö©

        function handleFile(file) {
            // üîß Î™®Î∞îÏùºÏóêÏÑú ÏÇ¨ÏßÑ Ï¥¨ÏòÅ ÌõÑ Ïù∏Ìä∏Î°ú ÌôîÎ©¥ ÏôÑÏ†ÑÌûà Ïà®Í∏∞Í≥† Î©îÏù∏ ÌôîÎ©¥ ÌëúÏãú
            const introScreen = document.getElementById('introScreen');
            const mainContainer = document.getElementById('mainContainer');
            const splashScreen = document.getElementById('splashScreen');
            
            console.log('üì± ÌååÏùº Ï≤òÎ¶¨ ÏãúÏûë - ÌôîÎ©¥ ÏÉÅÌÉú Í∞ïÏ†ú Ï†ÑÌôò');
            
            // Î™®Îì† Ïò§Î≤ÑÎ†àÏù¥ ÌôîÎ©¥ Í∞ïÏ†úÎ°ú Ïà®Í∏∞Í∏∞
            if (splashScreen) {
                splashScreen.style.display = 'none !important';
                splashScreen.style.visibility = 'hidden';
                splashScreen.style.zIndex = '-1';
            }
            
            if (introScreen) {
                introScreen.style.display = 'none !important';
                introScreen.style.visibility = 'hidden';
                introScreen.style.zIndex = '-9999';
                introScreen.style.position = 'absolute';
                introScreen.style.top = '-9999px';
                introScreen.classList.add('hidden-force');
                console.log('‚úÖ Ïù∏Ìä∏Î°ú ÌôîÎ©¥ ÏôÑÏ†ÑÌûà Ïà®ÍπÄ');
            }
            
            if (mainContainer) {
                mainContainer.style.display = 'block !important';
                mainContainer.style.visibility = 'visible';
                mainContainer.style.zIndex = '1';
                mainContainer.style.position = 'relative';
                console.log('‚úÖ Î©îÏù∏ ÌôîÎ©¥ Í∞ïÏ†ú ÌëúÏãú');
            }
            
            // ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ Îã§Ïãú Ìïú Î≤à ÌôïÏù∏
            setTimeout(() => {
                if (introScreen) {
                    introScreen.style.display = 'none !important';
                    introScreen.style.visibility = 'hidden !important';
                    introScreen.classList.add('hidden-force');
                    console.log('üîÑ ÏßÄÏó∞ ÌõÑ Ïù∏Ìä∏Î°ú ÌôîÎ©¥ ÏôÑÏ†Ñ Ïà®ÍπÄ Ïû¨ÌôïÏù∏');
                }
                if (mainContainer) {
                    mainContainer.style.display = 'block !important';
                    mainContainer.style.visibility = 'visible !important';
                    console.log('üîÑ ÏßÄÏó∞ ÌõÑ Î©îÏù∏ ÌôîÎ©¥ ÌëúÏãú Ïû¨ÌôïÏù∏');
                }
            }, 100);
            
            // Ï∂îÍ∞Ä ÏïàÏ†Ñ Ïû•Ïπò: 500ms ÌõÑÏóêÎèÑ Îã§Ïãú Ìïú Î≤à ÌôïÏù∏
            setTimeout(() => {
                if (introScreen) {
                    introScreen.classList.add('hidden-force');
                    console.log('üîí ÏµúÏ¢Ö ÏïàÏ†Ñ Ïû•Ïπò: Ïù∏Ìä∏Î°ú ÌôîÎ©¥ ÏôÑÏ†Ñ Ïà®ÍπÄ');
                }
            }, 500);
            
            if (!file.type.startsWith('image/')) {
                showMessage('Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.', 'error');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                showMessage('ÌååÏùº ÌÅ¨Í∏∞Îäî 10MB Ïù¥ÌïòÏó¨Ïïº Ìï©ÎãàÎã§.', 'error');
                return;
            }
            currentFile = file;
            // ÎØ∏Î¶¨Î≥¥Í∏∞Îäî ÏÑúÎ≤Ñ URLÏù¥ Î∞òÌôòÎêú ÌõÑÏóêÎßå ÎùÑÏõÄ (data: URL ÏÇ¨Ïö© Í∏àÏßÄ)
            if (imagePreview) imagePreview.style.display = 'none';
            if (controls) controls.style.display = 'none';
            if (resultSection) resultSection.style.display = 'none';
            if (processedImage) processedImage.style.display = 'none';
                hideMessage();
                // ÏûêÎèôÏúºÎ°ú Î∞∞Í≤Ω Ï†úÍ±∞, Í∞êÏ†ï Î∂ÑÏÑù, Î™ÖÌôî Ï∂îÏ≤ú Ïã§Ìñâ
                processImageAutomatically();
        }

        async function processImageAutomatically() {
            if (!currentFile) return;

            showLoading(true);
            hideMessage();

            try {
                // 1. Î∞∞Í≤Ω Ï†úÍ±∞ (ÍµêÏ∞© Î∞©ÏßÄ Í∞ïÌôî)
                console.log('üîÑ 1Îã®Í≥Ñ: Î∞∞Í≤Ω Ï†úÍ±∞ ÏãúÏûë');
                const bgResult = await removeBackgroundInternal();
                
                if (bgResult && bgResult.ok) {
                    console.log('‚úÖ Î∞∞Í≤Ω Ï†úÍ±∞ ÏÑ±Í≥µ');
                } else {
                    console.warn('‚ö†Ô∏è Î∞∞Í≤Ω Ï†úÍ±∞ Ïã§Ìå®:', bgResult?.reason || 'unknown error');
                    if (bgResult?.fallback) {
                        console.log('üîÑ ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÎ°ú Í≥ÑÏÜç ÏßÑÌñâ');
                        // ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÎ•º processedImageUrlÎ°ú ÏÑ§Ï†ï
                        const originalUrl = URL.createObjectURL(currentFile);
                        processedImageUrl = originalUrl;
                        if (processedImage) {
                            processedImage.src = originalUrl;
                            processedImage.style.display = 'block';
                        }
                        // nobgBlobÎèÑ ÏõêÎ≥∏ÏúºÎ°ú ÏÑ§Ï†ï (Ìï©ÏÑ± Ïãú ÏÇ¨Ïö©)
                        nobgBlob = currentFile;
                        // Ïû¨ÏãúÎèÑ Î≤ÑÌäº ÌëúÏãú
                        showMessage('Î∞∞Í≤Ω Ï†úÍ±∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÎ°ú Í≥ÑÏÜç ÏßÑÌñâÌï©ÎãàÎã§.', 'warning');
                        const retryBtn = document.getElementById('retryBgRemovalBtn');
                        if (retryBtn) retryBtn.style.display = 'inline-flex';
                    }
                }

                // 2. Í∞êÏ†ï Î∂ÑÏÑù (ÍµêÏ∞© Î∞©ÏßÄ)
                console.log('üîÑ 2Îã®Í≥Ñ: Í∞êÏ†ï Î∂ÑÏÑù ÏãúÏûë');
                const emotionResult = await analyzeEmotionInternal();
                if (!emotionResult) {
                    console.warn('‚ö†Ô∏è Í∞êÏ†ï Î∂ÑÏÑù Ïã§Ìå® ‚Äî Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©');
                    // ÍµêÏ∞© Î∞©ÏßÄ: Í∞êÏ†ï Î∂ÑÏÑù Ïã§Ìå®Ìï¥ÎèÑ Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©
                }

                // 3. Î™ÖÌôî Ï∂îÏ≤ú (ÍµêÏ∞© Î∞©ÏßÄ)
                console.log('üîÑ 3Îã®Í≥Ñ: Î™ÖÌôî Ï∂îÏ≤ú ÏãúÏûë');
                const detectedEmotion = emotionResult?.emotion || currentEmotion || 'neutral';
                console.log('üéØ ÏÇ¨Ïö©Ìï† Í∞êÏ†ï:', detectedEmotion);
                
                try {
                    await recommendArtworks(detectedEmotion);
                } catch (e) {
                    console.warn('‚ö†Ô∏è Î™ÖÌôî Ï∂îÏ≤ú Ïã§Ìå®:', e.message);
                }
                
                // 4. ÏûêÎèô Ìï©ÏÑ± (ÍµêÏ∞© Î∞©ÏßÄ)
                console.log('üîÑ 4Îã®Í≥Ñ: ÏûêÎèô Ìï©ÏÑ± ÏãúÏûë');
                const key = mapEmotionKey(detectedEmotion);
                const artworks = ARTWORKS_BY_EMOTION[key];
                if (artworks && artworks.length > 0) {
                    const firstArtwork = artworks[0];
                    try {
                        await applyComposite(firstArtwork.id, firstArtwork.image);
                    } catch (e) {
                        console.warn('‚ö†Ô∏è ÏûêÎèô Ìï©ÏÑ± Ïã§Ìå®:', e.message);
                        showMessage('ÏûêÎèô Ìï©ÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏàòÎèôÏúºÎ°ú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                    }
                }

            } catch (error) {
                console.error('‚ùå processImageAutomatically Ïò§Î•ò:', error);
                showMessage('Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
            } finally {
                showLoading(false);
            }
        }

        // checkServerStatus: ÍµêÏ∞© Î∞©ÏßÄ Î°úÏßÅÏúºÎ°ú ÏàòÏ†ï
        async function checkServerStatus(base = '') {
            const url = (base ? base.replace(/\/$/, '') : '') + '/api/status?t=' + Date.now();
            try {
                const res = await fetch(url, { cache: 'no-store' });
                if (res.status === 404) {
                    console.warn('‚ö†Ô∏è /api/status endpoint missing (404) ‚Äî degraded mode');
                    return null;
                }
                if (!res.ok) {
                    console.warn(`‚ö†Ô∏è /api/status error ${res.status} ‚Äî degraded mode`);
                    return null;
                }
                const json = await res.json();
                // AI ÎπÑÌôúÏÑ±ÏùÄ Ï†ïÎ≥¥ ÏàòÏ§Ä (Ïï± Ï∞®Îã®ÌïòÏßÄ ÏïäÏùå)
                if (json?.ai && !json.ai.ready) {
                    console.info(`‚ÑπÔ∏è AI not ready: ${json.ai.provider} (${json.ai.ready})`);
                }
                return json;
            } catch (e) {
                console.warn('‚ö†Ô∏è checkServerStatus failed:', e.message, '‚Äî degraded mode');
                return null; // Ïï± Î∂ÄÌä∏Îäî Í≥ÑÏÜç
            }
        }

        // callAnalyzeEmotion: Í∞êÏ†ï Î∂ÑÏÑù API Ìò∏Ï∂ú (Í≤ΩÎ°ú fallback ÏßÄÏõê)
        async function callAnalyzeEmotion({ base = '', file, imageBase64 }) {
            const urlPrimary = (base.replace(/\/$/, '') || '') + '/api/analyze-emotion';
            const urlFallback = (base.replace(/\/$/, '') || '') + '/analyze-emotion';

            const doPost = async (url) => {
                let res;
                if (file) {
                    const fd = new FormData(); fd.append('image', file);
                    res = await fetch(url, { method: 'POST', body: fd });
                } else {
                    res = await fetch(url, {
                        method: 'POST',
                        headers: { 'content-type': 'application/json', 'accept': 'application/json' },
                        body: JSON.stringify({ imageBase64 })
                    });
                }
                const text = await res.text();
                try {
                    const json = JSON.parse(text);
                    if (!res.ok || json?.ok === false) throw new Error(json?.error || `analyze-emotion ${res.status}`);
                    return json;
                } catch {
                    throw new Error(`analyze-emotion non-JSON (${res.status}): ${text.slice(0, 180)}`);
                }
            };

            try { return await doPost(urlPrimary); }
            catch (e1) { if (/404/.test(String(e1))) return await doPost(urlFallback); throw e1; }
        }

        // waitForReady: ÍµêÏ∞© Î∞©ÏßÄ Î°úÏßÅÏúºÎ°ú ÏàòÏ†ï
        async function waitForReady({ base = '', maxWaitMs = 60000, baseDelay = 300 } = {}) {
            const target = (base ? base.replace(/\/$/, '') : '') + '/readyz';
            const start = Date.now(); 
            let attempt = 0; 
            let last = '';
            
            console.log('üîÑ ÏÑúÎ≤Ñ Ï§ÄÎπÑ ÏÉÅÌÉú ÌôïÏù∏ ÏãúÏûë:', target);
            
            while (Date.now() - start < maxWaitMs) {
                try {
                    const res = await fetch(`${target}?t=${Date.now()}`, { cache: 'no-store' });
                    if (res.status === 200) {
                        console.log('‚úÖ ÏÑúÎ≤ÑÍ∞Ä Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§!');
                        return true;
                    }
                    last = `status ${res.status}`;
                } catch (e) { 
                    last = e?.message || 'network error'; 
                }
                
                const delay = Math.min(2500, baseDelay * Math.pow(2, attempt++));
                const elapsed = Math.floor((Date.now() - start) / 1000);
                
                console.log(`‚è≥ ÏÑúÎ≤Ñ Ï§ÄÎπÑ Ï§ë... (${attempt}Ìöå, ${elapsed}Ï¥à Í≤ΩÍ≥º, ${last})`);
                
                await new Promise(r => setTimeout(r, delay));
            }
            
            // ÍµêÏ∞© Î∞©ÏßÄ: ÌÉÄÏûÑÏïÑÏõÉ Ïãú false Î∞òÌôò (ÏóêÎü¨ ÎçòÏßÄÏßÄ ÏïäÏùå)
            console.warn('‚ö†Ô∏è ÏÑúÎ≤Ñ Ï§ÄÎπÑ ÌÉÄÏûÑÏïÑÏõÉ ‚Äî degraded modeÎ°ú ÏßÑÌñâ');
            return false;
        }

        async function removeBackgroundInternal() {
            try {
                // üîß ÏÑúÎ≤Ñ Ï§ÄÎπÑ ÏÉÅÌÉú ÌôïÏù∏ (ÍµêÏ∞© Î∞©ÏßÄ)
                console.log('üîç ÏÑúÎ≤Ñ Ï§ÄÎπÑ ÏÉÅÌÉú ÌôïÏù∏ Ï§ë...');
                const isServerReady = await waitForReady({ maxWaitMs: 10000 }); // 10Ï¥àÎ°ú Îã®Ï∂ï
                
                if (!isServerReady) {
                    console.log('‚ö†Ô∏è ÏÑúÎ≤Ñ Ï§ÄÎπÑ ÌôïÏù∏ Ïã§Ìå® ‚Äî degraded modeÎ°ú ÏßÑÌñâ');
                    // ÍµêÏ∞© Î∞©ÏßÄ: ÏÑúÎ≤Ñ Ï§ÄÎπÑ Ïã§Ìå®Ìï¥ÎèÑ Í≥ÑÏÜç ÏßÑÌñâ
                }
                
                // AI ÏÉÅÌÉú ÌôïÏù∏ (Ï†ïÎ≥¥ Ï†úÍ≥µÏö©, Ïï± Î∂ÄÌä∏Îäî Ï∞®Îã®ÌïòÏßÄ ÏïäÏùå)
                const base = window.apiBase ? window.apiBase() : window.location.origin;
                await checkServerStatus(base);
                
                console.log('‚úÖ ÏÑúÎ≤Ñ Ï§ÄÎπÑ ÌôïÏù∏ ÏôÑÎ£å, API Ìò∏Ï∂ú ÏãúÏûë');
                
                const formData = new FormData();
                formData.append('image', currentFile);
                
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                // üîß ÎèôÏ†Å API URL ÏÇ¨Ïö© (Railway/Render Ìò∏Ìôò)
                const apiUrl = window.apiBase ? `${window.apiBase()}/api/remove-bg` : '/api/remove-bg';
                
                console.log('üåê API Ìò∏Ï∂ú URL:', apiUrl);
                
                // üîß ÏïàÏ†ÑÌïú API Ìò∏Ï∂ú (ÌÉÄÏûÑÏïÑÏõÉ + Ìè¥Î∞±)
                let response;
                try {
                    if (window.safeFetchJson) {
                        response = await window.safeFetchJson(apiUrl, {
                            method: 'POST',
                            headers,
                            body: formData
                        }, 12000);
                    } else {
                        const res = await fetch(apiUrl, {
                            method: 'POST',
                            headers,
                            body: formData
                        });
                        const text = await res.text();
                        const json = JSON.parse(text);
                        if (!res.ok || json?.ok === false) throw new Error(json?.error || `remove-bg ${res.status}`);
                        response = json;
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è remove-bg API Ìò∏Ï∂ú Ïã§Ìå®:', e.message);
                    // ÍµêÏ∞© Î∞©ÏßÄ: API Ïã§Ìå®Ìï¥ÎèÑ ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÎ°ú Í≥ÑÏÜç ÏßÑÌñâ
                    return { ok: false, reason: e.message, fallback: true };
                }

                // üîß ÏÑ±Í≥µ ÏùëÎãµ Ï≤òÎ¶¨
                if (response && response.ok !== false) {
                    processedImageUrl = response.processedImageUrl || response.url; // Î∞òÎìúÏãú ÏÑúÎ≤Ñ URL
                    if (processedImage) processedImage.src = processedImageUrl;
                    
                    // ÏÑúÎ≤Ñ ÌååÏùº URLÏóêÏÑú blobÏùÑ Îã§Ïãú Î∞õÏïÑÏÑú nobgBlob ÏÑ∏ÌåÖ
                    try {
                        const blobResp = await fetch(processedImageUrl, { cache: 'reload' });
                        let contentType = blobResp.headers.get('content-type');
                        if (!contentType || !contentType.startsWith('image/')) {
                            // Ïû¨ÏãúÎèÑ
                            const retryResp = await fetch(processedImageUrl, { cache: 'no-store' });
                            contentType = retryResp.headers.get('content-type');
                            if (contentType && contentType.startsWith('image/')) {
                                nobgBlob = await retryResp.blob();
                            } else {
                                console.warn('‚ö†Ô∏è Î∞∞Í≤Ω Ï†úÍ±∞ Í≤∞Í≥ºÍ∞Ä Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏïÑÎãò ‚Äî ÏõêÎ≥∏ ÏÇ¨Ïö©');
                                return { ok: false, reason: 'invalid image response', fallback: true };
                            }
                        } else {
                            nobgBlob = await blobResp.blob();
                        }
                        if (processedImage) processedImage.style.display = 'block';
                        return { ok: true, data: response };
                    } catch (blobError) {
                        console.warn('‚ö†Ô∏è blob Ï≤òÎ¶¨ Ïã§Ìå®:', blobError.message);
                        return { ok: false, reason: blobError.message, fallback: true };
                    }
                } else {
                    console.warn('‚ö†Ô∏è remove-bg ÏùëÎãµÏù¥ ÏÑ±Í≥µÏù¥ ÏïÑÎãò:', response);
                    return { ok: false, reason: 'api response not ok', fallback: true };
                }
            } catch (error) {
                console.error('‚ùå removeBackgroundInternal Ïò§Î•ò:', error);
                
                // ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò ÌäπÎ≥Ñ Ï≤òÎ¶¨ (Failed to fetch, QUIC Protocol Error Îì±)
                if (error.name === 'TypeError' && (error.message.includes('Failed to fetch') || error.message.includes('QUIC_PROTOCOL_ERROR'))) {
                    console.error('üåê ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ Ïò§Î•ò - ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§');
                    return { ok: false, reason: 'network error', fallback: true };
                }
                
                return { ok: false, reason: error.message, fallback: true };
            }
        }

        async function analyzeEmotionInternal() {
            try {
                const formData = new FormData();
                formData.append('image', currentFile);
                
                // üîß ÎèôÏ†Å API URL ÏÇ¨Ïö© (Railway/Render Ìò∏Ìôò)
                const emotionApiUrl = window.apiBase ? `${window.apiBase()}/analyze-emotion` : '/analyze-emotion';
                
                console.log('üåê Í∞êÏ†ï Î∂ÑÏÑù API Ìò∏Ï∂ú URL:', emotionApiUrl);
                
                const response = await fetch(emotionApiUrl, {
                    method: 'POST',
                    body: formData
                });

                console.log('üîé Í∞êÏ†ï Î∂ÑÏÑù ÏùëÎãµ ÏÉÅÌÉú ÏΩîÎìú:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.warn('‚ö†Ô∏è Í∞êÏ†ï Î∂ÑÏÑù ÏùëÎãµ Ïò§Î•ò:', errorText);
                    // ÍµêÏ∞© Î∞©ÏßÄ: ÏóêÎü¨Î•º ÎçòÏßÄÏßÄ ÏïäÍ≥† null Î∞òÌôò
                    return null;
                }

                // üîß Í∞êÏ†ï Î∂ÑÏÑù JSON ÌååÏã± Í∞ïÌôî
                let result;
                try {
                    result = await response.json();
                    console.log('‚úÖ Í∞êÏ†ï Î∂ÑÏÑù ÏùëÎãµ ÌååÏã± ÏÑ±Í≥µ:', result);
                } catch (err) {
                    console.warn('‚ö†Ô∏è Í∞êÏ†ï Î∂ÑÏÑù JSON ÌååÏã± Ïã§Ìå®:', err);
                    // ÍµêÏ∞© Î∞©ÏßÄ: ÌååÏã± Ïã§Ìå®Ìï¥ÎèÑ null Î∞òÌôò
                    return null;
                }

                if (result && result.emotion) {
                    // üéØ ÌòÑÏû¨ Í∞êÏ†ï Ï†ïÎ≥¥ Ï†ÄÏû•
                    currentEmotion = result.emotion;
                    console.log('üòä ÌòÑÏû¨ Í∞êÏ†ï ÏóÖÎç∞Ïù¥Ìä∏:', currentEmotion);
                    
                    // Í∞êÏ†ï ÌîºÎìúÎ∞± ÌëúÏãú (ÏÑ†ÌÉùÏ†Å)
                    if (result.feedback) {
                        showEmotionFeedback(result.emotion, result.feedback);
                    }
                    return result;
                } else {
                    console.warn('‚ö†Ô∏è Í∞êÏ†ï Î∂ÑÏÑù Í≤∞Í≥ºÍ∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏùå:', result);
                    return null;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Í∞êÏ†ï Î∂ÑÏÑù Ïã§Ìå®:', error.message);
                // ÍµêÏ∞© Î∞©ÏßÄ: ÏóêÎü¨Î•º ÎçòÏßÄÏßÄ ÏïäÍ≥† null Î∞òÌôò
                return null;
            }
        }

        // Í∞êÏ†ïÎ≥Ñ Î™ÖÌôî Îç∞Ïù¥ÌÑ∞ (Î∞±ÏóîÎìúÏôÄ ÎèôÏùºÌïòÍ≤å Ïã§Ï†ú Ïù¥ÎØ∏ÏßÄ/ÌÉÄÏù¥ÌãÄ/ÏûëÍ∞Ä/Ïä§ÌÉÄÏùº Ï†ïÎ≥¥Î°ú Ï±ÑÏõÄ)
        const ARTWORKS_BY_EMOTION = {
            happy: [
                {
                    id: 'breezing_up',
                    title: 'Î∞îÎûåÏùÑ ÌÉÄÍ≥†',
                    artist: 'Winslow Homer',
                    image: '/BG_image/breezing_up_a_fair_wind_1943.13.1.jpg',

                },
                {
                    id: 'dance_hall',
                    title: 'ÎåÑÏä§ ÌôÄ',
                    artist: 'Pierre-Auguste Renoir',
                    image: '/BG_image/dance_hall_bellevue_obverse_1989.60.1.a.jpg'
                },
                {
                    id: 'harvest',
                    title: 'ÏàòÌôï',
                    artist: 'Vincent van Gogh',
                    image: '/BG_image/the_harvest_1985.64.91.jpg'
                },
                {
                    id: 'orchard',
                    title: 'ÍΩÉ ÌïÄ Í≥ºÏàòÏõê',
                    artist: 'Alfred Sisley',
                    image: '/BG_image/orchard_in_bloom_louveciennes_1970.17.51.jpg'
                }
            ],
            sad: [
                {
                    id: 'crucifixion',
                    title: 'ÏûëÏùÄ Ïã≠ÏûêÍ∞Ä',
                    artist: 'Grunewald',
                    image: '/BG_image/the_small_crucifixion_1961.9.19.jpg',

                },
                {
                    id: 'evening_deluge',
                    title: 'ÎåÄÌôçÏàòÏùò Ï†ÄÎÖÅ',
                    artist: 'John Martin',
                    image: '/BG_image/the_evening_of_the_deluge_1960.6.40.jpg'
                },
                {
                    id: 'ships_distress',
                    title: 'ÏúÑÌóòÏóê Ï≤òÌïú Î∞∞Îì§',
                    artist: 'Claude-Joseph Vernet',
                    image: '/BG_image/ships_in_distress_off_a_rocky_coast_1985.29.1.jpg'
                },
                {
                    id: 'sebastian',
                    title: 'ÏÑ± ÏÑ∏Î∞îÏä§Ìã∞Ïïà',
                    artist: 'Georges de La Tour',
                    image: '/BG_image/saint_sebastian_succored_by_the_holy_women_1960.6.4.jpg'
                }
            ],
            angry: [
                {
                    id: 'devil_words',
                    title: 'ÏïÖÎßàÏùò Îßê',
                    artist: 'Paul Gauguin',
                    image: '/BG_image/parau_na_te_varua_ino_words_of_the_devil_1972.9.12.jpg'
                },
                {
                    id: 'battle_love',
                    title: 'ÏÇ¨ÎûëÏùò Ï†ÑÌà¨',
                    artist: 'Nicolas Poussin',
                    image: '/BG_image/the_battle_of_love_1972.9.2.jpg'
                },
                {
                    id: 'tiger_snake',
                    title: 'Ìò∏ÎûëÏù¥ÏôÄ Î±Ä',
                    artist: 'Henri Rousseau',
                    image: '/BG_image/tiger_and_snake_2014.136.30.jpg'
                },
                {
                    id: 'scenes_legend',
                    title: 'Ï†ÑÏÑ§Ïùò Ïû•Î©¥',
                    artist: 'Unknown',
                    image: '/BG_image/scenes_from_a_legend_1939.1.344.b.jpg'
                }
            ],
            surprised: [
                {
                    id: 'bathers',
                    title: 'Î™©ÏöïÌïòÎäî ÏÇ¨ÎûåÎì§',
                    artist: 'Paul C√©zanne',
                    image: '/BG_image/the_bathers_1951.5.1.jpg'
                },
                {
                    id: 'festival_harbor',
                    title: 'Ìï≠Íµ¨Ïùò Ï∂ïÏ†ú',
                    artist: 'Eug√®ne Boudin',
                    image: '/BG_image/festival_in_the_harbor_of_honfleur_1983.1.10.jpg'
                },
                {
                    id: 'colza_harvest',
                    title: 'Ïú†Ï±Ñ ÏàòÌôï',
                    artist: 'Vincent van Gogh',
                    image: '/BG_image/the_colza_harvesting_rapeseed_2014.136.21.jpg'
                },
                {
                    id: 'dance_class',
                    title: 'ÎåÑÏä§ ÌÅ¥ÎûòÏä§',
                    artist: 'Edgar Degas',
                    image: '/BG_image/the_dance_class_2014.79.710.jpg'
                }
            ],
            neutral: [
                {
                    id: 'hampton',
                    title: 'Ï¥àÎ°ùÏ†ïÏõê',
                    artist: 'hampton',
                    image: '/BG_image/hampton_court_green_1970.17.53.jpg'
                },
                {
                    id: 'normandy',
                    title: 'ÎÖ∏Î•¥ÎßùÎîî Ìï¥Î≥Ä',
                    artist: 'bessin',
                    image: '/BG_image/seascape_at_port-en-bessin_normandy_1972.9.21.jpg'
                },
                {
                    id: 'farmhouse_provence',
                    title: 'ÌîÑÎ°úÎ∞©Ïä§Ïùò ÎÜçÍ∞Ä',
                    artist: 'Vincent van Gogh',
                    image: '/BG_image/farmhouse_in_provence_1970.17.34.jpg'
                },
                {
                    id: 'harbor_lorient',
                    title: 'Î°úÎ¶¨Ïïô Ìï≠Íµ¨',
                    artist: 'Berthe Morisot',
                    image: '/BG_image/the_harbor_at_lorient_1970.17.48.jpg'
                }
            ]
        };

        // Í∞êÏ†ï Î∂ÑÏÑù Í≤∞Í≥ºÏùò emotion Í∞íÏùÑ ÌÉ≠ ÌÇ§Î°ú Î≥ÄÌôò
        function mapEmotionKey(emotion) {
            if (emotion === 'happiness' || emotion === 'happy') return 'happy';
            if (emotion === 'sadness' || emotion === 'sad') return 'sad';
            if (emotion === 'anger' || emotion === 'angry') return 'angry';
            if (emotion === 'surprise' || emotion === 'surprised') return 'surprised';
            if (emotion === 'neutral') return 'neutral';
            // fallback
            return 'neutral';
        }

        // recommendArtworks Ìï®ÏàòÏóêÏÑú Í∞êÏ†ï Î∂ÑÏÑù Í≤∞Í≥ºÎ°ú ÏûêÎèô ÏÑ†ÌÉù
        async function recommendArtworks(emotion) {
            console.log('üé® Î™ÖÌôî Ï∂îÏ≤ú ÏöîÏ≤≠ - ÏûÖÎ†• Í∞êÏ†ï:', emotion);
            const key = mapEmotionKey(emotion);
            console.log('üé® Îß§ÌïëÎêú Í∞êÏ†ï ÌÇ§:', key);
            console.log('üé® Ìï¥Îãπ Í∞êÏ†ïÏùò Î™ÖÌôî Î™©Î°ù:', ARTWORKS_BY_EMOTION[key]);
            displayArtworkRecommendations(ARTWORKS_BY_EMOTION[key], key);
        }

        function displayArtworkRecommendations(artworks, emotion) {
            const emotionText = {
                'happy': 'Í∏∞ÏÅ®',
                'happiness': 'Í∏∞ÏÅ®',
                'sad': 'Ïä¨Ìîî',
                'sadness': 'Ïä¨Ìîî',
                'angry': 'Î∂ÑÎÖ∏',
                'anger': 'Î∂ÑÎÖ∏',
                'surprised': 'ÎÜÄÎûå',
                'surprise': 'ÎÜÄÎûå',
                'fear': 'ÎëêÎ†§ÏõÄ',
                'disgust': 'ÌòêÏò§',
                'neutral': 'Ï§ëÎ¶Ω'
            };

            const container = document.getElementById('artworkRecommendationsContainer');
            
            // ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ ÏÉàÎ°úÏö¥ ÌòïÏãù ÏßÄÏõê
            if (artworks && artworks.length > 0 && artworks[0].thumbnail) {
                console.log('üé® Ïç∏ÎÑ§Ïùº Í∏∞Î∞ò Î™ÖÌôî Ï∂îÏ≤ú ÌëúÏãú:', artworks);
                container.innerHTML = `
                    <div class="artwork-recommendations">
                        <h3>üé® ${emotionText[emotion] || emotion}Ïóê Ïñ¥Ïö∏Î¶¨Îäî Î™ÖÌôî Ï∂îÏ≤ú</h3>
                        <div class="artwork-grid">
                            ${artworks.map((artwork, index) => `
                                <div class="artwork-item" onclick="selectArtworkByPath('${artwork.path}')">
                                    <img src="${artwork.thumbnail}" 
                                         alt="${artwork.title}" 
                                         class="artwork-thumbnail loading"
                                         loading="lazy"
                                         data-original="${artwork.path}"
                                         data-thumbnail="${artwork.thumbnail}"
                                         onerror="handleThumbnailError(this, '${artwork.path}')"
                                         onload="handleThumbnailLoad(this)"
                                         ondblclick="loadOriginalImage(this, '${artwork.path}')">
                                    <div class="artwork-info">
                                        <h4>${artwork.title}</h4>
                                        <p>${artwork.artist}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <p style="text-align: center; color: var(--text-tertiary); font-size: 0.75rem; margin-top: var(--space-sm);">
                            üí° Î™ÖÌôîÎ•º ÎçîÎ∏îÌÅ¥Î¶≠ÌïòÎ©¥ Í≥†Ìï¥ÏÉÅÎèÑ Ïù¥ÎØ∏ÏßÄÎ•º Î≥º Ïàò ÏûàÏäµÎãàÎã§
                        </p>
                    </div>
                `;
            } else if (artworks && artworks.length > 0) {
                // Í∏∞Ï°¥ ÌòïÏãù ÏßÄÏõê (ÌïòÏúÑ Ìò∏ÌôòÏÑ±)
                console.log('üé® Í∏∞Ï°¥ ÌòïÏãù Î™ÖÌôî Ï∂îÏ≤ú ÌëúÏãú:', artworks);
                container.innerHTML = `
                    <div class="artwork-recommendations">
                        <h3>üé® ${emotionText[emotion] || emotion}Ïóê Ïñ¥Ïö∏Î¶¨Îäî Î™ÖÌôî Ï∂îÏ≤ú</h3>
                        <div class="artwork-grid">
                            ${artworks.map(artwork => `
                                <div class="artwork-item" onclick="selectArtwork('${artwork.id}', '${artwork.image}')">
                                    <img src="${artwork.image}" alt="${artwork.title}" class="artwork-thumbnail" loading="lazy">
                                    <div class="artwork-info">
                                        <h4>${artwork.title}</h4>
                                        <p>${artwork.artist}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                console.log('üé® Î™ÖÌôî Ï∂îÏ≤ú Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå');
                container.innerHTML = `
                    <div class="artwork-recommendations">
                        <h3>üé® ${emotionText[emotion] || emotion}Ïóê Ïñ¥Ïö∏Î¶¨Îäî Î™ÖÌôî</h3>
                        <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            Ï∂îÏ≤úÌï† Î™ÖÌôîÎ•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...
                        </p>
                    </div>
                `;
            }
        }

        // 1Îã®Í≥Ñ: Î∞∞Í≤Ω Ï†úÍ±∞ + Í∏∞Î≥∏ Ìï©ÏÑ±
        async function applyComposite(artworkId, backgroundImage) {
            console.log('üé® Ìï©ÏÑ± ÏãúÏûë:', { artworkId, backgroundImage });
            
            // üîß Í∞ïÎ†•Ìïú ÍµêÏ∞© Î∞©ÏßÄ: nobgBlobÏù¥ ÏóÜÏñ¥ÎèÑ ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÎ°ú ÏßÑÌñâ
            if (!nobgBlob) {
                console.log('‚ö†Ô∏è nobgBlobÏù¥ ÏóÜÏùå ‚Äî ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÎ°ú Ìï©ÏÑ± ÏßÑÌñâ');
                if (!currentFile) {
                    showMessage('Ïù¥ÎØ∏ÏßÄÎ•º Î®ºÏ†Ä ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                    return;
                }
                // ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÎ•º nobgBlobÏúºÎ°ú ÏÇ¨Ïö©
                nobgBlob = currentFile;
                console.log('‚úÖ ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÎ•º nobgBlobÏúºÎ°ú ÏÑ§Ï†ï:', currentFile.name, currentFile.size);
                showMessage('Î∞∞Í≤Ω Ï†úÍ±∞ ÏóÜÏù¥ ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÎ°ú Ìï©ÏÑ±ÏùÑ ÏßÑÌñâÌï©ÎãàÎã§.', 'info');
            }
            
            // üîß Ï∂îÍ∞Ä Í≤ÄÏ¶ù: nobgBlobÏù¥ Ïú†Ìö®ÌïúÏßÄ ÌôïÏù∏
            if (!nobgBlob || nobgBlob.size === 0) {
                console.log('‚ö†Ô∏è nobgBlobÏù¥ Ïú†Ìö®ÌïòÏßÄ ÏïäÏùå ‚Äî ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÎ°ú Ïû¨ÏÑ§Ï†ï');
                if (currentFile) {
                    nobgBlob = currentFile;
                    console.log('‚úÖ ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÎ°ú nobgBlob Ïû¨ÏÑ§Ï†ï');
                } else {
                    showMessage('Ïù¥ÎØ∏ÏßÄÎ•º Î®ºÏ†Ä ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                    return;
                }
            }
            
            // üîß ÏµúÏ¢Ö Í≤ÄÏ¶ù: Î™®Îì† ÌïÑÏàò Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
            if (!nobgBlob || !backgroundImage) {
                console.error('‚ùå ÌïÑÏàò Îç∞Ïù¥ÌÑ∞ ÎàÑÎùΩ:', { 
                    hasNobgBlob: !!nobgBlob, 
                    hasBackgroundImage: !!backgroundImage 
                });
                showMessage('Ìï©ÏÑ±Ïóê ÌïÑÏöîÌïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§.', 'error');
                return;
            }

            showLoading(true);
            hideMessage();

            previewImage.src = '';
            previewImage.style.background = 'url(/spinner.gif) center center no-repeat';
            previewImage.style.minHeight = '120px';

            try {
                const formData = new FormData();
                formData.append('image', nobgBlob, 'foreground_nobg.png');
                formData.append('backgroundPath', backgroundImage);
                formData.append('emotion', currentEmotion || 'neutral');

                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                // üîß Ïò¨Î∞îÎ•∏ Ìï©ÏÑ± API Ìò∏Ï∂ú
                const response = await fetch('/api/composite', {
                    method: 'POST',
                    headers,
                    body: formData
                });

                const result = await response.json();
                console.log('üé® Ìï©ÏÑ± API ÏùëÎãµ:', result);
                
                if (response.ok && result.ok) {
                    // üéØ nobgPath Ï†ÑÏó≠ Ï†ÄÏû•
                    lastNobgPath = result.nobgPath;
                    console.log('üîÑ nobgPath Ï†ÄÏû•:', lastNobgPath);
                    
                    // 1Îã®Í≥Ñ Í≤∞Í≥º ÌëúÏãú (ÎØ∏Î¶¨Î≥¥Í∏∞)
                    // üéØ Base64 Ïù¥ÎØ∏ÏßÄ Ïö∞ÏÑ† ÏÇ¨Ïö© (Ï∫êÏãú Î¨∏Ï†ú ÏôÑÏ†Ñ Ïö∞Ìöå)
                    if (result.imageBase64) {
                        console.log('üöÄ Base64 Ïù¥ÎØ∏ÏßÄ ÏßÅÏ†ë Î°úÎî©:', result.imageBase64.substring(0, 50) + '...');
                        previewImage.src = result.imageBase64;
                        previewImage.style.display = 'block';
                    } else {
                        // Ìè¥Î∞±: Í∏∞Ï°¥ URL Î∞©Ïãù
                        const timestamp = Date.now();
                        const random = Math.random().toString(36).substr(2, 9);
                        const cacheBuster = `?nocache=${timestamp}&r=${random}&reload=1&force=${Math.floor(Math.random() * 1000000)}`;
                        const imageUrl = result.processedImageUrl + cacheBuster;
                        console.log('‚ö†Ô∏è Base64 ÏóÜÏùå, URL Î∞©Ïãù ÏÇ¨Ïö©:', imageUrl);
                        
                        previewImage.src = '';
                        previewImage.style.display = 'none';
                        
                        setTimeout(() => {
                            previewImage.src = imageUrl;
                            previewImage.style.display = 'block';
                        }, 100);
                    }
                    previewImage.onload = () => {
                        const logMsg = result.imageBase64 ? 'Base64 Ïù¥ÎØ∏ÏßÄ' : result.processedImageUrl;
                        console.log('‚úÖ ÎØ∏Î¶¨Î≥¥Í∏∞ Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏÑ±Í≥µ:', logMsg);
                        resultSection.style.display = 'block';
                        // Î∏åÎü¨Ïâ¨ Í≤∞Í≥ºÍ∞Ä ÏûàÏúºÎ©¥ Ïú†ÏßÄ, ÏóÜÏúºÎ©¥ Ïà®Í∏∞Í∏∞
                        if (!brushResultImage.src || brushResultImage.src === '') {
                            brushResultSection.style.display = 'none';
                        }
                    };
                    
                    // üéØ ÏóêÎü¨ Ìï∏Îì§Îü¨ Ï†úÍ±∞ - Ïù¥ÎØ∏ÏßÄÍ∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Î≥¥Ïù¥Í≥† ÏûàÏúºÎØÄÎ°ú Î∂àÌïÑÏöîÌïú ÏóêÎü¨ Î©îÏãúÏßÄ Î∞©ÏßÄ
                    previewImage.onerror = () => {
                        console.log('‚ö†Ô∏è Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïù¥Î≤§Ìä∏ ÏóêÎü¨ (Î¨¥Ïãú)');
                    };
                    
                    // üéØ Í∞êÏ†ï Î∂ÑÏÑù Í≤∞Í≥º ÌëúÏãú (Î≥µÏõê)
                    if (result.emotion && result.feedback) {
                        // üéØ ÌòÑÏû¨ Í∞êÏ†ï Ï†ïÎ≥¥ Ï†ÄÏû•
                        currentEmotion = result.emotion;
                        console.log('üòä ÌòÑÏû¨ Í∞êÏ†ï ÏóÖÎç∞Ïù¥Ìä∏ (Î∞∞Í≤Ω Ìï©ÏÑ±):', currentEmotion);
                        showEmotionFeedback(result.emotion, result.feedback);
                    }
                    
                    // üé® ÏÉàÎ°úÏö¥ Ïç∏ÎÑ§Ïùº Í∏∞Î∞ò Î™ÖÌôî Ï∂îÏ≤ú ÌëúÏãú
                    if (result.artworkRecommendations && result.artworkRecommendations.length > 0) {
                        console.log('üé® ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ Ïç∏ÎÑ§Ïùº Í∏∞Î∞ò Î™ÖÌôî Ï∂îÏ≤ú:', result.artworkRecommendations);
                        displayArtworkRecommendations(result.artworkRecommendations, result.emotion);
                        
                        // Ïç∏ÎÑ§Ïùº ÌîÑÎ¶¨Î°úÎî© ÏãúÏûë
                        setTimeout(() => preloadThumbnails(result.artworkRecommendations), 100);
                    } else if (result.emotion) {
                        // Í∏∞Ï°¥ Î∞©Ïãù Ìè¥Î∞±
                        console.log('üé® Í∏∞Ï°¥ Î∞©ÏãùÏúºÎ°ú Î™ÖÌôî Ï∂îÏ≤ú ÌëúÏãú');
                        const emotionKey = {
                            'happiness': 'happy',
                            'sadness': 'sad',
                            'anger': 'angry',
                            'surprise': 'surprised',
                            'fear': 'neutral',
                            'disgust': 'neutral',
                            'neutral': 'neutral'
                        }[result.emotion] || 'neutral';
                        
                        if (ARTWORKS_BY_EMOTION[emotionKey]) {
                            displayArtworkRecommendations(ARTWORKS_BY_EMOTION[emotionKey], emotionKey);
                        }
                    }
                    
                    // Î∏åÎü¨Ïâ¨ Ìö®Í≥º Î≤ÑÌäº ÌëúÏãú
                    showBrushEffectButton(result.nobgPath, backgroundImage, result.emotion);
                    
                    // 1Îã®Í≥Ñ ÏôÑÎ£å Î©îÏãúÏßÄ
                    showMessage('Î∞∞Í≤Ω Ìï©ÏÑ±Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§! Ïù∏Î¨ºÎ∏åÎü¨Ïâ¨Ìö®Í≥ºÎ•º Ï†ÅÏö©Ìï¥Î≥¥ÏÑ∏Ïöî.', 'success');
                } else {
                    throw new Error(result.error || 'Î∞∞Í≤Ω Ìï©ÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                showMessage('Î∞∞Í≤Ω Ìï©ÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message, 'error');
                previewImage.style.background = '';
                previewImage.style.minHeight = '';
            } finally {
                showLoading(false);
            }
        }

        // 2Îã®Í≥Ñ: Î∏åÎü¨Ïâ¨ Ìö®Í≥º Ï†ÅÏö©
        async function applyBrushEffect(nobgPath, backgroundPath, emotion) {
            // üéØ Îß§Í∞úÎ≥ÄÏàò Í≤ÄÏ¶ù
            if (!nobgPath || !backgroundPath) {
                showMessage(`Î∏åÎü¨Ïãú Ìö®Í≥º Ï†ÅÏö©Ïóê ÌïÑÏöîÌïú Ï†ïÎ≥¥Í∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§. nobgPath: ${nobgPath}, backgroundPath: ${backgroundPath}`, 'error');
                return;
            }
            
            console.log('üé® Î∏åÎü¨Ïãú Ìö®Í≥º Ï†ÅÏö© ÏãúÏûë:', { nobgPath, backgroundPath, emotion });
            
            // üéØ Ï§ëÎ≥µ Ïã§Ìñâ Î∞©ÏßÄ
            if (isBrushProcessing) {
                console.log('‚è∏Ô∏è Î∏åÎü¨Ïãú Ìö®Í≥º Ï≤òÎ¶¨ Ï§ë - ÎåÄÍ∏∞ Ï§ëÏù∏ ÏöîÏ≤≠ÏúºÎ°ú Îì±Î°ù');
                pendingBrushUpdate = { nobgPath, backgroundPath, emotion };
                return;
            }
            
            isBrushProcessing = true;
            showLoading(true);
            hideMessage();

            try {
                const requestData = {
                    nobgPath: nobgPath,
                    backgroundPath: backgroundPath,
                    emotion: emotion || 'neutral'
                };
                
                console.log('üé® Î∏åÎü¨Ïãú Ìö®Í≥º API ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞:', requestData);
                
                // üîß Render Î∞∞Ìè¨ ÌôòÍ≤ΩÏóê ÎßûÍ≤å Ï†àÎåÄ URL ÏÇ¨Ïö©
                const brushApiUrl = window.location.hostname === 'localhost' 
                    ? '/api/apply-brush-effect' 
                    : `${window.apiBase ? window.apiBase() : window.location.origin}/api/apply-brush-effect`;
                
                console.log('üåê Î∏åÎü¨Ïãú Ìö®Í≥º API Ìò∏Ï∂ú URL:', brushApiUrl);
                
                console.log('üì§ Î∏åÎü¨Ïãú Ìö®Í≥º ÏöîÏ≤≠ Ìó§Îçî:', {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                });
                
                const response = await fetch(brushApiUrl, {
                        method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                    },
                    body: JSON.stringify(requestData)
                });

                // üîß Î∏åÎü¨Ïãú Ìö®Í≥º ÏùëÎãµ ÏÉÅÌÉú Î°úÍπÖ
                console.log('üîé Î∏åÎü¨Ïãú Ìö®Í≥º ÏùëÎãµ ÏÉÅÌÉú ÏΩîÎìú:', response.status);
                console.log('üîé Î∏åÎü¨Ïãú Ìö®Í≥º ÏùëÎãµ ÏÉÅÌÉú ÌÖçÏä§Ìä∏:', response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Î∏åÎü¨Ïãú Ìö®Í≥º ÏùëÎãµ Ïò§Î•ò:', errorText);
                    console.error('‚ùå Î∏åÎü¨Ïãú Ìö®Í≥º ÏùëÎãµ ÏÉÅÌÉú:', response.status, response.statusText);
                    throw new Error(`Î∏åÎü¨Ïãú Ìö®Í≥º API ÏöîÏ≤≠ Ïã§Ìå® (${response.status}): ${errorText.substring(0, 100)}`);
                }
                
                // üîß Î∏åÎü¨Ïãú Ìö®Í≥º JSON ÌååÏã± Í∞ïÌôî
                let result;
                try {
                    result = await response.json();
                    console.log('‚úÖ Î∏åÎü¨Ïãú Ìö®Í≥º ÏùëÎãµ ÌååÏã± ÏÑ±Í≥µ:', result);
                } catch (err) {
                    console.error('‚ùå Î∏åÎü¨Ïãú Ìö®Í≥º JSON ÌååÏã± Ïã§Ìå®:', err);
                    throw new Error('Î∏åÎü¨Ïãú Ìö®Í≥º API ÏùëÎãµÏù¥ Ïò¨Î∞îÎ•∏ JSON ÌòïÏãùÏù¥ ÏïÑÎãôÎãàÎã§.');
                }
                console.log('‚úÖ Î∏åÎü¨Ïãú Ìö®Í≥º API ÏùëÎãµ:', result);
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // 2Îã®Í≥Ñ Í≤∞Í≥º ÌëúÏãú (Î∏åÎü¨Ïâ¨ Ìö®Í≥º Ï†ÅÏö©Îê®)
                                            // Î∏åÎü¨Ïãú Í≤∞Í≥ºÏóêÎèÑ Í∞ïÎ†•Ìïú Ï∫êÏãú Î¨¥Ìö®Ìôî Ï†ÅÏö©
                        const brushTimestamp = Date.now();
                        const brushRandom = Math.random().toString(36).substr(2, 9);
                        const brushCacheBuster = `?nocache=${brushTimestamp}&r=${brushRandom}&reload=1&force=${Math.floor(Math.random() * 1000000)}`;
                        const brushImageUrl = result.processedImageUrl + brushCacheBuster;
                        
                        console.log('Î∏åÎü¨Ïãú Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏãúÎèÑ (Í∞ïÎ†•Ìïú Ï∫êÏãú Î¨¥Ìö®Ìôî):', brushImageUrl);
                        
                        // Î∏åÎü¨Ïãú Ïù¥ÎØ∏ÏßÄÎèÑ Î¶¨ÏÖã ÌõÑ Î°úÎìú
                        brushResultImage.src = '';
                        brushResultImage.style.display = 'none';
                        
                        setTimeout(() => {
                            brushResultImage.src = brushImageUrl;
                            brushResultImage.style.display = 'block';
                        }, 100);
                        brushResultImage.onload = () => {
                            console.log('Î∏åÎü¨Ïâ¨ Ìö®Í≥º Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏÑ±Í≥µ:', brushImageUrl);
                            brushResultSection.style.display = 'block'; // Î∏åÎü¨Ïâ¨ Í≤∞Í≥º ÏÑπÏÖò ÌëúÏãú
                        };
                        // üéØ ÏóêÎü¨ Ìï∏Îì§Îü¨ Îã®ÏàúÌôî - Î∂àÌïÑÏöîÌïú ÏóêÎü¨ Î©îÏãúÏßÄ Î∞©ÏßÄ
                        brushResultImage.onerror = () => {
                            console.log('‚ö†Ô∏è Î∏åÎü¨Ïãú Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïù¥Î≤§Ìä∏ ÏóêÎü¨ (Î¨¥Ïãú)');
                        };
                        downloadLink.href = result.processedImageUrl; // Îã§Ïö¥Î°úÎìúÎäî ÏõêÎ≥∏ URL ÏÇ¨Ïö© (Ï∫êÏãú Î≤ÑÏä§ÌÑ∞ Î∂àÌïÑÏöî)
                    
                    // Î∏åÎü¨Ïâ¨ Ìö®Í≥º Î≤ÑÌäº Ïà®Í∏∞Í∏∞
                    hideBrushEffectButton();
                    
                    // 2Îã®Í≥Ñ ÏôÑÎ£å Î©îÏãúÏßÄ
                    showMessage('Ïù∏Î¨ºÎ∏åÎü¨Ïâ¨Ìö®Í≥ºÍ∞Ä Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§!', 'success');
            } catch (error) {
                showMessage('Î∏åÎü¨Ïâ¨ Ìö®Í≥º Ï†ÅÏö© Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            } finally {
                isBrushProcessing = false;
                showLoading(false);
                
                // üéØ ÎåÄÍ∏∞ Ï§ëÏù∏ Î∏åÎü¨Ïãú ÏöîÏ≤≠Ïù¥ ÏûàÏúºÎ©¥ Ï≤òÎ¶¨
                if (pendingBrushUpdate) {
                    console.log('üöÄ ÎåÄÍ∏∞ Ï§ëÏù∏ Î∏åÎü¨Ïãú Ìö®Í≥º ÏöîÏ≤≠ Ï≤òÎ¶¨:', pendingBrushUpdate);
                    const pending = pendingBrushUpdate;
                    pendingBrushUpdate = null;
                    
                    // ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ Ï≤òÎ¶¨ (UI ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å ÎåÄÍ∏∞)
                    setTimeout(() => {
                        applyBrushEffect(pending.nobgPath, pending.backgroundPath, pending.emotion);
                    }, 100);
                }
            }
        }

        // Î∏åÎü¨Ïâ¨ Ìö®Í≥º Î≤ÑÌäº ÌëúÏãú
        function showBrushEffectButton(nobgPath, backgroundPath, emotion) {
            const brushButton = document.getElementById('brushEffectBtn');
            if (brushButton) {
                brushButton.style.display = 'block';
                brushButton.onclick = () => applyBrushEffect(nobgPath, backgroundPath, emotion);
            }
        }

        // Î∏åÎü¨Ïâ¨ Ìö®Í≥º Î≤ÑÌäº Ïà®Í∏∞Í∏∞
        function hideBrushEffectButton() {
            const brushButton = document.getElementById('brushEffectBtn');
            if (brushButton) {
                brushButton.style.display = 'none';
            }
        }

        // Ïç∏ÎÑ§Ïùº Î°úÎî© ÏôÑÎ£å Ï≤òÎ¶¨
        function handleThumbnailLoad(img) {
            console.log('üñºÔ∏è Ïç∏ÎÑ§Ïùº Î°úÎìú ÏôÑÎ£å:', img.src);
            img.classList.remove('loading');
            img.classList.add('loaded');
        }
        
        // Ïç∏ÎÑ§Ïùº Î°úÎî© ÏóêÎü¨ Ï≤òÎ¶¨
        function handleThumbnailError(img, originalPath) {
            console.log('‚ùå Ïç∏ÎÑ§Ïùº Î°úÎìú Ïã§Ìå®, ÏõêÎ≥∏ÏúºÎ°ú Ìè¥Î∞±:', img.src, '‚Üí', originalPath);
            img.classList.remove('loading');
            img.classList.add('error');
            
            // ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÎ°ú Ìè¥Î∞± ÏãúÎèÑ
            setTimeout(() => {
                img.src = originalPath;
                img.onerror = () => {
                    console.log('‚ùå ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÎèÑ Î°úÎìú Ïã§Ìå®:', originalPath);
                    img.classList.add('error');
                };
                img.onload = () => {
                    console.log('‚úÖ ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ Ìè¥Î∞± ÏÑ±Í≥µ:', originalPath);
                    img.classList.remove('error');
                    img.classList.add('loaded');
                };
            }, 100);
        }
        
        // ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄ Î°úÎî© (ÎçîÎ∏îÌÅ¥Î¶≠)
        function loadOriginalImage(img, originalPath) {
            console.log('üîç Í≥†Ìï¥ÏÉÅÎèÑ Ïù¥ÎØ∏ÏßÄ Î°úÎî©:', originalPath);
            
            // Ïù¥ÎØ∏ ÏõêÎ≥∏Ïù¥Î©¥ Ïä§ÌÇµ
            if (img.src.includes(originalPath)) {
                console.log('‚è≠Ô∏è Ïù¥ÎØ∏ ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÏûÖÎãàÎã§');
                return;
            }
            
            // Î°úÎî© ÏÉÅÌÉú ÌëúÏãú
            img.classList.add('loading');
            
            // ÏûÑÏãú Ïù¥ÎØ∏ÏßÄ Í∞ùÏ≤¥Î°ú ÏõêÎ≥∏ Î°úÎî© ÌÖåÏä§Ìä∏
            const tempImg = new Image();
            tempImg.onload = () => {
                console.log('‚úÖ Í≥†Ìï¥ÏÉÅÎèÑ Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏôÑÎ£å:', originalPath);
                img.src = originalPath;
                img.classList.remove('loading');
                img.classList.add('loaded');
                
                // ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏïåÎ¶º
                showMessage('Í≥†Ìï¥ÏÉÅÎèÑ Ïù¥ÎØ∏ÏßÄÎ°ú ÏóÖÍ∑∏Î†àÏù¥ÎìúÎêòÏóàÏäµÎãàÎã§! üé®', 'success');
            };
            tempImg.onerror = () => {
                console.log('‚ùå Í≥†Ìï¥ÏÉÅÎèÑ Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®:', originalPath);
                img.classList.remove('loading');
                showMessage('Í≥†Ìï¥ÏÉÅÎèÑ Ïù¥ÎØ∏ÏßÄÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
            };
            tempImg.src = originalPath;
        }
        
        // Ïç∏ÎÑ§Ïùº Ï∫êÏãú ÌîÑÎ¶¨Î°úÎî© (ÏÑ±Îä• Ìñ•ÏÉÅ)
        function preloadThumbnails(artworks) {
            if (!artworks || !Array.isArray(artworks)) return;
            
            console.log('üöÄ Ïç∏ÎÑ§Ïùº ÌîÑÎ¶¨Î°úÎî© ÏãúÏûë:', artworks.length + 'Í∞ú');
            let loadedCount = 0;
            
            artworks.forEach((artwork, index) => {
                if (artwork.thumbnail) {
                    const img = new Image();
                    img.onload = () => {
                        loadedCount++;
                        console.log(`üì• Ïç∏ÎÑ§Ïùº ÌîÑÎ¶¨Î°úÎìú ${loadedCount}/${artworks.length}: ${artwork.thumbnail}`);
                        
                        if (loadedCount === artworks.length) {
                            console.log('‚úÖ Î™®Îì† Ïç∏ÎÑ§Ïùº ÌîÑÎ¶¨Î°úÎî© ÏôÑÎ£å');
                        }
                    };
                    img.onerror = () => {
                        console.log(`‚ùå Ïç∏ÎÑ§Ïùº ÌîÑÎ¶¨Î°úÎìú Ïã§Ìå®: ${artwork.thumbnail}`);
                        loadedCount++;
                    };
                    img.src = artwork.thumbnail;
                }
            });
        }

        // ÏÉàÎ°úÏö¥ Ïç∏ÎÑ§Ïùº Í∏∞Î∞ò Î™ÖÌôî ÏÑ†ÌÉù Ìï®Ïàò
        async function selectArtworkByPath(backgroundPath) {
            console.log('üé® Ïç∏ÎÑ§Ïùº Í∏∞Î∞ò Î™ÖÌôî ÏÑ†ÌÉù:', backgroundPath);
            
            // üéØ ÌòÑÏû¨ Î∞∞Í≤Ω Ï†ïÎ≥¥ Ï†ÄÏû•
            currentBackground = backgroundPath;
            console.log('üñºÔ∏è ÌòÑÏû¨ Î∞∞Í≤Ω ÏóÖÎç∞Ïù¥Ìä∏:', currentBackground);
            
            // üéØ Í∏∞Ï°¥ Î∏åÎü¨Ïãú Ìö®Í≥º Ï†ÅÏö© Ïó¨Î∂Ä ÌôïÏù∏
            const hasBrushEffect = brushResultSection.style.display === 'block' && 
                                 brushResultImage.src && 
                                 brushResultImage.src !== '' && 
                                 brushResultImage.src !== window.location.href;
            
            console.log('Î∞∞Í≤Ω Î≥ÄÍ≤Ω - Î∏åÎü¨Ïãú Ìö®Í≥º Ï†ÅÏö© Ïó¨Î∂Ä:', hasBrushEffect);
            
            // ÏÑ†ÌÉùÎêú Î™ÖÌôîÎ°ú Î∞∞Í≤Ω Ìï©ÏÑ± Ïã§Ìñâ (artworkIdÎäî null ÏÇ¨Ïö©)
            await applyComposite(null, backgroundPath);
            
            // üöÄ Í∏∞Ï°¥Ïóê Î∏åÎü¨Ïãú Ìö®Í≥ºÍ∞Ä Ï†ÅÏö©ÎêòÏñ¥ ÏûàÏóàÎã§Î©¥, ÏÉà Î∞∞Í≤ΩÏúºÎ°ú Ï¶âÏãú Ïû¨Ï†ÅÏö©
            if (hasBrushEffect && lastNobgPath) {
                console.log('üé® ÏÉàÎ°úÏö¥ Î∞∞Í≤ΩÏúºÎ°ú Î∏åÎü¨Ïãú Ìö®Í≥º Ï¶âÏãú Ïû¨Ï†ÅÏö© ÏãúÏûë');
                console.log('üîÑ ÏÇ¨Ïö©Ìï† nobgPath:', lastNobgPath);
                
                try {
                    await applyBrushEffect(lastNobgPath, backgroundPath, currentEmotion || 'neutral');
                    console.log('‚úÖ ÏÉà Î∞∞Í≤ΩÏúºÎ°ú Î∏åÎü¨Ïãú Ìö®Í≥º Ïû¨Ï†ÅÏö© ÏôÑÎ£å');
                } catch (error) {
                    console.error('‚ùå Î∏åÎü¨Ïãú Ìö®Í≥º Ïû¨Ï†ÅÏö© Ïã§Ìå®:', error);
                    showMessage('Î∏åÎü¨Ïãú Ìö®Í≥º Ïû¨Ï†ÅÏö© Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                }
            }
        }

        // Í∏∞Ï°¥ ID Í∏∞Î∞ò Î™ÖÌôî ÏÑ†ÌÉù Ìï®Ïàò (ÌïòÏúÑ Ìò∏ÌôòÏÑ±)
        async function selectArtwork(artworkId, backgroundImage) {
            // üéØ ÌòÑÏû¨ Î∞∞Í≤Ω Ï†ïÎ≥¥ Ï†ÄÏû•
            currentBackground = backgroundImage;
            console.log('üñºÔ∏è ÌòÑÏû¨ Î∞∞Í≤Ω ÏóÖÎç∞Ïù¥Ìä∏:', currentBackground);
            
            // üéØ Í∏∞Ï°¥ Î∏åÎü¨Ïãú Ìö®Í≥º Ï†ÅÏö© Ïó¨Î∂Ä ÌôïÏù∏
            const hasBrushEffect = brushResultSection.style.display === 'block' && 
                                 brushResultImage.src && 
                                 brushResultImage.src !== '' && 
                                 brushResultImage.src !== window.location.href;
            
            console.log('Î∞∞Í≤Ω Î≥ÄÍ≤Ω - Î∏åÎü¨Ïãú Ìö®Í≥º Ï†ÅÏö© Ïó¨Î∂Ä:', hasBrushEffect);
            
            // ÏÑ†ÌÉùÎêú Î™ÖÌôîÎ°ú Î∞∞Í≤Ω Ìï©ÏÑ± Ïã§Ìñâ
                await applyComposite(artworkId, backgroundImage);
            
            // üöÄ Í∏∞Ï°¥Ïóê Î∏åÎü¨Ïãú Ìö®Í≥ºÍ∞Ä Ï†ÅÏö©ÎêòÏñ¥ ÏûàÏóàÎã§Î©¥, ÏÉà Î∞∞Í≤ΩÏúºÎ°ú Ï¶âÏãú Ïû¨Ï†ÅÏö©
            if (hasBrushEffect && lastNobgPath) {
                console.log('üé® ÏÉàÎ°úÏö¥ Î∞∞Í≤ΩÏúºÎ°ú Î∏åÎü¨Ïãú Ìö®Í≥º Ï¶âÏãú Ïû¨Ï†ÅÏö© ÏãúÏûë');
                console.log('üîÑ ÏÇ¨Ïö©Ìï† nobgPath:', lastNobgPath);
                
                // üéØ Ï§ëÎ≥µ Î∞©ÏßÄ Î°úÏßÅÏóê ÏùòÌï¥ ÏûêÎèôÏúºÎ°ú ÎåÄÍ∏∞Ïó¥Ïóê Ï∂îÍ∞ÄÎê®
                try {
                    await applyBrushEffect(lastNobgPath, backgroundImage, currentEmotion || 'neutral');
                    console.log('‚úÖ ÏÉà Î∞∞Í≤ΩÏúºÎ°ú Î∏åÎü¨Ïãú Ìö®Í≥º Ïû¨Ï†ÅÏö© ÏôÑÎ£å');
                } catch (error) {
                    console.error('‚ùå Î∏åÎü¨Ïãú Ìö®Í≥º Ïû¨Ï†ÅÏö© Ïã§Ìå®:', error);
                    showMessage('Î∏åÎü¨Ïãú Ìö®Í≥º Ïû¨Ï†ÅÏö© Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                }
            }
        }

        async function removeBackground() {
            if (!currentFile) {
                showMessage('Î®ºÏ†Ä Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            showLoading(true);
            hideMessage();

            const formData = new FormData();
            formData.append('image', currentFile);

            try {
                const response = await fetch('/api/remove-bg', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    processedImageUrl = result.processedImageUrl;
                    if (processedImage) processedImage.src = processedImageUrl;
                    if (processedImage) processedImage.style.display = 'block';
                    showMessage('Î∞∞Í≤ΩÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§!', 'success');
                } else {
                    throw new Error(result.error || 'Î∞∞Í≤Ω Ï†úÍ±∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                showMessage(error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // üîÑ Î∞∞Í≤Ω Ï†úÍ±∞ Ïû¨ÏãúÎèÑ Ìï®Ïàò
        async function retryBackgroundRemoval() {
            console.log('üîÑ Î∞∞Í≤Ω Ï†úÍ±∞ Ïû¨ÏãúÎèÑ ÏãúÏûë');
            
            if (!currentFile) {
                showMessage('Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.', 'error');
                return;
            }

            showLoading(true);
            hideMessage();
            
            // Ïû¨ÏãúÎèÑ Î≤ÑÌäº Ïà®Í∏∞Í∏∞
            const retryBtn = document.getElementById('retryBgRemovalBtn');
            if (retryBtn) retryBtn.style.display = 'none';

            try {
                const result = await removeBackgroundInternal();
                
                if (result && result.ok) {
                    console.log('‚úÖ Î∞∞Í≤Ω Ï†úÍ±∞ Ïû¨ÏãúÎèÑ ÏÑ±Í≥µ');
                    showMessage('Î∞∞Í≤Ω Ï†úÍ±∞Ïóê ÏÑ±Í≥µÌñàÏäµÎãàÎã§!', 'success');
                    
                    // ÏÑ±Í≥µ Ïãú Ïû¨ÏãúÎèÑ Î≤ÑÌäº Ïà®Í∏∞Í∏∞
                    if (retryBtn) retryBtn.style.display = 'none';
                } else {
                    console.warn('‚ö†Ô∏è Î∞∞Í≤Ω Ï†úÍ±∞ Ïû¨ÏãúÎèÑ Ïã§Ìå®:', result?.reason || 'unknown error');
                    showMessage('Î∞∞Í≤Ω Ï†úÍ±∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÎ°ú Í≥ÑÏÜç ÏßÑÌñâÌï©ÎãàÎã§.', 'warning');
                    
                    // Ïã§Ìå® Ïãú Ïû¨ÏãúÎèÑ Î≤ÑÌäº ÌëúÏãú
                    if (retryBtn) retryBtn.style.display = 'inline-flex';
                }
            } catch (error) {
                console.error('‚ùå Î∞∞Í≤Ω Ï†úÍ±∞ Ïû¨ÏãúÎèÑ Ï§ë Ïò§Î•ò:', error);
                showMessage('Î∞∞Í≤Ω Ï†úÍ±∞ Ïû¨ÏãúÎèÑ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                
                // Ïò§Î•ò Ïãú Ïû¨ÏãúÎèÑ Î≤ÑÌäº ÌëúÏãú
                if (retryBtn) retryBtn.style.display = 'inline-flex';
            } finally {
                showLoading(false);
            }
        }

        async function analyzeEmotion() {
            if (!currentFile) {
                showMessage('Î®ºÏ†Ä Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            showLoading(true);
            hideMessage();

            const formData = new FormData();
            formData.append('image', currentFile);

            try {
                const response = await fetch('/analyze-emotion', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(`Í∞êÏ†ï Î∂ÑÏÑù Í≤∞Í≥º: ${result.emotion} (${result.confidence}%)`, 'success');
                } else {
                    throw new Error(result.error || 'Í∞êÏ†ï Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                showMessage(error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function resetImage() {
            currentFile = null;
            processedImageUrl = null;
            // üîß nobgBlob Ï¥àÍ∏∞Ìôî Ï†úÍ±∞ - ÍµêÏ∞© Î∞©ÏßÄ
            // nobgBlob = null;
            fileInput.value = '';
            if (imagePreview) imagePreview.style.display = 'none';
            controls.style.display = 'none';
            resultSection.style.display = 'none';
            brushResultSection.style.display = 'none';
            hideBrushEffectButton();
            hideMessage();
            hideEmotionFeedback();
            
            // Ïû¨ÏãúÎèÑ Î≤ÑÌäºÎèÑ Ïà®Í∏∞Í∏∞
            const retryBtn = document.getElementById('retryBgRemovalBtn');
            if (retryBtn) retryBtn.style.display = 'none';
        }

        function showLoading(show) {
            loading.style.display = show ? 'block' : 'none';
            controls.style.display = show ? 'none' : 'flex';
        }

        // Ïù¥ÎØ∏ÏßÄ Ï§ÄÎπÑ ÏÉÅÌÉú ÌôïÏù∏ Ìï®Ïàò (Îã®ÏàúÌôî Î∞è Í∞ïÌôî)
        async function waitForImageReady(filename, maxAttempts = 15) {
            console.log('Ïù¥ÎØ∏ÏßÄ Ï§ÄÎπÑ ÏÉÅÌÉú ÌôïÏù∏ ÏãúÏûë:', filename);
            
            for (let i = 0; i < maxAttempts; i++) {
                try {
                    // Ïù¥ÎØ∏ÏßÄ ÏÉÅÌÉú ÌôïÏù∏ API Ìò∏Ï∂ú
                    const checkResponse = await fetch(`/api/check-image/${filename}`, {
                        method: 'GET',
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    if (checkResponse.ok) {
                        const result = await checkResponse.json();
                        
                        if (result.ready && result.size > 1000) {
                            console.log(`‚úÖ Ïù¥ÎØ∏ÏßÄ Ï§ÄÎπÑ ÏôÑÎ£å (${i + 1}/${maxAttempts}):`, result.size, 'bytes');
                            
                            // Ï∂îÍ∞Ä Í≤ÄÏ¶ù: Ïã§Ï†ú Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏóê ÏßÅÏ†ë HEAD ÏöîÏ≤≠
                            try {
                                const imageResponse = await fetch(`/uploads/${filename}`, {
                                    method: 'HEAD',
                                    cache: 'no-store'
                                });
                                
                                if (imageResponse.ok) {
                                    const contentLength = imageResponse.headers.get('content-length');
                                    console.log(`‚úÖ Ïã§Ï†ú Ïù¥ÎØ∏ÏßÄ ÌååÏùº ÌôïÏù∏ ÏôÑÎ£å:`, contentLength, 'bytes');
                                    return true;
                                } else {
                                    console.log(`‚ö†Ô∏è Ïù¥ÎØ∏ÏßÄ ÌååÏùº HEAD ÏöîÏ≤≠ Ïã§Ìå® (${i + 1}/${maxAttempts}):`, imageResponse.status);
                                }
                            } catch (headError) {
                                console.log(`‚ö†Ô∏è Ïù¥ÎØ∏ÏßÄ HEAD ÏöîÏ≤≠ Ïò§Î•ò (${i + 1}/${maxAttempts}):`, headError.message);
                            }
                        } else {
                            console.log(`‚è≥ Ïù¥ÎØ∏ÏßÄ Ï§ÄÎπÑ Ï§ë (${i + 1}/${maxAttempts}):`, result.size || 0, 'bytes');
                        }
                    } else {
                        console.log(`‚ùå ÏÉÅÌÉú ÌôïÏù∏ Ïã§Ìå® (${i + 1}/${maxAttempts}):`, checkResponse.status);
                    }
                } catch (error) {
                    console.log(`‚ùå ÏÉÅÌÉú ÌôïÏù∏ Ïò§Î•ò (${i + 1}/${maxAttempts}):`, error.message);
                }
                
                // Ï†êÏßÑÏ†ÅÏúºÎ°ú ÎåÄÍ∏∞ ÏãúÍ∞Ñ Ï¶ùÍ∞Ä (Îçî Í∏¥ Í∞ÑÍ≤©)
                const waitTime = Math.min(800 + (i * 200), 3000);
                console.log(`‚è∞ ${waitTime}ms ÎåÄÍ∏∞ ÌõÑ Ïû¨ÏãúÎèÑ...`);
                await new Promise(resolve => setTimeout(resolve, waitTime));
            }
            
            console.error('‚ùå Ïù¥ÎØ∏ÏßÄ Ï§ÄÎπÑ ÏÉÅÌÉú ÌôïÏù∏ Ìè¨Í∏∞:', filename);
            return false;
        }

        function showMessage(text, type) {
            message.innerHTML = `<div class="${type}">${text}</div>`;
        }

        function hideMessage() {
            message.innerHTML = '';
        }

        // Í∞êÏ†ïÎ≥Ñ ÏïÑÏù¥ÏΩò Îß§Ìïë (Îçî Ïù¥ÏÉÅ ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùå - Ïù¥ÎØ∏ÏßÄÎ°ú ÎåÄÏ≤¥)

        // Í∞êÏ†ïÎ≥Ñ Ï†úÎ™© Îß§Ìïë
        const emotionTitles = {
            'happy': 'ÌñâÎ≥µÌïú ÏàúÍ∞Ñ',
            'happiness': 'ÌñâÎ≥µÌïú ÏàúÍ∞Ñ',
            'sad': 'Ïä¨Ìîà ÎßàÏùå',
            'sadness': 'Ïä¨Ìîà ÎßàÏùå',
            'neutral': 'ÌèâÏò®Ìïú ÏàúÍ∞Ñ',
            'fear': 'Î∂àÏïàÌïú ÎßàÏùå',
            'surprise': 'ÎÜÄÎùºÏö¥ ÏàúÍ∞Ñ',
            'surprised': 'ÎÜÄÎùºÏö¥ ÏàúÍ∞Ñ',
            'angry': 'ÌôîÎÇú ÎßàÏùå',
            'anger': 'ÌôîÎÇú ÎßàÏùå',
            'disgust': 'Ïó≠Í≤®Ïö¥ ÎäêÎÇå',
            'contempt': 'Í≤ΩÎ©∏ÌïòÎäî ÎßàÏùå'
        };

        // Í∞êÏ†ïÎ≥Ñ Ïù¥ÎØ∏ÏßÄ ÌååÏùº Îß§Ìïë
        function getEmotionImage(emotion) {
            const emotionImages = {
                'happiness': '/happy.png',
                'happy': '/happy.png',
                'sadness': '/sad.png',
                'sad': '/sad.png', 
                'anger': '/angry.png',
                'angry': '/angry.png',
                'surprise': '/surprise.png',
                'surprised': '/surprise.png',
                'fear': '/fear.png',
                'disgust': '/disgust.png',
                'neutral': '/neutral.png',
                'contempt': '/contempt.png'
            };
            return emotionImages[emotion] || '/neutral.png';
        }

        function showEmotionFeedback(emotion, feedback) {
            const emotionImg = document.getElementById('emotionImg');
            if (emotionImg) {
                emotionImg.src = getEmotionImage(emotion);
                emotionImg.alt = emotion;
                
                // Í∞ïÏ†úÎ°ú ÌÅ¨Í∏∞ ÏÑ§Ï†ï
                emotionImg.style.width = '128px';
                emotionImg.style.height = '128px';
                emotionImg.style.minWidth = '128px';
                emotionImg.style.minHeight = '128px';
                emotionImg.style.maxWidth = '128px';
                emotionImg.style.maxHeight = '128px';
                emotionImg.style.borderRadius = '0';
                emotionImg.style.border = 'none';
                emotionImg.style.objectFit = 'contain';
                emotionImg.style.objectPosition = 'center center';
                emotionImg.style.margin = '20px auto 10px auto';
                emotionImg.style.padding = '0';
                emotionImg.style.boxSizing = 'border-box';
                emotionImg.style.display = 'block';
                emotionImg.style.clipPath = 'none';
                emotionImg.style.mask = 'none';
            }
            
            const title = emotionTitles[emotion] || 'Í∞êÏ†ï Î∂ÑÏÑù Í≤∞Í≥º';
            
            emotionTitle.textContent = title;
            emotionMessage.textContent = feedback;
            emotionFeedback.style.display = 'block';
        }

        function hideEmotionFeedback() {
            emotionFeedback.style.display = 'none';
        }

        // Firebase Ïù∏Ï¶ù Ìï®ÏàòÎì§ (headÏóê Ïù¥ÎØ∏ Ï†ïÏùòÎê®)

        async function handleSignup(e) {
            e.preventDefault();
            const username = document.getElementById('authUsername').value;
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;

            // üîß Render Î∞∞Ìè¨ ÌôòÍ≤ΩÏóê ÎßûÍ≤å Ï†àÎåÄ URL ÏÇ¨Ïö©
            const signupApiUrl = window.location.hostname === 'localhost' 
                ? '/api/auth/signup' 
                : `${window.apiBase ? window.apiBase() : window.location.origin}/api/auth/signup`;
            
            console.log('üåê ÌöåÏõêÍ∞ÄÏûÖ API Ìò∏Ï∂ú URL:', signupApiUrl);
            
            try {
                const response = await fetch(signupApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, email, password })
                });

                if (response.status === 503) {
                    showMessage('Firebase AdminÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïÑ ÌöåÏõêÍ∞ÄÏûÖ Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
                    return;
                }

                const data = await response.json();
                if (data.success || data.token) {
                    // ÏÑúÎ≤Ñ JWTÎ•º ÏßÅÏ†ë Ï†ÄÏû• Î∞è UI Í∞±Ïã†
                    localStorage.setItem('token', data.token);
                    authToken = data.token;
                    currentUser = data.user;
                    closeAuthModal();
                    updateAuthUI();
                    showMessage('ÌöåÏõêÍ∞ÄÏûÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!', 'success');
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (error) {
                showMessage('ÌöåÏõêÍ∞ÄÏûÖ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;

            // üîß Render Î∞∞Ìè¨ ÌôòÍ≤ΩÏóê ÎßûÍ≤å Ï†àÎåÄ URL ÏÇ¨Ïö©
            const loginApiUrl = window.location.hostname === 'localhost' 
                ? '/api/auth/login' 
                : `${window.apiBase ? window.apiBase() : window.location.origin}/api/auth/login`;
            
            console.log('üåê Î°úÍ∑∏Ïù∏ API Ìò∏Ï∂ú URL:', loginApiUrl);
            
            try {
                const response = await fetch(loginApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                if (response.status === 503) {
                    showMessage('Firebase AdminÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïÑ Î°úÍ∑∏Ïù∏ Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
                    return;
                }

                const data = await response.json();
                console.log('üîê Î°úÍ∑∏Ïù∏ ÏùëÎãµ:', data);
                if (data.success || data.token) {
                    // ÏÑúÎ≤Ñ JWTÎ•º ÏßÅÏ†ë Ï†ÄÏû• Î∞è UI Í∞±Ïã†
                    console.log('‚úÖ ÌÜ†ÌÅ∞ Ï†ÄÏû•:', data.token?.substring(0, 50) + '...');
                    localStorage.setItem('token', data.token);
                    authToken = data.token;
                    currentUser = data.user;
                    console.log('üë§ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏÑ§Ï†ï:', currentUser);
                    
                    // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ÎèÑ localStorageÏóê Ï†ÄÏû•
                    if (currentUser) {
                        localStorage.setItem('userId', currentUser.id);
                        localStorage.setItem('username', currentUser.username || '');
                        localStorage.setItem('email', currentUser.email || '');
                    }
                    
                    // localStorage Ï†ÄÏû• ÌôïÏù∏
                    console.log('üíæ localStorage Ï†ÄÏû• ÌôïÏù∏:', {
                        token: localStorage.getItem('token')?.substring(0, 50) + '...',
                        userId: localStorage.getItem('userId'),
                        username: localStorage.getItem('username'),
                        email: localStorage.getItem('email'),
                        authToken: authToken?.substring(0, 50) + '...'
                    });
                    
                    closeAuthModal();
                    updateAuthUI();
                    showMessage('Î°úÍ∑∏Ïù∏Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!', 'success');
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (error) {
                showMessage('Î°úÍ∑∏Ïù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // signInWithCustomToken Ìï®Ïàò Î∞è Firebase Ïù∏Ï¶ù Í¥ÄÎ†® ÏΩîÎìú Ï†úÍ±∞ ÎòêÎäî ÎØ∏ÏÇ¨Ïö© Ï≤òÎ¶¨

        function updateAuthUI() {
            if (currentUser) {
                document.getElementById('navLoginBtn').style.display = 'none';
                document.getElementById('navSignupBtn').style.display = 'none';
                // ÌöåÏõê Ïù¥Î¶Ñ(ÎãâÎÑ§ÏûÑ/Ïù¥Î©îÏùº Ï†ÑÏ≤¥) ÌëúÏãú
                document.getElementById('navAvatar').textContent = (currentUser.displayName || currentUser.email);
                document.getElementById('navAvatar').style.display = 'flex';
                document.getElementById('navLogoutBtn').style.display = 'block';
                document.getElementById('gallerySection').style.display = 'block';
            } else {
                document.getElementById('navLoginBtn').style.display = 'block';
                document.getElementById('navSignupBtn').style.display = 'block';
                document.getElementById('navAvatar').style.display = 'none';
                document.getElementById('navLogoutBtn').style.display = 'none';
                document.getElementById('gallerySection').style.display = 'none';
            }
        }

        async function logout() {
            try {
                // Firebase Î°úÍ∑∏ÏïÑÏõÉ ÏãúÎèÑ
                await auth.signOut();
                currentUser = null;
                authToken = null;
                
                // localStorageÏóêÏÑú Î™®Îì† Ïù∏Ï¶ù Ï†ïÎ≥¥ ÏÇ≠Ï†ú
                localStorage.removeItem('token');
                localStorage.removeItem('userId');
                localStorage.removeItem('username');
                localStorage.removeItem('email');
                
                console.log('üö™ Î°úÍ∑∏ÏïÑÏõÉ ÏôÑÎ£å, localStorage Ï†ïÎ¶¨Îê®');
                updateAuthUI();
                showMessage('Î°úÍ∑∏ÏïÑÏõÉÎêòÏóàÏäµÎãàÎã§.', 'success');
            } catch (error) {
                console.error('Î°úÍ∑∏ÏïÑÏõÉ Ïò§Î•ò:', error);
                showMessage('Î°úÍ∑∏ÏïÑÏõÉ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // Í∞§Îü¨Î¶¨ Ï†ÄÏû• Ìï®Ïàò (Î°úÏª¨ Í∞§Îü¨Î¶¨ ÏÇ¨Ïö©)
        async function saveToGallery() {
            console.log('üéØ Î°úÏª¨ Í∞§Îü¨Î¶¨ Ï†ÄÏû• ÏãúÏûë');
            
            const brushResultImage = document.getElementById('brushResultImage');
            if (!brushResultImage || !brushResultImage.src) {
                console.log('‚ùå Î∏åÎü¨Ïãú Í≤∞Í≥º Ïù¥ÎØ∏ÏßÄ ÏóÜÏùå');
                showMessage('Ï†ÄÏû•Ìï† Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä Î∏åÎü¨Ïãú Ìö®Í≥ºÎ•º Ï†ÅÏö©Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }
            console.log('‚úÖ Î∏åÎü¨Ïãú Í≤∞Í≥º Ïù¥ÎØ∏ÏßÄ ÌôïÏù∏:', brushResultImage.src.substring(0, 100) + '...');
            
            try {
                const imageUrl = brushResultImage.src;
                // URLÏóêÏÑú ÌååÏùºÎ™ÖÎßå Ï∂îÏ∂ú (Ïòà: /uploads/filename.png -> filename.png)
                const urlPath = new URL(imageUrl, window.location.origin).pathname;
                
                console.log('üè† Î°úÏª¨ Í∞§Îü¨Î¶¨ Ï†ÄÏû• Îç∞Ïù¥ÌÑ∞:', { imageUrl: urlPath });
                
                // üîß Render Î∞∞Ìè¨ ÌôòÍ≤ΩÏóê ÎßûÍ≤å Ï†àÎåÄ URL ÏÇ¨Ïö©
                const galleryApiUrl = window.location.hostname === 'localhost' 
                    ? '/api/my-art' 
                    : `${window.apiBase ? window.apiBase() : window.location.origin}/api/my-art`;
                
                console.log('üåê Í∞§Îü¨Î¶¨ Ï†ÄÏû• API Ìò∏Ï∂ú URL:', galleryApiUrl);
                
                // Î°úÏª¨ Í∞§Îü¨Î¶¨ ÏÇ¨Ïö© (Firebase Ïù∏Ï¶ù Î¨∏Ï†ú Ïö∞Ìöå)
                const response = await fetch(galleryApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageUrl: urlPath,
                        createdAt: Date.now()
                    })
                });
                
                console.log('üì® ÏùëÎãµ ÏÉÅÌÉú:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`ÏÑúÎ≤Ñ Ïò§Î•ò: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('‚úÖ Í∞§Îü¨Î¶¨Ïóê ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 'success');
                    console.log('‚úÖ Í∞§Îü¨Î¶¨ Ï†ÄÏû• ÏôÑÎ£å:', result.id);
                    
                    // Í∞§Îü¨Î¶¨Í∞Ä ÌòÑÏû¨ ÌëúÏãúÎêòÏñ¥ ÏûàÎã§Î©¥ ÏÉàÎ°úÍ≥†Ïπ®
                    const gallerySection = document.getElementById('gallerySection');
                    if (gallerySection && gallerySection.style.display !== 'none') {
                        loadGallery();
                    }
                } else {
                    throw new Error(result.error || 'Í∞§Îü¨Î¶¨ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
                
            } catch (error) {
                console.error('‚ùå Í∞§Îü¨Î¶¨ Ï†ÄÏû• Ïò§Î•ò:', error);
                showMessage('Í∞§Îü¨Î¶¨ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            }
        }

        // ÌÜ†ÌÅ∞ Í∞±Ïã† Ìï®Ïàò
        async function refreshAuthToken() {
            try {
                // Firebase authÏóêÏÑú ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê Í∞ÄÏ†∏Ïò§Í∏∞
                const firebaseUser = auth.currentUser;
                if (!firebaseUser) {
                    console.log('Firebase ÏÇ¨Ïö©ÏûêÍ∞Ä Î°úÍ∑∏Ïù∏ÌïòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                    return false;
                }
                
                console.log('üîÑ ÌÜ†ÌÅ∞ Í∞±Ïã† ÏãúÏûë...', firebaseUser.uid);
                const newToken = await firebaseUser.getIdToken(true); // force refresh
                authToken = newToken;
                console.log('‚úÖ ÌÜ†ÌÅ∞ Í∞±Ïã† ÏôÑÎ£å');
                return true;
            } catch (error) {
                console.error('‚ùå ÌÜ†ÌÅ∞ Í∞±Ïã† Ïã§Ìå®:', error);
                return false;
            }
        }

        // Í∞§Îü¨Î¶¨ Ìï®ÏàòÎì§ (Î°úÏª¨ Í∞§Îü¨Î¶¨ ÏÇ¨Ïö©)
        function showGallery() {
            // Î°úÍ∑∏Ïù∏ ÏóÜÏù¥ÎèÑ Î°úÏª¨ Í∞§Îü¨Î¶¨ ÏÇ¨Ïö© Í∞ÄÎä•
            
            // Í∞§Îü¨Î¶¨ ÏÑπÏÖò ÌÜ†Í∏Ä (ÌëúÏãú/Ïà®ÍπÄ)
            const gallerySection = document.getElementById('gallerySection');
            if (gallerySection) {
                if (gallerySection.style.display === 'none' || gallerySection.style.display === '') {
                    // Í∞§Îü¨Î¶¨ ÌëúÏãú
                    gallerySection.style.display = 'block';
                    // Í∞§Îü¨Î¶¨Î°ú Ïä§ÌÅ¨Î°§
                    gallerySection.scrollIntoView({ behavior: 'smooth' });
                    // Í∞§Îü¨Î¶¨ Î°úÎìú
                    loadGallery();
                } else {
                    // Í∞§Îü¨Î¶¨ Ïà®ÍπÄ
                    gallerySection.style.display = 'none';
                }
            }
        }
        
        async function loadGallery() {
            console.log('üéØ Í∞§Îü¨Î¶¨ Î°úÎìú ÏãúÏûë');
            console.log('üîç Firebase auth ÏÉÅÌÉú:', auth.currentUser ? 'logged in' : 'not logged in');
            console.log('üîç ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥:', currentUser);
            
            // üîß Render Î∞∞Ìè¨ ÌôòÍ≤ΩÏóê ÎßûÍ≤å Ï†àÎåÄ URL ÏÇ¨Ïö©
            const galleryLoadApiUrl = window.location.hostname === 'localhost' 
                ? '/api/my-art' 
                : `${window.apiBase ? window.apiBase() : window.location.origin}/api/my-art`;
            
            console.log('üåê Í∞§Îü¨Î¶¨ Î°úÎìú API Ìò∏Ï∂ú URL:', galleryLoadApiUrl);
            
            // Î°úÏª¨ Í∞§Îü¨Î¶¨ ÏÇ¨Ïö© (Firebase Ïù∏Ï¶ù Î¨∏Ï†ú Ïö∞Ìöå)
            try {
                const response = await fetch(galleryLoadApiUrl);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ Î°úÏª¨ Í∞§Îü¨Î¶¨ Î°úÎìú ÏÑ±Í≥µ: ${data.items ? data.items.length : 0}Í∞ú Ìï≠Î™©`);
                    displayGallery(data.items || []);
                } else {
                    console.error('‚ùå Î°úÏª¨ Í∞§Îü¨Î¶¨ Î°úÎìú Ïã§Ìå®:', data.error);
                    displayGallery([]);
                }
            } catch (error) {
                console.error('Í∞§Îü¨Î¶¨ Î°úÎìú Ïò§Î•ò:', error);
                displayGallery([]);
            }
            return;

            try {
                // localStorageÏóêÏÑú ÌÜ†ÌÅ∞ ÌôïÏù∏
                const localToken = localStorage.getItem('token');
                if (!localToken) {
                    console.log('‚ùå localStorageÏóê ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏäµÎãàÎã§.');
                    showMessage('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.', 'error');
                    return;
                }
                
                authToken = localToken; // ÌÜ†ÌÅ∞ ÏóÖÎç∞Ïù¥Ìä∏
                console.log('‚úÖ Í∞§Îü¨Î¶¨ Ï°∞ÌöåÏö© ÌÜ†ÌÅ∞ ÌôïÏù∏:', authToken.substring(0, 50) + '...');

                const response = await fetch('/api/gallery', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                console.log('üì® Í∞§Îü¨Î¶¨ Ï°∞Ìöå ÏùëÎãµ ÏÉÅÌÉú:', response.status, response.statusText);

                if (response.status === 503) {
                    // Firebase AdminÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞
                    displayGallery([]);
                    showMessage('Firebase AdminÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïÑ Í∞§Îü¨Î¶¨ Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
                    return;
                }

                if (response.status === 401) {
                    // ÌÜ†ÌÅ∞ ÎßåÎ£å ÎòêÎäî Î¨¥Ìö® - ÌÜ†ÌÅ∞ Í∞±Ïã† ÏãúÎèÑ
                    console.log('ÌÜ†ÌÅ∞Ïù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§. ÌÜ†ÌÅ∞ÏùÑ Í∞±Ïã†Ìï©ÎãàÎã§.');
                    const refreshSuccess = await refreshAuthToken();
                    if (refreshSuccess) {
                        // ÌÜ†ÌÅ∞ Í∞±Ïã† ÏÑ±Í≥µ Ïãú Îã§Ïãú ÏãúÎèÑ
                        return loadGallery();
                    } else {
                        // ÌÜ†ÌÅ∞ Í∞±Ïã† Ïã§Ìå® Ïãú Î°úÍ∑∏Ïù∏ ÌïÑÏöî
                        showMessage('ÌÜ†ÌÅ∞ Í∞±Ïã†Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                        return;
                    }
                }

                if (response.status === 403) {
                    showMessage('Í∞§Îü¨Î¶¨ Ï†ëÍ∑º Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§. Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                    return;
                }

                const data = await response.json();
                console.log('üìÑ Í∞§Îü¨Î¶¨ Ï°∞Ìöå ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:', data);
                
                if (data.success) {
                    console.log(`‚úÖ Í∞§Îü¨Î¶¨ Î°úÎìú ÏÑ±Í≥µ: ${data.gallery ? data.gallery.length : 0}Í∞ú Ìï≠Î™©`);
                    displayGallery(data.gallery);
                } else {
                    console.error('‚ùå Í∞§Îü¨Î¶¨ Î°úÎìú Ïã§Ìå®:', data.error);
                    showMessage('Í∞§Îü¨Î¶¨ Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + (data.error || ''), 'error');
                }
            } catch (error) {
                console.error('Í∞§Îü¨Î¶¨ Î°úÎìú Ïò§Î•ò:', error);
                showMessage('Í∞§Îü¨Î¶¨ Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        let isAllSelected = false;
        function toggleSelectAllGallery() {
            const checkboxes = document.querySelectorAll('.gallery-checkbox');
            isAllSelected = !isAllSelected;
            checkboxes.forEach(cb => {
                cb.checked = isAllSelected;
                cb.dispatchEvent(new Event('click', { bubbles: true }));
            });
            // Î≤ÑÌäº ÌÖçÏä§Ìä∏ ÌÜ†Í∏Ä
            document.getElementById('selectAllBtn').textContent = isAllSelected ? 'Ï†ÑÏ≤¥Ìï¥Ï†ú' : 'Ï†ÑÏ≤¥ÏÑ†ÌÉù';
        }

        function displayGallery(gallery) {
            console.log('üñºÔ∏è Í∞§Îü¨Î¶¨ ÌôîÎ©¥ ÌëúÏãú ÏãúÏûë');
            console.log('üìä Í∞§Îü¨Î¶¨ Îç∞Ïù¥ÌÑ∞:', gallery);
            console.log(`üìà Í∞§Îü¨Î¶¨ ÏïÑÏù¥ÌÖú Ïàò: ${gallery ? gallery.length : 0}`);
            
            const grid = document.getElementById('galleryGrid');
            if (!grid) {
                console.error('‚ùå galleryGrid ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            grid.innerHTML = '';
            // Î°úÏª¨ Í∞§Îü¨Î¶¨ÏóêÏÑúÎäî ÏÑ†ÌÉù Í∏∞Îä• ÎπÑÌôúÏÑ±Ìôî
            selectedGalleryIds = [];
            
            if (!gallery || gallery.length === 0) {
                console.log('üì≠ ÌëúÏãúÌï† Í∞§Îü¨Î¶¨ Ìï≠Î™©Ïù¥ ÏóÜÏäµÎãàÎã§.');
                grid.innerHTML = '<p>Ï†ÄÏû•Îêú ÏûëÌíàÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            gallery.forEach((artwork, index) => {
                console.log(`üñºÔ∏è Í∞§Îü¨Î¶¨ ÏïÑÏù¥ÌÖú ${index + 1} ÏÉùÏÑ± Ï§ë:`, artwork);
                
                const item = document.createElement('div');
                item.className = 'gallery-item';
                
                // Ïù¥ÎØ∏ÏßÄ Ïç∏ÎÑ§Ïùº (Î°úÏª¨ Í∞§Îü¨Î¶¨Ïö© Í∞ÑÏÜåÌôî)
                const img = document.createElement('img');
                const imageUrl = artwork.imageUrl.startsWith('/') ? artwork.imageUrl : '/' + artwork.imageUrl;
                img.src = imageUrl;
                img.alt = artwork.title || 'ÎÇòÏùò ÏûëÌíà';
                console.log(`üì∏ Ïù¥ÎØ∏ÏßÄ URL ÏÑ§Ï†ï: ${imageUrl}`);
                
                img.onload = () => {
                    console.log(`‚úÖ Í∞§Îü¨Î¶¨ Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏÑ±Í≥µ: ${imageUrl}`);
                };
                img.onerror = () => {
                    console.error(`‚ùå Í∞§Îü¨Î¶¨ Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®: ${imageUrl}`);
                };
                
                img.onclick = () => showGalleryModal(artwork.imageUrl, 'ÎÇòÏùò ÏûëÌíà', new Date(artwork.createdAt || Date.now()).toLocaleString('ko-KR'));
                item.appendChild(img);
                
                // Ï†úÎ™© Î∞è ÎÇ†Ïßú Ï∂îÍ∞Ä (Î°úÏª¨ Í∞§Îü¨Î¶¨Ïö©)
                const info = document.createElement('div');
                info.className = 'gallery-item-info';
                info.innerHTML = `
                    <h4>ÎÇòÏùò ÏûëÌíà</h4>
                    <p>${new Date(artwork.createdAt || Date.now()).toLocaleDateString('ko-KR')}</p>
                `;
                item.appendChild(info);
                
                grid.appendChild(item);
                console.log(`‚úÖ Í∞§Îü¨Î¶¨ ÏïÑÏù¥ÌÖú ${index + 1} Ï∂îÍ∞Ä ÏôÑÎ£å`);
            });
        }

        async function deleteArtwork(artworkId) {
            if (!confirm('Ïù¥ ÏûëÌíàÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

            try {
                const response = await fetch(`/api/gallery/${artworkId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    showMessage('ÏûëÌíàÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
                    loadGallery();
                } else {
                    showMessage('ÏûëÌíà ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                }
            } catch (error) {
                console.error('ÏûëÌíà ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                showMessage('ÏûëÌíà ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // Firebase Ïù∏Ï¶ù ÏÉÅÌÉú/ÌÜ†ÌÅ∞ Î≥ÄÍ≤Ω Î¶¨Ïä§ÎÑà (Ìï≠ÏÉÅ ÏµúÏã† ÌÜ†ÌÅ∞ÏùÑ localStorageÏóê Ï†ÄÏû•)
        auth.onIdTokenChanged(async (user) => {
            currentUser = user;
            if (user) {
                const token = await user.getIdToken();
                authToken = token;
                localStorage.setItem('token', token); // Ìï≠ÏÉÅ ÏµúÏã† ÌÜ†ÌÅ∞ Ï†ÄÏû•
                updateAuthUI();
                loadGallery();
            } else {
                authToken = null;
                localStorage.removeItem('token');
                updateAuthUI();
            }
        });

        // ÏÑúÎ≤Ñ ÏÉÅÌÉú ÌôïÏù∏
        async function checkServerStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) {
                    console.log('ÏÑúÎ≤Ñ ÏÉÅÌÉú ÌôïÏù∏ Ïã§Ìå®');
                } else {
                    console.log('ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏÑ±Í≥µ');
                }
            } catch (error) {
                console.log('ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïò§Î•ò:', error.message);
            }
        }

        // Splash ÌôîÎ©¥ Ï†úÏñ¥ Ìï®Ïàò
        function initializeSplashScreen() {
            const splashScreen = document.getElementById('splashScreen');
            const splashVideo = document.getElementById('splashVideo');
            const introScreen = document.getElementById('introScreen');
            
            if (!splashScreen || !splashVideo || !introScreen) {
                console.error('Splash ÌôîÎ©¥ ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            // ÎèôÏòÅÏÉÅ Ï¢ÖÎ£å Ïãú Ïù∏Ìä∏Î°ú ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò
            splashVideo.addEventListener('ended', function() {
                console.log('üé¨ Splash ÎèôÏòÅÏÉÅ Ïû¨ÏÉù ÏôÑÎ£å - Ïù∏Ìä∏Î°ú ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò');
                showIntroScreen();
            });
            
            // ÎèôÏòÅÏÉÅ Î°úÎìú Ïò§Î•ò Ïãú Ï¶âÏãú Ïù∏Ìä∏Î°ú ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò
            splashVideo.addEventListener('error', function() {
                console.log('‚ùå Splash ÎèôÏòÅÏÉÅ Î°úÎìú Ïã§Ìå® - Ïù∏Ìä∏Î°ú ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò');
                showIntroScreen();
            });
            
            // 3Ï¥à ÌõÑ ÏûêÎèôÏúºÎ°ú Ïù∏Ìä∏Î°ú ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò (ÏµúÎåÄ ÎåÄÍ∏∞ ÏãúÍ∞Ñ)
            setTimeout(() => {
                if (splashScreen.style.display !== 'none') {
                    console.log('‚è∞ Splash ÌôîÎ©¥ ÏµúÎåÄ ÎåÄÍ∏∞ ÏãúÍ∞Ñ Ï¥àÍ≥º - Ïù∏Ìä∏Î°ú ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò');
                    showIntroScreen();
                }
            }, 3000);
            
            // ÌôîÎ©¥ ÌÑ∞Ïπò/ÌÅ¥Î¶≠ Ïãú Ï¶âÏãú Ïù∏Ìä∏Î°ú ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò
            splashScreen.addEventListener('click', function() {
                console.log('üëÜ Splash ÌôîÎ©¥ ÌÑ∞Ïπò/ÌÅ¥Î¶≠ - Ïù∏Ìä∏Î°ú ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò');
                showIntroScreen();
            });
            
            // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ÎèÑ Ï∂îÍ∞Ä (Î™®Î∞îÏùº ÏµúÏ†ÅÌôî)
            splashScreen.addEventListener('touchstart', function(e) {
                e.preventDefault(); // Í∏∞Î≥∏ ÌÑ∞Ïπò ÎèôÏûë Î∞©ÏßÄ
                console.log('üì± Splash ÌôîÎ©¥ ÌÑ∞Ïπò ÏãúÏûë - Ïù∏Ìä∏Î°ú ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò');
                showIntroScreen();
            });
            
            // ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏ (Ïä§ÌéòÏù¥Ïä§Î∞î, ÏóîÌÑ∞ÌÇ§)
            document.addEventListener('keydown', function(e) {
                if ((e.code === 'Space' || e.code === 'Enter') && splashScreen.style.display !== 'none') {
                    e.preventDefault();
                    console.log('‚å®Ô∏è ÌÇ§Î≥¥Îìú ÏûÖÎ†• - Ïù∏Ìä∏Î°ú ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò');
                    showIntroScreen();
                }
            });
            
            function showIntroScreen() {
                splashScreen.classList.add('fade-out');
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    introScreen.style.display = 'block';
                    console.log('‚úÖ Ïù∏Ìä∏Î°ú ÌôîÎ©¥ ÌëúÏãú ÏôÑÎ£å');
                }, 500); // ÌéòÏù¥ÎìúÏïÑÏõÉ Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÍ∞ÑÍ≥º ÎßûÏ∂§
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏÑúÎ≤Ñ ÏÉÅÌÉú ÌôïÏù∏ Î∞è Î™®Î∞îÏùº ÏÑ±Îä• ÏµúÏ†ÅÌôî Ï¥àÍ∏∞Ìôî
        window.addEventListener('load', function() {
            checkServerStatus();
            
            // Splash ÌôîÎ©¥ Ï¥àÍ∏∞Ìôî
            initializeSplashScreen();
            
            // Î™®Î∞îÏùº ÏÑ±Îä• Ï†ïÎ≥¥ ÌôïÏù∏
            const performanceInfo = getMobilePerformanceInfo();
            
            // Î™®Î∞îÏùº ÎîîÎ∞îÏù¥Ïä§ÏóêÏÑú Ï∂îÍ∞Ä ÏµúÏ†ÅÌôî Ï†ÅÏö©
            if (performanceInfo.isMobile) {
                // Ï†ÄÏÇ¨Ïñë ÎîîÎ∞îÏù¥Ïä§ Í∞êÏßÄ (Î©îÎ™®Î¶¨ 4GB ÎØ∏Îßå ÎòêÎäî CPU ÏΩîÏñ¥ 4Í∞ú ÎØ∏Îßå)
                const isLowSpec = (performanceInfo.deviceMemory !== 'unknown' && performanceInfo.deviceMemory < 4) ||
                                 performanceInfo.hardwareConcurrency < 4;
                
                if (isLowSpec) {
                    console.log('üì± Ï†ÄÏÇ¨Ïñë Î™®Î∞îÏùº ÎîîÎ∞îÏù¥Ïä§ Í∞êÏßÄ - Ï∂îÍ∞Ä ÏµúÏ†ÅÌôî Ï†ÅÏö©');
                    // Ï†ÄÏÇ¨Ïñë ÎîîÎ∞îÏù¥Ïä§Ïö© Ï∂îÍ∞Ä ÏµúÏ†ÅÌôî ÏÑ§Ï†ï
                    document.documentElement.style.setProperty('--animation-duration', '0.2s'); // Ïï†ÎãàÎ©îÏù¥ÏÖò Îã®Ï∂ï
                    document.documentElement.style.setProperty('--transition-duration', '0.1s'); // Ìä∏ÎûúÏßÄÏÖò Îã®Ï∂ï
                }
                
                // ÎäêÎ¶∞ ÎÑ§Ìä∏ÏõåÌÅ¨ Í∞êÏßÄ
                if (performanceInfo.connection !== 'unknown' && 
                    (performanceInfo.connection.effectiveType === 'slow-2g' || 
                     performanceInfo.connection.effectiveType === '2g')) {
                    console.log('üì∂ ÎäêÎ¶∞ ÎÑ§Ìä∏ÏõåÌÅ¨ Í∞êÏßÄ - Îç∞Ïù¥ÌÑ∞ Ï†àÏïΩ Î™®Îìú ÌôúÏÑ±Ìôî');
                    // ÎäêÎ¶∞ ÎÑ§Ìä∏ÏõåÌÅ¨Ïö© ÏµúÏ†ÅÌôî ÏÑ§Ï†ï
                    window.mobileOptimization = window.mobileOptimization || {};
                    window.mobileOptimization.slowNetwork = true;
                }
            }
        });

        // Î™®Î∞îÏùº Í∞êÏßÄ Ìï®Ïàò (Í∞ïÌôîÎêú ÏÑ±Îä• ÏµúÏ†ÅÌôî)
        function isMobileDevice() {
            const userAgent = navigator.userAgent;
            const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile/i.test(userAgent);
            const isSmallScreen = window.innerWidth <= 768;
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            
            return isMobileUA || (isSmallScreen && isTouchDevice);
        }

        // Î™®Î∞îÏùº ÏÑ±Îä• Î™®ÎãàÌÑ∞ÎßÅ
        function getMobilePerformanceInfo() {
            const info = {
                isMobile: isMobileDevice(),
                deviceMemory: navigator.deviceMemory || 'unknown', // GB
                hardwareConcurrency: navigator.hardwareConcurrency || 1, // CPU ÏΩîÏñ¥ Ïàò
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink + ' Mbps'
                } : 'unknown',
                userAgent: navigator.userAgent
            };
            
            if (info.isMobile) {
                console.log('üì± Î™®Î∞îÏùº ÎîîÎ∞îÏù¥Ïä§ Í∞êÏßÄ:', info);
            }
            
            return info;
        }

        // Ïù∏Ìä∏Î°ú START Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ïù∏Ìä∏Î°ú Ïà®Í∏∞Í≥† Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑàÎ•º Î≥¥Ïù¥Î©¥ÏÑú Î∞îÎ°ú ÌååÏùº ÏÑ†ÌÉùÏ∞Ω Ïó¥Í∏∞ (Î°úÍ∑∏Ïù∏ ÌåùÏóÖ Î∞©ÏßÄ)
        document.getElementById('startBtn').addEventListener('click', function() {
            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            
            // Î™®Î∞îÏùºÏóêÏÑúÎäî Ïπ¥Î©îÎùº Î∞îÎ°ú Ïã§Ìñâ, Îç∞Ïä§ÌÅ¨ÌÜ±ÏóêÏÑúÎäî ÌååÏùº ÏÑ†ÌÉùÏ∞Ω
            setTimeout(() => {
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    if (isMobileDevice()) {
                        // Î™®Î∞îÏùº: Ïπ¥Î©îÎùº Î∞îÎ°ú Ïã§Ìñâ
                        fileInput.setAttribute('capture', 'environment'); // ÌõÑÎ©¥ Ïπ¥Î©îÎùº Ïö∞ÏÑ†
                        fileInput.setAttribute('accept', 'image/*');
                        console.log('üì± Î™®Î∞îÏùº Ïπ¥Î©îÎùº Ïã§Ìñâ');
                    } else {
                        // Îç∞Ïä§ÌÅ¨ÌÜ±: ÏùºÎ∞ò ÌååÏùº ÏÑ†ÌÉù
                        fileInput.removeAttribute('capture');
                        console.log('üíª Îç∞Ïä§ÌÅ¨ÌÜ± ÌååÏùº ÏÑ†ÌÉù');
                    }
                    fileInput.click();
                }
            }, 100);
        });

        // Ïπ¥Î©îÎùº Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú ÌååÏùº ÏÑ†ÌÉùÏ∞Ω Ïó¥Í∏∞
        const cameraBtn = document.getElementById('cameraBtn');
        if (cameraBtn && fileInput) {
          cameraBtn.addEventListener('click', function() {
            if (isMobileDevice()) {
                // Î™®Î∞îÏùº: Ïπ¥Î©îÎùº Î∞îÎ°ú Ïã§Ìñâ
                fileInput.setAttribute('capture', 'environment'); // ÌõÑÎ©¥ Ïπ¥Î©îÎùº Ïö∞ÏÑ†
                fileInput.setAttribute('accept', 'image/*');
                console.log('üì± Î™®Î∞îÏùº Ïπ¥Î©îÎùº Ïã§Ìñâ (Ïπ¥Î©îÎùº Î≤ÑÌäº)');
            } else {
                // Îç∞Ïä§ÌÅ¨ÌÜ±: ÏùºÎ∞ò ÌååÏùº ÏÑ†ÌÉù
                fileInput.removeAttribute('capture');
                console.log('üíª Îç∞Ïä§ÌÅ¨ÌÜ± ÌååÏùº ÏÑ†ÌÉù (Ïπ¥Î©îÎùº Î≤ÑÌäº)');
            }
            fileInput.click();
          });
        }
        
        // üîß Ïù∏Ìä∏Î°ú ÌôîÎ©¥ Î≤ÑÌäºÏùÄ HTML onclick ÏÜçÏÑ±ÏúºÎ°ú Ï≤òÎ¶¨Îê®
    </script>
    <script>
    // Í∞§Îü¨Î¶¨ ÏÉÅÏÑ∏ Î™®Îã¨ Ïó¥Í∏∞ (Í≤∞Í≥º Ïù¥ÎØ∏ÏßÄÎßå)
    function showGalleryModal(resultUrl, title, date) {
        document.getElementById('galleryModal').style.display = 'flex';
        const modalResult = document.getElementById('modalResult');
        if (modalResult) modalResult.src = resultUrl;
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalDate').textContent = date;
    }
    function closeGalleryModal() {
        document.getElementById('galleryModal').style.display = 'none';
    }
    function deleteAllGallery() {
        if (!confirm('Ï†ïÎßê Î™®Îì† ÏûëÌíàÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Î°úÏª¨ Í∞§Îü¨Î¶¨ Î™®Îìú)')) return;
        
        // Î°úÏª¨ Í∞§Îü¨Î¶¨ Ï†ÑÏ≤¥ ÏÇ≠Ï†ú (myart.json Ï¥àÍ∏∞Ìôî)
        try {
            // Í∞ÑÎã®Ìïú ÏïåÎ¶ºÎßå ÌëúÏãú (Ïã§Ï†ú ÏÇ≠Ï†úÎäî ÏÑúÎ≤Ñ Ïû¨ÏãúÏûëÏãú ÌååÏùºÏù¥ Ï¥àÍ∏∞ÌôîÎê®)
            showMessage('Î™®Îì† ÏûëÌíà ÏÇ≠Ï†úÍ∞Ä ÏöîÏ≤≠ÎêòÏóàÏäµÎãàÎã§. (Î°úÏª¨ Í∞§Îü¨Î¶¨ Î™®Îìú)', 'info');
            loadGallery();
        } catch (error) {
            showMessage('Ï†ÑÏ≤¥ ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }
    // ÏÑ†ÌÉù ÏÇ≠Ï†ú Ìï®Ïàò (Î°úÏª¨ Í∞§Îü¨Î¶¨ ÏÇ¨Ïö©)
    function deleteSelectedGallery() {
        if (selectedGalleryIds.length === 0) return;
        if (!confirm('ÏÑ†ÌÉùÌïú ÏûëÌíàÏùÑ Î™®Îëê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
        
        // Î°úÏª¨ Í∞§Îü¨Î¶¨Îäî Í∞ÑÎã®Ìïú ÏÇ≠Ï†ú Ï≤òÎ¶¨
        try {
            // ÌòÑÏû¨Îäî Î°úÏª¨ Í∞§Îü¨Î¶¨ÏóêÏÑú Í∞úÎ≥Ñ ÏÇ≠Ï†úÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÏúºÎØÄÎ°ú
            // Ï†ÑÏ≤¥ Í∞§Îü¨Î¶¨Î•º Îã§Ïãú Î°úÎìúÌïòÍ≥† Î©îÏãúÏßÄÎßå ÌëúÏãú
            showMessage(`${selectedGalleryIds.length}Í∞ú ÏûëÌíà ÏÇ≠Ï†úÍ∞Ä ÏöîÏ≤≠ÎêòÏóàÏäµÎãàÎã§. (Î°úÏª¨ Í∞§Îü¨Î¶¨ Î™®Îìú)`, 'info');
            selectedGalleryIds = [];
            document.getElementById('batchDeleteBtn').style.display = 'none';
            isAllSelected = false;
            document.getElementById('selectAllBtn').textContent = 'Ï†ÑÏ≤¥ÏÑ†ÌÉù';
            loadGallery();
        } catch (error) {
            showMessage('ÏÑ†ÌÉù ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }
    </script>
    <script>
    // Î°úÏª¨ Í∞§Îü¨Î¶¨Ïö© Í∞ÑÏÜåÌôîÎêú Ïä§ÌÅ¨Î¶ΩÌä∏
    
    // üöÄ ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
    let isAppInitialized = false;
    function initializeApp() {
        if (isAppInitialized) {
            console.log('‚ö†Ô∏è Ïï±Ïù¥ Ïù¥ÎØ∏ Ï¥àÍ∏∞ÌôîÎê®, Ï§ëÎ≥µ Ïã§Ìñâ Î∞©ÏßÄ');
                        return;
                    }
        
        console.log('üöÄ Ïï± Ï¥àÍ∏∞Ìôî ÏãúÏûë');
        isAppInitialized = true;
        
        // üîß Ïù∏Ìä∏Î°ú Î≤ÑÌäºÏùÄ Ïù¥Ï†ú onclick ÏÜçÏÑ±ÏúºÎ°ú ÏßÅÏ†ë Ï≤òÎ¶¨Îê®
        
        // localStorageÏóêÏÑú ÌÜ†ÌÅ∞Í≥º ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î≥µÏõê
        const savedToken = localStorage.getItem('token');
        const savedUserId = localStorage.getItem('userId');
        const savedUsername = localStorage.getItem('username');
        const savedEmail = localStorage.getItem('email');
        
        console.log('üíæ Ï†ÄÏû•Îêú Ï†ïÎ≥¥ ÌôïÏù∏:', {
            token: savedToken?.substring(0, 50) + '...',
            userId: savedUserId,
            username: savedUsername,
            email: savedEmail
        });
        
        if (savedToken && savedUserId) {
            // ÌÜ†ÌÅ∞Í≥º ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î≥µÏõê
            authToken = savedToken;
            currentUser = {
                id: savedUserId,
                username: savedUsername,
                email: savedEmail
            };
            
            console.log('‚úÖ ÏÇ¨Ïö©Ïûê ÏÑ∏ÏÖò Î≥µÏõê ÏôÑÎ£å:', currentUser);
            updateAuthUI();
                    } else {
            console.log('‚ö†Ô∏è Ï†ÄÏû•Îêú ÏÑ∏ÏÖò ÏóÜÏùå, Î°úÍ∑∏Ïù∏ ÌïÑÏöî');
        }
    }
    
    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî Ïã§Ìñâ
    document.addEventListener('DOMContentLoaded', initializeApp);
    
    // Ï¶âÏãú Ïã§ÌñâÏúºÎ°ú ÏïàÏ†ÑÏû•Ïπò Ï∂îÍ∞Ä (DOMContentLoadedÍ∞Ä Ïù¥ÎØ∏ Ïã§ÌñâÎêú Í≤ΩÏö∞ ÎåÄÎπÑ)
    if (document.readyState === 'loading') {
        // DOMÏù¥ ÏïÑÏßÅ Î°úÎî© Ï§ëÏù¥Î©¥ DOMContentLoaded Ïù¥Î≤§Ìä∏Î•º Í∏∞Îã§Î¶º
        console.log('‚è≥ DOM Î°úÎî© Ï§ë, DOMContentLoaded Ïù¥Î≤§Ìä∏ ÎåÄÍ∏∞');
    } else {
        // DOMÏù¥ Ïù¥ÎØ∏ Î°úÎìú ÏôÑÎ£åÎêòÏóàÏúºÎ©¥ Ï¶âÏãú Ï¥àÍ∏∞Ìôî
        console.log('‚úÖ DOM Ïù¥ÎØ∏ Î°úÎìúÎê®, Ï¶âÏãú Ï¥àÍ∏∞Ìôî Ïã§Ìñâ');
        initializeApp();
    }
    
    // windowÏóê Ìï®Ïàò Ìï†Îãπ (Î™®Îì† Ìï®Ïàò Ï†ïÏùò ÌõÑ)
    window.showGallery = showGallery;
    window.saveToGallery = saveToGallery;
    window.showGalleryModal = showGalleryModal;
    window.closeGalleryModal = closeGalleryModal;
    window.deleteAllGallery = deleteAllGallery;
    window.deleteSelectedGallery = deleteSelectedGallery;
    
    </script>
</body>
</html> 