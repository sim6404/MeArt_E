<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeArt - AI ì•„íŠ¸ ìƒì„±ê¸°</title>
    <!-- Google Fonts: Pretendard, Inter, Noto Sans ë“± -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>window.__BUILD_ID__ = "2025-08-27T08:32:12.715Z"; console.log('BUILD', window.__BUILD_ID__);</script>
    <script type="module">
      import { installUndefinedFetchGuardOnce, hardHideIntroShowMain, commitPreviewAtomic } from './src/hard-unlock-ui.js';
      window.installUndefinedFetchGuardOnce = installUndefinedFetchGuardOnce;
      window.hardHideIntroShowMain = hardHideIntroShowMain;
      window.commitPreviewAtomic = commitPreviewAtomic;
      installUndefinedFetchGuardOnce();
    </script>
    <script src="api.js?v=2"></script>
    <script src="net-utils.js?v=2"></script>
    
    <!-- ğŸ”§ ë””ë²„ê·¸ ì‹œìŠ¤í…œ + SW ë¬´ë ¥í™” + ìƒíƒœë¨¸ì‹  ê°€ë“œ ì œê±° -->
    <script>
    (function(){
      // â–¼ 1) SW ê°•ì œ í•´ì œ: ?debug=1 ë˜ëŠ” window.__CONFIG__.FORCE_SW_DISABLE
      const qs = new URLSearchParams(location.search);
      if ('serviceWorker' in navigator && (qs.get('debug')==='1' || (window.__CONFIG__&&window.__CONFIG__.FORCE_SW_DISABLE))) {
        navigator.serviceWorker.getRegistrations().then(rs=>Promise.all(rs.map(r=>r.unregister()))).then(()=>caches?.keys().then(keys=>Promise.all(keys.map(k=>caches.delete(k))))).then(()=>console.warn('[SW] unregistered + caches cleared'));
      }
      
      // â–¼ ê°•ì œ ìºì‹œ ë¬´íš¨í™” (ëª¨ë“  ìºì‹œ ì‚­ì œ)
      if (caches) {
        caches.keys().then(keys => {
          keys.forEach(key => {
            console.log('ğŸ§¹ ìºì‹œ ì‚­ì œ:', key);
            caches.delete(key);
          });
        });
      }
      
      // â–¼ í´ë¼ì´ì–¸íŠ¸ ìµœì´ˆ ë¶€íŒ…ì‹œ "/undefined" ìš”ì²­ ë°©ì§€ìš© ì „ì—­ íŒ¨ì¹˜
      const _fetch = window.fetch;
      window.fetch = async function(u, opt) {
        if (typeof u === 'string' && /\/undefined(\?|$)/.test(u)) {
          console.warn('[guard] blocked fetch', u);
          return new Response(JSON.stringify({ok:false,error:'blocked_undefined'}), {
            status: 400, 
            headers: {'content-type':'application/json'}
          });
        }
        return _fetch.apply(this, arguments);
      };
      
      // â–¼ ì•ˆì „í•œ URL ê²°í•© í•¨ìˆ˜
      window.safeConcatUrl = function(u) {
        if (!u || typeof u !== 'string') return null;
        if (u === 'undefined' || /\/undefined(\?|$)/.test(u)) return null;
        return u + (u.includes('?') ? '&' : '?') + 't=' + Date.now();
      };
      // â–¼ 2) ì „ì—­ ì˜¤ë¥˜/ê±°ë¶€ íŠ¸ë©
      window.addEventListener('error', e=>console.error('[window.error]', e.error||e.message));
      window.addEventListener('unhandledrejection', e=>console.error('[unhandledrejection]', e.reason));
      // â–¼ 3) ë””ë²„ê·¸ HUD
      if (qs.get('debug')==='1') {
        const hud = document.createElement('div');
        hud.id='hud'; hud.style.cssText='position:fixed;right:8px;bottom:8px;z-index:99999;background:#111;color:#0f0;font:12px/1.4 monospace;padding:8px;border-radius:8px;max-width:40vw;opacity:.9';
        hud.innerHTML = '<b>DEBUG</b><div id="hudc"></div>';
        document.body.appendChild(hud);
        window.__HUD = (msg)=>{ const c=document.getElementById('hudc'); const p=document.createElement('div'); p.textContent=msg; c.prepend(p); };
        fetch('/__version').then(r=>r.json()).then(j=>__HUD(`version ${j.git} @ ${j.buildAt}`)).catch(()=>{});
        fetch('/__routes').then(r=>r.json()).then(j=>__HUD('routes '+(j.routes||[]).length)).catch(()=>{});
      }
    })();
    </script>
    
    <!-- ğŸ”§ ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡ (Railway ë°°í¬ ìµœì í™”) -->
    <script>
    if ('serviceWorker' in navigator) {
      (async () => {
        try {
          // êµ¬ ìºì‹œ ì •ë¦¬ (Renderâ†’Railway ì „í™˜ í›„)
          const keys = await caches.keys();
          for (const k of keys) {
            if (/meart-|render/i.test(k)) {
              console.log('ğŸ§¹ êµ¬ ìºì‹œ ì‚­ì œ:', k);
              await caches.delete(k);
            }
          }
          
          const reg = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
          // ìƒˆ SWê°€ ì˜¤ë©´ êµì²´
          if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
          reg.addEventListener('updatefound', () => {
            const sw = reg.installing;
            if (!sw) return;
            sw.addEventListener('statechange', () => {
              if (sw.state === 'installed' && navigator.serviceWorker.controller) {
                // ê°•ì œ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ êµ¬ ìºì‹œ/êµ¬ ì˜¤ë¦¬ì§„ ë¬¸ì œ ì œê±°
                location.reload();
              }
            });
          });
          navigator.serviceWorker.addEventListener('message', (e) => {
            if (e.data === 'reload') location.reload();
          });
        } catch (e) {
          console.warn('SW register failed', e);
        }
      })();
    }
    </script>
    
    <!-- ğŸ”§ ì¸íŠ¸ë¡œ ë²„íŠ¼ìš© ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥í•œ í•¨ìˆ˜ë“¤ -->
    <script>
        // Firebase ì¸ì¦ í•¨ìˆ˜ë“¤ì„ ì¦‰ì‹œ ë¡œë“œ
        function showLoginModal() {
            console.log('ğŸ”˜ showLoginModal í˜¸ì¶œë¨');
            
            // ëª¨ë“  ìš”ì†Œ ì¡´ì¬ í™•ì¸
            const modal = document.getElementById('authModal');
            const title = document.getElementById('authModalTitle');
            const submitBtn = document.getElementById('authSubmitBtn');
            const username = document.getElementById('authUsername');
            const form = document.getElementById('authForm');
            
            console.log('ğŸ” ëª¨ë‹¬ ìš”ì†Œ í™•ì¸:', {
                modal: !!modal,
                title: !!title,
                submitBtn: !!submitBtn,
                username: !!username,
                form: !!form
            });
            
            if (!modal) {
                console.error('âŒ authModal ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                alert('ë¡œê·¸ì¸ ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ëª¨ë‹¬ ì„¤ì •
            if (title) title.textContent = 'ë¡œê·¸ì¸';
            if (submitBtn) submitBtn.textContent = 'ë¡œê·¸ì¸';
            if (username) {
                username.style.display = 'none';
                username.removeAttribute('required');
            }
            if (form) form.onsubmit = handleLogin;
            
            // ëª¨ë‹¬ í‘œì‹œ (ê°•ì œë¡œ ìµœìƒìœ„ì— í‘œì‹œ)
            modal.style.display = 'flex';
            modal.style.position = 'fixed';
            modal.style.zIndex = '999999';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            console.log('âœ… ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ ì™„ë£Œ');
        }

        function showSignupModal() {
            console.log('ğŸ”˜ showSignupModal í˜¸ì¶œë¨');
            document.getElementById('authModalTitle').textContent = 'íšŒì›ê°€ì…';
            document.getElementById('authSubmitBtn').textContent = 'íšŒì›ê°€ì…';
            document.getElementById('authUsername').style.display = 'block';
            document.getElementById('authUsername').setAttribute('required', 'required');
            document.getElementById('authForm').onsubmit = handleSignup;
            document.getElementById('authModal').style.display = 'flex';
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            document.getElementById('authForm').reset();
            // required ì†ì„± ì´ˆê¸°í™”
            document.getElementById('authUsername').removeAttribute('required');
            document.getElementById('authUsername').style.display = 'none';
        }

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
        window.showLoginModal = showLoginModal;
        window.showSignupModal = showSignupModal;
        window.closeAuthModal = closeAuthModal;
    </script>

    
    <style>
        :root {
            /* ğŸ¨ ìƒ‰ìƒ ì‹œìŠ¤í…œ */
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --primary-50: rgba(99, 102, 241, 0.05);
            --primary-100: rgba(99, 102, 241, 0.1);
            --primary-500: rgba(99, 102, 241, 0.5);
            
            --accent: #f59e0b;
            --accent-light: #fbbf24;
            --accent-dark: #d97706;
            
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            
            /* ğŸŒˆ ë°°ê²½ & í‘œë©´ */
            --background: #f8fafc;
            --background-secondary: #f1f5f9;
            --surface: #ffffff;
            --surface-secondary: #f8fafc;
            --surface-elevated: #ffffff;
            
            /* ğŸ“ í…ìŠ¤íŠ¸ */
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --text-disabled: #94a3b8;
            --text-on-primary: #ffffff;
            
            /* ğŸ”² ê²½ê³„ì„  */
            --border-primary: #e2e8f0;
            --border-secondary: #cbd5e1;
            --border-focus: var(--primary);
            
            /* ğŸŒŠ ê·¸ë¦¼ì */
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            
            /* ğŸ“ ë‘¥ê·¼ ëª¨ì„œë¦¬ */
            --radius-xs: 4px;
            --radius-sm: 8px;
            --radius: 12px;
            --radius-md: 16px;
            --radius-lg: 20px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            /* ğŸ“ ê°„ê²© */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space: 1rem;
            --space-md: 1.5rem;
            --space-lg: 2rem;
            --space-xl: 3rem;
            --space-2xl: 4rem;
            
            /* âœ¨ ì• ë‹ˆë©”ì´ì…˜ */
            --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-out: cubic-bezier(0, 0, 0.2, 1);
            --ease-in: cubic-bezier(0.4, 0, 1, 1);
            
            /* ğŸ¨ ê·¸ë¼ë””ì–¸íŠ¸ */
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-surface: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            --gradient-glass: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            
            /* ğŸ“± ëª¨ë°”ì¼ ìµœì í™” */
            --touch-target: 44px;
            --mobile-padding: 1rem;
            --mobile-gap: 0.75rem;
        }
        /* ğŸ—ï¸ ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
        * {
            box-sizing: border-box;
        }
        
        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }
        
        html, body {
            font-family: 'Inter', 'Pretendard', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            font-size: 16px;
            scroll-behavior: smooth;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: var(--gradient-surface);
            overflow-x: hidden;
        }
        
        /* ğŸ¯ í¬ì»¤ìŠ¤ ì ‘ê·¼ì„± */
        *:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        /* ğŸ“± í„°ì¹˜ ìµœì í™” */
        @media (hover: none) and (pointer: coarse) {
            * {
                -webkit-tap-highlight-color: transparent;
            }
        }
        
        /* ğŸ”§ ëª¨ë°”ì¼ í™”ë©´ ì „í™˜ ê°•ì œ ì²˜ë¦¬ */
        .intro-screen.hidden-force {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            z-index: -9999 !important;
            position: absolute !important;
            top: -9999px !important;
            left: -9999px !important;
            pointer-events: none !important;
        }
        /* ğŸ§­ ë„¤ë¹„ê²Œì´ì…˜ */
        .nav {
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: var(--shadow-sm);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space) var(--space-lg);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-primary);
            transition: var(--transition);
        }
        
        .nav:hover {
            box-shadow: var(--shadow-md);
        }
        .nav-logo {
            font-size: 2.2rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1.5px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .nav-logo-img {
            height: 4.4rem; /* 2.2rem â†’ 4.4remìœ¼ë¡œ 2ë°° ì¦ê°€ */
            width: auto;
        }
        .nav-menu {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .nav-menu button, .nav-menu .btn {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.95rem;
            padding: 0.7rem 1.5rem;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        .nav-menu button.active, .nav-menu .btn.active, .nav-menu button:hover, .nav-menu .btn:hover {
            background: var(--gradient-primary);
            color: #fff;
            border-color: transparent;
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        .nav-avatar {
            min-width: 38px; height: 38px;
            border-radius: 999px;
            background: var(--primary);
            color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 0.98rem;
            margin-left: 0.7rem;
            padding: 0 1.2rem;
            box-shadow: 0 2px 8px rgba(90,111,240,0.08);
            border: none;
            transition: var(--transition);
            cursor: pointer;
        }
        .nav-avatar:hover {
            background: var(--primary-dark);
        }
        /* ğŸ“¦ ì»¨í…Œì´ë„ˆ & ì¹´ë“œ */
        .container {
            max-width: 600px;
            margin: var(--space-lg) auto 0 auto;
            padding: 0 var(--mobile-padding) var(--space-xl) var(--mobile-padding);
        }
        
        .card {
            background: var(--surface-elevated);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: var(--space-xl) var(--space-lg) var(--space-lg) var(--space-lg);
            margin-bottom: var(--space-xl);
            transition: var(--transition);
            border: 1px solid var(--border-primary);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-glass);
            opacity: 0;
            transition: var(--transition);
            pointer-events: none;
        }
        
        .card:hover::after {
            opacity: 1;
        }
        .card-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            text-align: center;
            position: relative;
        }
        .upload-area {
            border: 2.5px dashed var(--primary);
            border-radius: var(--radius);
            background: #f3f6ff;
            padding: 2.5rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 1.2rem;
        }
        .upload-area:hover, .upload-area.dragover {
            background: #e7eaff;
            border-color: var(--accent);
        }
        .upload-icon {
            font-size: 2.7rem;
            color: var(--primary);
            margin-bottom: 0.7rem;
        }
        .upload-text {
            font-size: 1.1rem;
            color: #444;
            margin-bottom: 0.3rem;
        }
        .upload-hint {
            font-size: 0.92rem;
            color: #888;
        }
        #fileInput { display: none; }
        .image-preview {
            display: flex !important;
            gap: 1.2rem;
            justify-content: center !important;
            margin: 1.2rem auto 0.5rem auto !important;
            flex-wrap: wrap;
            align-items: center !important;
        }
        .preview-container {
            text-align: center !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            /* ì¶”ê°€: ë” ëª…í™•í•œ ì¤‘ì•™ ì •ë ¬ */
            width: 100% !important;
            max-width: 300px !important;
            min-height: 220px;
            margin: 0 auto !important;
        }
        .preview-image {
            max-width: 180px;
            max-height: 180px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(60,60,120,0.08);
            border: 2px solid #f0f0f0;
            object-fit: contain !important;
            /* ì¶”ê°€: ì™„ë²½í•œ ì¤‘ì•™ ì •ë ¬ */
            display: block !important;
            margin: 0 auto !important;
            object-position: center center !important;
        }
        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1.2rem 0 0.5rem 0;
            flex-wrap: wrap;
        }
        /* ğŸ”˜ ë²„íŠ¼ ì‹œìŠ¤í…œ */
        .btn {
            /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            line-height: 1.5;
            cursor: pointer;
            transition: var(--transition);
            background: var(--gradient-primary);
            color: var(--text-on-primary);
            box-shadow: var(--shadow-sm);
            
            /* ë ˆì´ì•„ì›ƒ */
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            text-decoration: none;
            text-align: center;
            white-space: nowrap;
            
            /* í„°ì¹˜ ì¹œí™”ì  */
            min-height: var(--touch-target);
            min-width: var(--touch-target);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), transparent);
            opacity: 0;
            transition: var(--transition-fast);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            filter: brightness(1.05);
        }
        
        .btn:hover::before {
            opacity: 1;
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        
        /* ë²„íŠ¼ ë³€í˜• */
        .btn.secondary {
            background: var(--surface-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--border-primary);
            box-shadow: var(--shadow-xs);
        }
        
        .btn.secondary:hover {
            background: var(--surface);
            color: var(--text-primary);
            border-color: var(--primary);
        }
        
        .btn.outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn.outline:hover {
            background: var(--primary);
            color: var(--text-on-primary);
        }
        
        .btn.ghost {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            box-shadow: none;
        }
        
        .btn.ghost:hover {
            background: var(--primary-50);
            color: var(--primary);
        }
        
        /* ë²„íŠ¼ í¬ê¸° */
        .btn.sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            min-height: 36px;
        }
        
        .btn.lg {
            padding: 1rem 2rem;
            font-size: 1rem;
            min-height: 52px;
        }
        
        .btn.xl {
            padding: 1.25rem 2.5rem;
            font-size: 1.125rem;
            min-height: 60px;
            font-weight: 700;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            filter: none;
        }
        
        .btn:disabled:hover {
            transform: none;
            box-shadow: var(--shadow-xs);
        }
        /* ğŸ”„ ë¡œë”© & ìŠ¤í”¼ë„ˆ */
        .loading {
            display: none;
            text-align: center;
            padding: var(--space-lg) 0;
        }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space);
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-primary);
            border-top: 4px solid var(--primary);
            border-radius: var(--radius-full);
            animation: spin 1s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }
        
        .spinner.sm {
            width: 24px;
            height: 24px;
            border-width: 2px;
        }
        
        .spinner.lg {
            width: 64px;
            height: 64px;
            border-width: 6px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ğŸ”” í† ìŠ¤íŠ¸ ì•Œë¦¼ */
        .toast {
            position: fixed;
            left: 50%;
            bottom: var(--space-xl);
            transform: translateX(-50%);
            background: var(--surface-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-lg);
            padding: var(--space) var(--space-lg);
            font-size: 0.875rem;
            font-weight: 600;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition);
            backdrop-filter: blur(20px);
            max-width: 90vw;
        }
        
        .toast.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(-50%) translateY(-8px);
        }
        
        .toast.success {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        
        .toast.error {
            background: var(--error);
            color: white;
            border-color: var(--error);
        }
        
        .toast.warning {
            background: var(--warning);
            color: white;
            border-color: var(--warning);
        }
        .emotion-feedback {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: #fff;
            border-radius: var(--radius);
            padding: 1.2rem 1rem;
            margin: 1.2rem 0;
            text-align: center;
            box-shadow: 0 4px 16px rgba(90,111,240,0.13);
            animation: fadeInUp 0.6s ease-out;
        }
        .emotion-feedback h3 {
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
            font-weight: 700;
        }
        .emotion-feedback p {
            font-size: 1rem;
            line-height: 1.5;
            margin: 0;
        }
        .emotion-icon {
            font-size: 2.1rem;
            margin-bottom: 0.3rem;
            display: block;
            border-radius: 0 !important;
            overflow: visible !important;
        }
        .emotion-img {
            width: 128px !important;
            height: 128px !important;
            min-width: 128px !important;
            min-height: 128px !important;
            max-width: 128px !important;
            max-height: 128px !important;
            border-radius: 0 !important;
            border: none !important;
            object-fit: contain !important;
            object-position: center center !important;
            margin: 20px auto 10px auto !important;
            padding: 0 !important;
            box-sizing: border-box !important;
            display: block !important;
            clip-path: none !important;
            mask: none !important;
        }
        /* âœ¨ ì• ë‹ˆë©”ì´ì…˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ */
        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes fadeInDown {
            from { 
                opacity: 0; 
                transform: translateY(-30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes fadeInLeft {
            from { 
                opacity: 0; 
                transform: translateX(-30px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
        
        @keyframes fadeInRight {
            from { 
                opacity: 0; 
                transform: translateX(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
        
        @keyframes scaleIn {
            from { 
                opacity: 0; 
                transform: scale(0.8); 
            }
            to { 
                opacity: 1; 
                transform: scale(1); 
            }
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
            }
            50% { 
                transform: scale(1.05); 
            }
        }
        
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translateY(0);
            }
            40%, 43% {
                transform: translateY(-15px);
            }
            70% {
                transform: translateY(-7px);
            }
            90% {
                transform: translateY(-3px);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: calc(200px + 100%) 0;
            }
        }
        
        /* ì• ë‹ˆë©”ì´ì…˜ ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤ */
        .animate-fadeInUp {
            animation: fadeInUp 0.6s var(--ease-out);
        }
        
        .animate-fadeInDown {
            animation: fadeInDown 0.6s var(--ease-out);
        }
        
        .animate-fadeInLeft {
            animation: fadeInLeft 0.6s var(--ease-out);
        }
        
        .animate-fadeInRight {
            animation: fadeInRight 0.6s var(--ease-out);
        }
        
        .animate-scaleIn {
            animation: scaleIn 0.4s var(--ease-out);
        }
        
        .animate-pulse {
            animation: pulse 2s infinite;
        }
        
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        
        /* í˜¸ë²„ íš¨ê³¼ë“¤ */
        .hover-lift {
            transition: var(--transition);
        }
        
        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .hover-scale {
            transition: var(--transition);
        }
        
        .hover-scale:hover {
            transform: scale(1.02);
        }
        
        .hover-glow {
            transition: var(--transition);
        }
        
        .hover-glow:hover {
            box-shadow: 0 0 20px var(--primary-100);
        }
        .result-section {
            margin-top: 1.5rem;
            text-align: center !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
        }
        .result-image {
            max-width: 320px;
            max-height: 320px;
            border-radius: 14px;
            box-shadow: 0 8px 24px rgba(60,60,120,0.13);
            margin: 1rem auto !important;
            display: block !important;
            object-fit: contain !important;
            object-position: center center !important;
        }
        #brushResultSection {
            border-top: 2px solid #e0e4f7;
            padding-top: 24px;
            margin-top: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        #brushResultSection h3 {
            color: #764ba2;
            font-weight: 700;
        }
        /* ğŸ“¥ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ */
        .download-btn {
            background: var(--success);
            color: var(--text-on-primary);
            padding: var(--space-sm) var(--space-lg);
            border: none;
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: var(--space-sm);
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            box-shadow: var(--shadow-sm);
            min-height: var(--touch-target);
        }
        
        .download-btn:hover {
            background: var(--success);
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .download-btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-xs);
        }
        /* ğŸ¨ ëª…í™” ì¶”ì²œ ì„¹ì…˜ */
        .artwork-recommendations {
            margin-top: var(--space-lg);
            padding: var(--space-lg) var(--space);
            background: var(--primary-50);
            border-radius: var(--radius-lg);
            border: 1px solid var(--primary-100);
            transition: var(--transition);
        }
        
        .artwork-recommendations:hover {
            background: var(--primary-100);
            border-color: var(--primary);
        }
        
        .artwork-recommendations h3 {
            text-align: center;
            margin-bottom: var(--space);
            color: var(--primary-dark);
            font-size: 1.125rem;
            font-weight: 700;
        }
        
        .artwork-grid {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space);
            margin-top: var(--space-sm);
            justify-content: center;
            padding: 0 var(--space-xs);
        }
        
        .artwork-item {
            background: var(--surface-elevated);
            border-radius: var(--radius);
            padding: var(--space-sm);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border-primary);
            box-shadow: var(--shadow-xs);
            flex: 0 0 120px;
            position: relative;
            overflow: hidden;
        }
        
        .artwork-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-glass);
            opacity: 0;
            transition: var(--transition);
            pointer-events: none;
        }
        
        .artwork-item:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }
        
        .artwork-item:hover::before {
            opacity: 1;
        }
        
        .artwork-item:active {
            transform: translateY(-2px) scale(1.01);
            box-shadow: var(--shadow-sm);
        }
        
        .artwork-thumbnail {
            width: 100%;
            height: 90px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-sm);
            transition: var(--transition);
            background: var(--background-tertiary);
            position: relative;
        }
        
        .artwork-thumbnail.loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255,255,255,0.2), 
                transparent
            );
            animation: shimmer 1.5s infinite;
        }
        
        .artwork-thumbnail.loaded {
            opacity: 1;
        }
        
        .artwork-thumbnail.error {
            background: var(--background-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
            font-size: 0.75rem;
        }
        
        .artwork-thumbnail.error::after {
            content: 'ğŸ–¼ï¸';
            font-size: 1.5rem;
        }
        
        .artwork-item:hover .artwork-thumbnail {
            transform: scale(1.05);
        }
        
        .artwork-info {
            position: relative;
            z-index: 1;
        }
        
        .artwork-info h4 {
            margin: 0 0 var(--space-xs) 0;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 600;
            line-height: 1.3;
        }
        
        .artwork-info p {
            margin: 0;
            color: var(--text-tertiary);
            font-size: 0.75rem;
            font-style: italic;
            line-height: 1.2;
        }
        /* ğŸ¦¶ í‘¸í„° */
        .footer {
            text-align: center;
            color: var(--text-tertiary);
            margin-top: var(--space-2xl);
            padding: var(--space-lg) 0;
            font-size: 0.875rem;
            border-top: 1px solid var(--border-primary);
            background: var(--surface-secondary);
        }
        
        /* ğŸ“± ì¶”ê°€ ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 320px) {
            :root {
                --mobile-padding: 0.75rem;
                --mobile-gap: 0.5rem;
            }
            
            .card {
                padding: var(--space) var(--mobile-padding);
            }
            
            .btn {
                padding: 0.6rem 0.75rem;
                font-size: 0.8rem;
            }
            
            .artwork-item {
                flex: 0 0 100px;
            }
            
            .artwork-thumbnail {
                height: 75px;
            }
        }
        /* ê°¤ëŸ¬ë¦¬ */
        .gallery-section {
            margin-top: 2.5rem;
            padding: 2rem;
            background: var(--card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }
        .gallery-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2rem;
        }
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
        }
        .gallery-item {
            background: #fff;
            border-radius: 12px;
            padding: 0.7rem 0.5rem;
            box-shadow: 0 2px 8px rgba(60,60,120,0.07);
            transition: var(--transition);
            position: relative;
        }
        .gallery-item:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 8px 24px rgba(90,111,240,0.13);
        }
        .gallery-item img {
            width: 100%;
            height: 90px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        .gallery-item h4 {
            margin: 0 0 4px 0;
            color: var(--primary-dark);
            font-size: 0.98rem;
        }
        .gallery-item p {
            margin: 0 0 4px 0;
            color: #666;
            font-size: 0.85rem;
        }
        .gallery-item .emotion-tag {
            display: inline-block;
            padding: 2px 8px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: #fff;
            border-radius: 999px;
            font-size: 0.8rem;
            margin-bottom: 4px;
        }
        .gallery-item .delete-btn {
            position: absolute;
            top: 8px; right: 8px;
            background: #dc3545;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 24px; height: 24px;
            cursor: pointer;
            font-size: 13px;
            transition: var(--transition);
        }
        .gallery-item .delete-btn:hover { background: #c82333; }
        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .container { 
                max-width: 100%; 
                padding: 0 1rem 2rem 1rem; 
                margin: 1.5rem auto 0 auto;
            }
            .nav { 
                padding: 0.8rem 1.5rem; 
                border-radius: 0 0 var(--radius) var(--radius);
            }
            .nav-logo {
                font-size: 1.8rem;
            }
            .card { 
                padding: 2rem 1.5rem 1.5rem 1.5rem; 
                margin-bottom: 2rem;
            }
            .card-title {
                font-size: 1.5rem;
            }
            .camera-btn {
                width: 150px;
                height: 150px;
            }
            .camera-btn .camera-icon {
                font-size: 2.5rem;
            }
            .camera-btn .camera-text {
                font-size: 0.9rem;
            }
            .gallery-grid, .artwork-grid { 
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
                gap: 0.8rem;
            }
        }
        @media (max-width: 480px) {
            .nav { 
                flex-direction: column; 
                gap: 1rem; 
                padding: 1rem;
            }
            .nav-logo { 
                font-size: 1.6rem; 
            }
            .nav-menu { 
                gap: 0.5rem; 
                flex-wrap: wrap;
                justify-content: center;
            }
            .nav-menu button, .nav-menu .btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
            .container { 
                padding: 0 0.5rem 1.5rem 0.5rem; 
                margin: 1rem auto 0 auto;
            }
            .card { 
                padding: 1.5rem 1rem 1rem 1rem; 
                margin-bottom: 1.5rem;
            }
            .card-title {
                font-size: 1.3rem;
            }
            .camera-section {
                padding: 1.5rem;
                min-height: 160px;
            }
            .camera-btn {
                width: 120px;
                height: 120px;
                gap: 0.5rem;
            }
            .camera-btn .camera-icon {
                font-size: 2rem;
            }
            .camera-btn .camera-text {
                font-size: 0.8rem;
            }
            .gallery-grid, .artwork-grid { 
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 0.6rem;
            }
            .gallery-section {
                padding: 1.5rem 1rem;
            }
        }
        
        /* ===== ì¶”ê°€ ì´ë¯¸ì§€ ì¤‘ì•™ ì •ë ¬ ê°•í™” ===== */
        #processedImage {
            display: block !important;
            margin: 1rem auto !important;
            object-fit: contain !important;
            object-position: center center !important;
            max-width: 100% !important;
        }
        
        /* ì¸ì¦ ëª¨ë‹¬ (ë¡œê·¸ì¸/íšŒì›ê°€ì…) */
        .auth-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw; height: 100vh;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        .auth-modal-content {
            background: var(--card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            padding: 2.5rem 2rem 2rem 2rem;
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.5s ease-out;
        }
        .auth-modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        .auth-modal-content h2 {
            color: var(--primary-dark);
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 1.2rem;
            text-align: center;
        }
        .auth-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .auth-form input {
            width: 100%;
            padding: 0.85rem 1.1rem;
            border: 1.5px solid #e0e4f7;
            border-radius: 999px;
            font-size: 1rem;
            background: #f6f7fb;
            color: #222;
            outline: none;
            transition: border 0.2s;
        }
        .auth-form input:focus {
            border-color: var(--primary);
            background: #f3f6ff;
        }
        .auth-form button.btn {
            margin-top: 0.5rem;
            width: 100%;
            padding: 0.85rem 0;
            font-size: 1.08rem;
        }
        .auth-modal .btn.secondary {
            width: 100%;
            margin-top: 0.5rem;
        }
        @media (max-width: 480px) {
            .auth-modal-content {
                padding: 1.2rem 0.5rem 1rem 0.5rem;
                max-width: 98vw;
            }
            .auth-form input, .auth-form button.btn, .auth-modal .btn.secondary {
                font-size: 0.98rem;
                padding: 0.7rem 0.7rem;
            }
        }
        
        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal { position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;}
        .modal-content { background:#fff;padding:32px 24px;border-radius:12px;min-width:400px;position:relative;}
        .close { position:absolute;top:12px;right:18px;font-size:2rem;cursor:pointer;}
        .btn.danger { background:#dc3545;color:#fff; }
        .btn.danger:hover { background:#b52a37; }
        .btn.warning { background:#f59e0b;color:#fff; }
        .btn.warning:hover { background:#d97706; }
        
        /* ì¹´ë©”ë¼ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .camera-section {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            padding: 2rem;
        }
        
        .camera-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            width: 180px;
            height: 180px;
            border: none;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: #fff;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }
        
        .camera-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .camera-btn:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 25px 50px rgba(102, 126, 234, 0.4);
        }
        
        .camera-btn:hover::before {
            opacity: 1;
        }
        
        .camera-btn .camera-icon {
            font-size: 3rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        
        .camera-btn .camera-text {
            font-size: 0.95rem;
            font-weight: 600;
            text-align: center;
            line-height: 1.3;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        /* ì¸íŠ¸ë¡œ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .intro-screen {
            position: fixed;
            z-index: 9999;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: url('intro.png') center/cover no-repeat;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            overflow: hidden;
        }
        
        .intro-nav {
            width: 100%;
            padding: 2rem 3rem 0 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .intro-logo {
            font-size: 2.5rem;
            font-weight: 800;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            letter-spacing: -1px;
        }
        
        .intro-nav-buttons {
            display: flex;
            gap: 1rem;
        }
        
        .intro-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-decoration: none;
            outline: none;
        }
        
        .intro-btn-outline {
            background: transparent;
            color: #fff;
            border-color: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .intro-btn-outline:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        .intro-btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .intro-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }
        
        .intro-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 2rem;
        }
        
        .intro-hero {
            margin-bottom: 3rem;
        }
        
        .intro-title {
            font-size: 4.5rem;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            letter-spacing: -3px;
            margin: 0 0 1rem 0;
            line-height: 1;
            background: linear-gradient(135deg, #fff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .intro-logo-img {
            max-height: 9rem;
            width: auto;
            filter: drop-shadow(0 4px 20px rgba(0, 0, 0, 0.3));
        }
        
        .intro-subtitle {
            font-size: 2.5rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            margin-bottom: 2rem;
            letter-spacing: -1px;
        }
        
        .intro-description {
            font-size: 1.4rem;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.8;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
        }
        
        .intro-description p {
            margin: 0.5rem 0;
        }
        
        .intro-action {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        
        .intro-start-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            font-size: 2.5rem;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .intro-start-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .intro-start-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }
        
        .intro-start-btn:hover::before {
            opacity: 1;
        }
        
        .camera-icon {
            font-size: 2.5rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            transform: translateY(-5px);
        }
        
        .intro-action-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
        }
        
        .intro-footer {
            width: 100%;
            padding: 2rem 3rem 3rem 3rem;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.05);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .intro-features {
            display: flex;
            justify-content: center;
            gap: 0; /* ì—¬ë°± ì™„ì „ ì‚­ì œ */
            max-width: 600px;
            margin: 0 auto;
        }
        
        .feature-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            text-align: center;
        }
        
        .feature-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        
        /* ğŸ“± íƒœë¸”ë¦¿ ë°˜ì‘í˜• (768px ì´í•˜) */
        @media (max-width: 768px) {
            :root {
                --mobile-padding: 1.5rem;
                --mobile-gap: 1rem;
            }
            
            .nav {
                padding: var(--space-sm) var(--mobile-padding);
                border-radius: 0 0 var(--radius) var(--radius);
            }
            
            .nav-logo {
                font-size: 1.75rem;
            }
            
            .nav-menu {
                gap: var(--space-sm);
            }
            
            .nav-menu button, .nav-menu .btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.875rem;
            }
            
            .container {
                max-width: 100%;
                padding: 0 var(--mobile-padding) var(--space-lg) var(--mobile-padding);
                margin-top: var(--space);
            }
            
            .card {
                margin-bottom: var(--space-lg);
                padding: var(--space-lg) var(--mobile-padding) var(--mobile-padding) var(--mobile-padding);
                border-radius: var(--radius-lg);
            }
            
            .card-title {
                font-size: 1.5rem;
                margin-bottom: var(--space);
            }
            
            /* ì¸íŠ¸ë¡œ í™”ë©´ */
            .intro-nav {
                padding: var(--space) var(--mobile-padding) 0 var(--mobile-padding);
            }
            
            .intro-logo {
                font-size: 2rem;
            }
            
            .intro-btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.875rem;
            }
            
            .intro-title {
                font-size: 3.5rem;
                letter-spacing: -2px;
            }
            
            .intro-subtitle {
                font-size: 2rem;
            }
            
            .intro-description {
                font-size: 1.2rem;
                padding: 0 var(--mobile-padding);
            }
            
            .intro-start-btn {
                width: 80px;
                height: 80px;
                font-size: 2rem;
            }
            
            .intro-footer {
                padding: var(--space-lg) var(--mobile-padding) var(--space-xl) var(--mobile-padding);
            }
            
            .intro-features {
                gap: var(--mobile-gap);
            }
        }
        
        /* ğŸ“± ëª¨ë°”ì¼ ì „ìš© (480px ì´í•˜) */
        @media (max-width: 480px) {
            :root {
                --mobile-padding: 1rem;
                --mobile-gap: 0.75rem;
                --touch-target: 48px; /* ë” í° í„°ì¹˜ ì˜ì—­ */
            }
            
            /* ğŸ§­ ë„¤ë¹„ê²Œì´ì…˜ */
            .nav {
                padding: var(--space-sm) var(--mobile-padding);
                flex-wrap: wrap;
                gap: var(--space-sm);
            }
            
            .nav-logo {
                font-size: 1.5rem;
            }
            
            .nav-menu {
                flex-wrap: wrap;
                gap: var(--space-xs);
            }
            
            .nav-menu button, .nav-menu .btn {
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
                min-height: 40px;
            }
            
            /* ğŸ“¦ ì»¨í…Œì´ë„ˆ & ì¹´ë“œ */
            .container {
                padding: 0 var(--mobile-padding) var(--space-lg) var(--mobile-padding);
                margin-top: var(--space-sm);
            }
            
            .card {
                margin-bottom: var(--space);
                padding: var(--space) var(--mobile-padding);
                border-radius: var(--radius);
                box-shadow: var(--shadow);
            }
            
            .card-title {
                font-size: 1.25rem;
                margin-bottom: var(--mobile-gap);
            }
            
            /* ğŸ”˜ ë²„íŠ¼ */
            .btn {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                min-height: var(--touch-target);
                gap: var(--space-xs);
            }
            
            .btn.sm {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
                min-height: 40px;
            }
            
            .btn.lg {
                padding: 1rem 1.5rem;
                font-size: 1rem;
                min-height: 56px;
            }
            
            /* ğŸ“¸ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° */
            .preview-container {
                padding: var(--space-sm);
                max-width: 100%;
            }
            
            .preview-image {
                max-width: 160px;
                max-height: 160px;
                border-radius: var(--radius);
            }
            
            /* ğŸ¨ ëª…í™” ì¶”ì²œ */
            .artwork-grid {
                padding: 0 var(--space-xs);
                gap: var(--space-xs);
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .artwork-grid::-webkit-scrollbar {
                display: none;
            }
            
            .artwork-item {
                flex: 0 0 80px;
                width: 80px;
                height: 80px;
                min-width: 80px;
                border-radius: var(--radius-sm);
                overflow: hidden;
                transition: var(--transition);
            }
            
            .artwork-item:hover {
                transform: scale(1.05);
            }
            
            .artwork-item img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: var(--radius-sm);
            }
            
            /* ğŸ“± ì¸íŠ¸ë¡œ í™”ë©´ */
            .intro-nav {
                padding: var(--mobile-padding);
                flex-direction: column;
                gap: var(--space);
                text-align: center;
            }
            
            .intro-logo {
                font-size: 1.75rem;
            }
            
            .intro-nav-buttons {
                gap: var(--space-sm);
                justify-content: center;
            }
            
            .intro-btn {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
                min-height: 40px;
            }
            
            .intro-title {
                font-size: 2.5rem;
                letter-spacing: -1px;
                margin-bottom: var(--space);
            }
            
            .intro-subtitle {
                font-size: 1.5rem;
                margin-bottom: var(--space);
            }
            
            .intro-description {
                font-size: 1rem;
                padding: 0 var(--space);
                line-height: 1.6;
            }
            
            .intro-start-btn {
                width: 70px;
                height: 70px;
                font-size: 1.75rem;
            }
            
            .intro-footer {
                padding: var(--space) var(--mobile-padding) var(--space-lg) var(--mobile-padding);
            }
            
            .intro-features {
                flex-direction: column;
                gap: var(--space);
                max-width: 100%;
            }
            
            .feature-item {
                flex-direction: row;
                gap: var(--space);
                text-align: left;
                justify-content: flex-start;
            }
            
            .feature-icon {
                font-size: 1.5rem;
                margin-bottom: 0;
                flex-shrink: 0;
            }
            
            /* ğŸ¨ ì—…ë¡œë“œ ì˜ì—­ */
            .upload-area {
                padding: var(--space-lg) var(--space);
                border-width: 2px;
            }
            
            .upload-icon {
                font-size: 2rem;
            }
            
            .upload-text {
                font-size: 1rem;
            }
            
            .upload-hint {
                font-size: 0.8rem;
            }
            
            /* ğŸ“Š ê°ì • í”¼ë“œë°± */
            .emotion-feedback {
                padding: var(--space) var(--mobile-gap);
                margin: var(--space) 0;
                border-radius: var(--radius);
            }
            
            .emotion-img {
                width: 96px !important;
                height: 96px !important;
                min-width: 96px !important;
                min-height: 96px !important;
                max-width: 96px !important;
                max-height: 96px !important;
                margin: var(--space-sm) auto !important;
            }
            
            /* ğŸï¸ ê²°ê³¼ ì´ë¯¸ì§€ */
            .result-image {
                max-width: 280px;
                max-height: 280px;
                border-radius: var(--radius);
                margin: var(--space) auto !important;
            }
            
            /* ğŸ¨ ì¹´ë©”ë¼ ì„¹ì…˜ */
            .camera-section {
                padding: var(--space-sm);
                min-height: 100px;
            }
            
            .camera-btn {
                width: 80px;
                height: 80px;
                font-size: 1.25rem;
                border-radius: var(--radius-full);
            }
        }

        /* ë¡œê³  ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .logo-img {
            width: 32px;
            height: 32px;
            vertical-align: middle;
            margin-right: 8px;
        }

        /* ê°ì • ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .emotion-img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
        }

        /* ì¹´ë©”ë¼ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì œê±° í›„ ì¡°ì • */
        .camera-btn {
            width: 120px;
            height: 120px;
        }

        /* ğŸ¬ Splash í™”ë©´ ìŠ¤íƒ€ì¼ */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000; /* ì¸íŠ¸ë¡œ í™”ë©´ë³´ë‹¤ ìœ„ì— */
            overflow: hidden;
            cursor: pointer;
        }

        .splash-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            background: #000;
        }
        
        /* í„°ì¹˜ ìœ ë„ í…ìŠ¤íŠ¸ */
        .splash-touch-hint {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            z-index: 10001;
            animation: pulseGlow 2s ease-in-out infinite;
            pointer-events: none;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        
        @keyframes pulseGlow {
            0%, 100% {
                opacity: 0.6;
                transform: translateX(-50%) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateX(-50%) scale(1.05);
            }
        }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            .splash-video {
                /* ëª¨ë°”ì¼ì—ì„œ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ì„¤ì • */
                will-change: transform;
                transform: translateZ(0);
            }
        }

        /* Splash í™”ë©´ í˜ì´ë“œì•„ì›ƒ ì• ë‹ˆë©”ì´ì…˜ */
        .splash-screen.fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                visibility: hidden;
            }
        }

        @media (max-width: 768px) {
            .preview-image {
                max-width: 100%;
                height: auto;
                object-fit: contain;
                /* ì¶”ê°€: ëª¨ë°”ì¼ì—ì„œë„ ì™„ë²½í•œ ì¤‘ì•™ ì •ë ¬ */
                display: block;
                margin: 0 auto;
                object-position: center center;
                width: auto;
                max-height: 300px;
            }
            
            .image-preview {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 1rem;
                padding: 1rem;
            }
            
            .preview-container {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
        }

        /* ë¸ŒëŸ¬ì‹œ ê²°ê³¼ ì´ë¯¸ì§€ ì¤‘ì•™ ì •ë ¬ ê°•í™” */
        #processedImage {
            display: block !important;
            margin: 0 auto !important;
            object-position: center center !important;
            text-align: center;
        }

        /* ê²°ê³¼ ì„¹ì…˜ ì „ì²´ ì¤‘ì•™ ì •ë ¬ */
        .result-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Splash í™”ë©´ -->
    <div id="splashScreen" class="splash-screen">
        <video id="splashVideo" class="splash-video" autoplay muted playsinline>
            <source src="/Splash_meart.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <div class="splash-touch-hint">
            ğŸ“± í„°ì¹˜í•˜ì—¬ ì‹œì‘í•˜ê¸°
        </div>
    </div>

    <!-- ì¸íŠ¸ë¡œ í™”ë©´ -->
    <div id="introScreen" class="intro-screen" style="display: none;">
        <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="intro-nav">
            <div class="intro-nav-buttons">
                <button class="intro-btn intro-btn-outline" id="introLoginBtn" onclick="console.log('ğŸ”˜ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ë¨'); try { window.showLoginModal(); } catch(e) { console.error('âŒ ëª¨ë‹¬ ì˜¤ë¥˜:', e); alert('ë¡œê·¸ì¸ ëª¨ë‹¬ ì˜¤ë¥˜: ' + e.message); }">ë¡œê·¸ì¸</button>
                <button class="intro-btn intro-btn-primary" id="introSignupBtn" onclick="console.log('ğŸ”˜ íšŒì›ê°€ì… ë²„íŠ¼ í´ë¦­ë¨'); try { window.showSignupModal(); } catch(e) { console.error('âŒ ëª¨ë‹¬ ì˜¤ë¥˜:', e); alert('íšŒì›ê°€ì… ëª¨ë‹¬ ì˜¤ë¥˜: ' + e.message); }">íšŒì›ê°€ì…</button>
        </div>
        </div>
        
        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="intro-content">
            <div class="intro-hero">
                <h1 class="intro-title"><img src="/logo_intro.png" alt="MeArt" class="intro-logo-img"></h1>
                <div class="intro-description">
                    <p>ê°ì •ì„ ì˜ˆìˆ ë¡œ ë°”ê¾¸ëŠ” í•œ ìˆœê°„,</p>
                    <p>ë‚˜ë§Œì˜ ëª…í™”ê°€ ì‹œì‘ë©ë‹ˆë‹¤</p>
                </div>
            </div>
            
            <div class="intro-action">
                <button id="startBtn" class="intro-start-btn">
                    <span class="camera-icon">ğŸ“¸</span>
                </button>
                <div class="intro-action-text">ì‚¬ì§„ ì´¬ì˜/ì—…ë¡œë“œ</div>
            </div>
        </div>
        
        <!-- í•˜ë‹¨ ì •ë³´ -->
        <div class="intro-footer">
            <div class="intro-features">
                <div class="feature-item">
                    <span class="feature-icon">ğŸ­</span>
                    <span>AI ê°ì • ë¶„ì„</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">ğŸ–¼ï¸</span>
                    <span>ëª…í™” ë°°ê²½ í•©ì„±</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">ğŸ¨</span>
                    <span>ë¸ŒëŸ¬ì‹œ íš¨ê³¼</span>
                </div>
            </div>
        </div>
    </div>
    <nav class="nav">
        <div class="nav-logo"><img src="/logo_icon.png" alt="MeArt" class="nav-logo-img"></div>
        <div class="nav-menu" id="navMenu">
            <button class="btn secondary" onclick="showGallery()">ê°¤ëŸ¬ë¦¬</button>
            <button class="btn secondary" onclick="showLoginModal()" id="navLoginBtn">ë¡œê·¸ì¸</button>
            <button class="btn secondary" onclick="showSignupModal()" id="navSignupBtn">íšŒì›ê°€ì…</button>
            <button class="nav-avatar btn secondary" id="navAvatar" style="display:none; border:none;">U</button>
            <button class="btn secondary" onclick="logout()" id="navLogoutBtn" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </nav>
    <div class="container" id="mainContainer" style="display:none;">
        <div class="card" id="photoCard">
            <div class="card-title">ì‚¬ì§„ ì´¬ì˜/ì—…ë¡œë“œ</div>
            <div class="camera-section">
                <button id="cameraBtn" class="camera-btn">
                    <span class="camera-icon">ğŸ“¸</span>
                </button>
                <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none;">
            </div>
            <!-- ì›ë³¸/ì²˜ë¦¬ëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ ì‚­ì œë¨ -->
            <div class="controls" id="controls" style="display: none;">
                <button class="btn secondary" onclick="resetImage()">ë‹¤ì‹œ ì‹œì‘</button>
                <button class="btn warning" id="retryBgRemovalBtn" onclick="retryBackgroundRemoval()" style="display: none;">ğŸ”„ ë°°ê²½ ì œê±° ì¬ì‹œë„</button>
            </div>
            <div id="message"></div>
            <div id="emotionFeedback" style="display: none;" class="emotion-feedback">
                <span id="emotionIcon" class="emotion-icon">
                    <img id="emotionImg" src="/neutral.png" alt="ê°ì • ë¶„ì„ ì¤‘" class="emotion-img" style="width: 128px !important; height: 128px !important; border-radius: 0 !important; border: none !important; object-fit: contain !important; object-position: center center !important; margin: 20px auto 10px auto !important; padding: 0 !important; box-sizing: border-box !important; display: block !important; clip-path: none !important; mask: none !important;">
                </span>
                <h3 id="emotionTitle">ê°ì • ë¶„ì„ ê²°ê³¼</h3>
                <p id="emotionMessage">ë‹¹ì‹ ì˜ ê°ì •ì„ ë¶„ì„í•˜ê³  ìˆì–´ìš”...</p>
            </div>
            <div id="artworkRecommendationsContainer"></div>
            <div class="result-section" id="resultSection" style="display: none;">
                <h3>1ë‹¨ê³„: ë°°ê²½ í•©ì„± ê²°ê³¼</h3>
                <img id="previewImage" class="result-image" alt="ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>ì´ë¯¸ì§€ë¥¼ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>
                <br>
                <button id="brushEffectBtn" class="btn" style="display: none; margin: 16px auto; background: #764ba2; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600;">
                    ğŸ¨ ì¸ë¬¼ë¸ŒëŸ¬ì‰¬íš¨ê³¼ ì ìš©
                </button>
                <div id="brushResultSection" style="display: none; margin-top: 24px;">
                    <h3>2ë‹¨ê³„: ë¸ŒëŸ¬ì‰¬ íš¨ê³¼ ì ìš© ê²°ê³¼</h3>
                    <img id="brushResultImage" class="result-image" alt="ë¸ŒëŸ¬ì‰¬ íš¨ê³¼ ê²°ê³¼ ì´ë¯¸ì§€">
                    <br>
                    <div class="result-actions" style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;">
                        <a id="downloadLink" class="download-btn" download="meart_result.png">ë‹¤ìš´ë¡œë“œ</a>
                        <button id="saveToGalleryBtn" class="btn" onclick="saveToGallery()" style="background: #28a745; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600;">
                            ğŸ’¾ ê°¤ëŸ¬ë¦¬ì— ì €ì¥
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="gallerySection" class="gallery-section" style="display: none;">
            <div class="gallery-header">
                <h3>ğŸ¨ Me Gallery (ë¡œì»¬ ëª¨ë“œ)</h3>
                <button class="btn" onclick="loadGallery()">ìƒˆë¡œê³ ì¹¨</button>
                <!-- ë¡œì»¬ ê°¤ëŸ¬ë¦¬ì—ì„œëŠ” ì‚­ì œ ê¸°ëŠ¥ ì¼ì‹œ ë¹„í™œì„±í™” -->
                <!--<button class="btn secondary" id="selectAllBtn" onclick="toggleSelectAllGallery()" style="margin-left:8px;">ì „ì²´ì„ íƒ</button>
                <button class="btn danger" id="batchDeleteBtn" onclick="deleteSelectedGallery()" style="margin-left:8px;display:none;">ì„ íƒ ì‚­ì œ</button>-->
            </div>
            <div id="galleryGrid" class="gallery-grid"></div>
        </div>
        <div class="footer">
                            <p>&copy; 2025 MeArt. AI ì•„íŠ¸ ìƒì„±ê¸° by 4Dvision</p>
        </div>
    </div>
    <!-- ì¸ì¦ ëª¨ë‹¬ -->
    <div id="authModal" class="auth-modal" style="display:none;">
        <div class="auth-modal-content" style="max-width:350px;">
            <h2 id="authModalTitle">ë¡œê·¸ì¸</h2>
            <form id="authForm" class="auth-form">
                <input type="text" id="authUsername" placeholder="ì‚¬ìš©ìëª…" required>
                <input type="email" id="authEmail" placeholder="ì´ë©”ì¼" required>
                <input type="password" id="authPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
                <button type="submit" id="authSubmitBtn" class="btn">ë¡œê·¸ì¸</button>
            </form>
            <button onclick="closeAuthModal()" class="btn secondary" style="margin-top: 10px;">ì·¨ì†Œ</button>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    <!-- ê°¤ëŸ¬ë¦¬ ìƒì„¸ ëª¨ë‹¬: ê²°ê³¼ ì´ë¯¸ì§€ë§Œ ë³´ì—¬ì£¼ë„ë¡ ìˆ˜ì • -->
    <div id="galleryModal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close" onclick="closeGalleryModal()">&times;</span>
        <h3 id="modalTitle"></h3>
        <div style="display:flex;gap:24px;justify-content:center;">
          <div style="text-align:center;">
            <h4>ê²°ê³¼ ì´ë¯¸ì§€</h4>
            <img id="modalResult" style="max-width:420px;max-height:420px;">
          </div>
        </div>
        <p id="modalDate"></p>
      </div>
    </div>
    <script>
        let currentFile = null;
        let processedImageUrl = null;
        let currentUser = null;
        let authToken = null;
        let nobgBlob = null;
        let lastNobgPath = null; // ğŸ¯ ë§ˆì§€ë§‰ nobg íŒŒì¼ ê²½ë¡œ ì €ì¥
        let isBrushProcessing = false; // ğŸ¯ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì²˜ë¦¬ ì¤‘ ìƒíƒœ
        let pendingBrushUpdate = null; // ğŸ¯ ëŒ€ê¸° ì¤‘ì¸ ë¸ŒëŸ¬ì‹œ ì—…ë°ì´íŠ¸
        let currentEmotion = 'neutral'; // ğŸ¯ í˜„ì¬ ê°ì • ìƒíƒœ ì €ì¥
        let currentBackground = ''; // ğŸ¯ í˜„ì¬ ë°°ê²½ ì´ë¯¸ì§€ ê²½ë¡œ ì €ì¥

        // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        // Blobì„ Base64ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // ë°°ê²½ í•©ì„± í•¨ìˆ˜ (ì›ë³¸ ë¹„ìœ¨/í¬ê¸° ìœ ì§€)
        async function compositeBackground(foregroundImage, backgroundImage) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                const fgImg = new Image();
                const bgImg = new Image();

                fgImg.onload = function() {
                    // ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ì „ê²½(ì—…ë¡œë“œ ì›ë³¸) ì´ë¯¸ì§€ í¬ê¸°ë¡œ ê³ ì •
                    canvas.width = fgImg.naturalWidth;
                    canvas.height = fgImg.naturalHeight;

                    bgImg.onload = function() {
                        // ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œ ì›ë³¸ í¬ê¸°ë¡œ ë§ì¶°ì„œ ê·¸ë¦¼ (crop/stretch)
                        ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
                        // ë°°ê²½ ì œê±°ëœ ì–¼êµ´ ì´ë¯¸ì§€ë¥¼ (0,0)ì—ì„œ ì›ë³¸ í¬ê¸°ë¡œ ê·¸ë¦¼
                        ctx.drawImage(fgImg, 0, 0, canvas.width, canvas.height);

                        // ê²°ê³¼ë¥¼ Base64ë¡œ ë³€í™˜
                        const result = canvas.toDataURL('image/png');
                        resolve(result);
                    };
                    bgImg.onerror = () => reject(new Error('ë°°ê²½ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨'));
                    bgImg.src = backgroundImage;
                };
                fgImg.onerror = () => reject(new Error('ì „ê²½ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨'));
                fgImg.src = foregroundImage;
            });
        }



        // DOM ìš”ì†Œë“¤
        // const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview'); // ì‚­ì œëœ ìš”ì†Œ - nullì´ ë  ìˆ˜ ìˆìŒ
        const originalImage = document.getElementById('originalImage'); // ì‚­ì œëœ ìš”ì†Œ - nullì´ ë  ìˆ˜ ìˆìŒ
        const processedImage = document.getElementById('processedImage'); // ì‚­ì œëœ ìš”ì†Œ - nullì´ ë  ìˆ˜ ìˆìŒ
        const controls = document.getElementById('controls');
        const loading = document.getElementById('loading');
        const message = document.getElementById('message');
        const resultSection = document.getElementById('resultSection');
        const previewImage = document.getElementById('previewImage');
        const brushResultSection = document.getElementById('brushResultSection');
        const brushResultImage = document.getElementById('brushResultImage');
        const downloadLink = document.getElementById('downloadLink');
        const emotionFeedback = document.getElementById('emotionFeedback');
        const emotionIcon = document.getElementById('emotionIcon');
        const emotionTitle = document.getElementById('emotionTitle');
        const emotionMessage = document.getElementById('emotionMessage');

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        // uploadArea.addEventListener('click', () => fileInput.click());
        // uploadArea.addEventListener('dragover', handleDragOver);
        // uploadArea.addEventListener('dragleave', handleDragLeave);
        // uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);

        // function handleDragOver(e) {
        //     e.preventDefault();
        //     uploadArea.classList.add('dragover');
        // }

        // function handleDragLeave(e) {
        //     e.preventDefault();
        //     uploadArea.classList.remove('dragover');
        // }

        // function handleDrop(e) {
        //     e.preventDefault();
        //     uploadArea.classList.remove('dragover');
        //     const files = e.dataTransfer.files;
        //     if (files.length > 0) {
        //         handleFile(files[0]);
        //     }
        // }

        // ëª¨ë°”ì¼ ìµœì í™”ëœ ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ í•¨ìˆ˜ (ì„±ëŠ¥ ê°œì„ )
        async function resizeImageIfMobile(file, maxSize = 800) {
            if (!isMobileDevice()) return file;
            
            // íŒŒì¼ í¬ê¸°ê°€ ì´ë¯¸ ì‘ìœ¼ë©´ ë¦¬ì‚¬ì´ì¦ˆ ìƒëµ
            if (file.size < 500 * 1024) return file; // 500KB ë¯¸ë§Œì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            
            return new Promise((resolve) => {
                const img = new Image();
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    img.onload = () => {
                        let { width, height } = img;
                        
                        // ì´ë¯¸ ì ì ˆí•œ í¬ê¸°ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                        if (width <= maxSize && height <= maxSize) {
                            resolve(file);
                return;
            }
                        
                        // ë¹„ìœ¨ ìœ ì§€í•˜ë©° ë¦¬ì‚¬ì´ì¦ˆ
                        const scale = Math.min(maxSize / width, maxSize / height);
                        width = Math.round(width * scale);
                        height = Math.round(height * scale);
                        
                        // ì˜¤í”„ìŠ¤í¬ë¦° ìº”ë²„ìŠ¤ ì‚¬ìš© (ì„±ëŠ¥ ê°œì„ )
                        let canvas;
                        if (typeof OffscreenCanvas !== 'undefined') {
                            canvas = new OffscreenCanvas(width, height);
                        } else {
                            canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                        }
                        
                        const ctx = canvas.getContext('2d');
                        // ì´ë¯¸ì§€ í’ˆì§ˆ ì„¤ì • (ëª¨ë°”ì¼ ìµœì í™”)
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'medium';
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // ì••ì¶•ë¥  ì¡°ì • (ëª¨ë°”ì¼: ë” ë†’ì€ ì••ì¶•)
                        const quality = file.size > 2 * 1024 * 1024 ? 0.7 : 0.85; // 2MB ì´ìƒì´ë©´ ë” ì••ì¶•
                        
                        // OffscreenCanvas ë˜ëŠ” ì¼ë°˜ Canvasì— ë”°ë¥¸ blob ìƒì„±
                        if (typeof OffscreenCanvas !== 'undefined' && canvas instanceof OffscreenCanvas) {
                            canvas.convertToBlob({ type: 'image/jpeg', quality }).then(blob => {
                                const resizedFile = new File([blob], file.name, { type: 'image/jpeg' });
                                console.log(`ğŸ“± ëª¨ë°”ì¼ ë¦¬ì‚¬ì´ì¦ˆ (OffscreenCanvas): ${file.size} â†’ ${resizedFile.size} bytes`);
                                resolve(resizedFile);
                            });
                        } else {
                            canvas.toBlob((blob) => {
                                const resizedFile = new File([blob], file.name, { type: 'image/jpeg' });
                                console.log(`ğŸ“± ëª¨ë°”ì¼ ë¦¬ì‚¬ì´ì¦ˆ (Canvas): ${file.size} â†’ ${resizedFile.size} bytes`);
                                resolve(resizedFile);
                            }, 'image/jpeg', quality);
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // handleFileSelectë¥¼ asyncë¡œ ë³€ê²½í•˜ì—¬ ë¦¬ì‚¬ì´ì¦ˆ ì ìš©
        async function handleFileSelect(e) {
            let file = e.target.files[0];
            if (file) {
                file = await resizeImageIfMobile(file);
                handleFile(file);
            }
        }

        // FileReader.readAsDataURL, URL.createObjectURL ë“± data: URL, blob: URL ì‚¬ìš© ë¶€ë¶„ì„ ëª¨ë‘ ì œê±°
        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°, í•©ì„± ë“± ëª¨ë“  ë‹¨ê³„ì—ì„œ processedImageUrl(ì„œë²„ URL)ë§Œ ì‚¬ìš©

        function handleFile(file) {
            // ğŸ”§ ëª¨ë°”ì¼ì—ì„œ ì‚¬ì§„ ì´¬ì˜ í›„ ì¸íŠ¸ë¡œ í™”ë©´ ì™„ì „íˆ ìˆ¨ê¸°ê³  ë©”ì¸ í™”ë©´ í‘œì‹œ
            const introScreen = document.getElementById('introScreen');
            const mainContainer = document.getElementById('mainContainer');
            const splashScreen = document.getElementById('splashScreen');
            
            console.log('ğŸ“± íŒŒì¼ ì²˜ë¦¬ ì‹œì‘ - í™”ë©´ ìƒíƒœ ê°•ì œ ì „í™˜');
            
            // ëª¨ë“  ì˜¤ë²„ë ˆì´ í™”ë©´ ê°•ì œë¡œ ìˆ¨ê¸°ê¸°
            if (splashScreen) {
                splashScreen.style.display = 'none !important';
                splashScreen.style.visibility = 'hidden';
                splashScreen.style.zIndex = '-1';
            }
            
            if (introScreen) {
                introScreen.style.display = 'none !important';
                introScreen.style.visibility = 'hidden';
                introScreen.style.zIndex = '-9999';
                introScreen.style.position = 'absolute';
                introScreen.style.top = '-9999px';
                introScreen.classList.add('hidden-force');
                console.log('âœ… ì¸íŠ¸ë¡œ í™”ë©´ ì™„ì „íˆ ìˆ¨ê¹€');
            }
            
            if (mainContainer) {
                mainContainer.style.display = 'block !important';
                mainContainer.style.visibility = 'visible';
                mainContainer.style.zIndex = '1';
                mainContainer.style.position = 'relative';
                console.log('âœ… ë©”ì¸ í™”ë©´ ê°•ì œ í‘œì‹œ');
            }
            
            // ì•½ê°„ì˜ ì§€ì—° í›„ ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸
            setTimeout(() => {
                if (introScreen) {
                    introScreen.style.display = 'none !important';
                    introScreen.style.visibility = 'hidden !important';
                    introScreen.classList.add('hidden-force');
                    console.log('ğŸ”„ ì§€ì—° í›„ ì¸íŠ¸ë¡œ í™”ë©´ ì™„ì „ ìˆ¨ê¹€ ì¬í™•ì¸');
                }
                if (mainContainer) {
                    mainContainer.style.display = 'block !important';
                    mainContainer.style.visibility = 'visible !important';
                    console.log('ğŸ”„ ì§€ì—° í›„ ë©”ì¸ í™”ë©´ í‘œì‹œ ì¬í™•ì¸');
                }
            }, 100);
            
            // ì¶”ê°€ ì•ˆì „ ì¥ì¹˜: 500ms í›„ì—ë„ ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸
            setTimeout(() => {
                if (introScreen) {
                    introScreen.classList.add('hidden-force');
                    console.log('ğŸ”’ ìµœì¢… ì•ˆì „ ì¥ì¹˜: ì¸íŠ¸ë¡œ í™”ë©´ ì™„ì „ ìˆ¨ê¹€');
                }
            }, 500);
            
            if (!file.type.startsWith('image/')) {
                showMessage('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                showMessage('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            currentFile = file;
            // ë¯¸ë¦¬ë³´ê¸°ëŠ” ì„œë²„ URLì´ ë°˜í™˜ëœ í›„ì—ë§Œ ë„ì›€ (data: URL ì‚¬ìš© ê¸ˆì§€)
            if (imagePreview) imagePreview.style.display = 'none';
            if (controls) controls.style.display = 'none';
            if (resultSection) resultSection.style.display = 'none';
            if (processedImage) processedImage.style.display = 'none';
                hideMessage();
                // ìë™ìœ¼ë¡œ ë°°ê²½ ì œê±°, ê°ì • ë¶„ì„, ëª…í™” ì¶”ì²œ ì‹¤í–‰
                processImageAutomatically();
        }

        async function processImageAutomatically() {
            if (!currentFile) return;

            showLoading(true);
            hideMessage();

            try {
                // 1. ë°°ê²½ ì œê±° (êµì°© ë°©ì§€ ê°•í™”)
                console.log('ğŸ”„ 1ë‹¨ê³„: ë°°ê²½ ì œê±° ì‹œì‘');
                const bgResult = await removeBackgroundInternal();
                
                if (bgResult && bgResult.ok) {
                    console.log('âœ… ë°°ê²½ ì œê±° ì„±ê³µ');
                } else {
                    console.warn('âš ï¸ ë°°ê²½ ì œê±° ì‹¤íŒ¨:', bgResult?.reason || 'unknown error');
                    if (bgResult?.fallback) {
                        console.log('ğŸ”„ ì›ë³¸ ì´ë¯¸ì§€ë¡œ ê³„ì† ì§„í–‰');
                        // ì›ë³¸ ì´ë¯¸ì§€ë¥¼ processedImageUrlë¡œ ì„¤ì •
                        const originalUrl = URL.createObjectURL(currentFile);
                        processedImageUrl = originalUrl;
                        if (processedImage) {
                            processedImage.src = originalUrl;
                            processedImage.style.display = 'block';
                        }
                        // nobgBlobë„ ì›ë³¸ìœ¼ë¡œ ì„¤ì • (í•©ì„± ì‹œ ì‚¬ìš©)
                        nobgBlob = currentFile;
                        // ì¬ì‹œë„ ë²„íŠ¼ í‘œì‹œ
                        showMessage('ë°°ê²½ ì œê±°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì›ë³¸ ì´ë¯¸ì§€ë¡œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.', 'warning');
                        const retryBtn = document.getElementById('retryBgRemovalBtn');
                        if (retryBtn) retryBtn.style.display = 'inline-flex';
                    }
                }

                // 2. ê°ì • ë¶„ì„ (êµì°© ë°©ì§€)
                console.log('ğŸ”„ 2ë‹¨ê³„: ê°ì • ë¶„ì„ ì‹œì‘');
                const emotionResult = await analyzeEmotionInternal();
                if (!emotionResult) {
                    console.warn('âš ï¸ ê°ì • ë¶„ì„ ì‹¤íŒ¨ â€” ê¸°ë³¸ê°’ ì‚¬ìš©');
                    // êµì°© ë°©ì§€: ê°ì • ë¶„ì„ ì‹¤íŒ¨í•´ë„ ê¸°ë³¸ê°’ ì‚¬ìš©
                }

                // 3. ëª…í™” ì¶”ì²œ (êµì°© ë°©ì§€)
                console.log('ğŸ”„ 3ë‹¨ê³„: ëª…í™” ì¶”ì²œ ì‹œì‘');
                const detectedEmotion = emotionResult?.emotion || currentEmotion || 'neutral';
                console.log('ğŸ¯ ì‚¬ìš©í•  ê°ì •:', detectedEmotion);
                
                try {
                    await recommendArtworks(detectedEmotion);
                } catch (e) {
                    console.warn('âš ï¸ ëª…í™” ì¶”ì²œ ì‹¤íŒ¨:', e.message);
                }
                
                // 4. ìë™ í•©ì„± (êµì°© ë°©ì§€)
                console.log('ğŸ”„ 4ë‹¨ê³„: ìë™ í•©ì„± ì‹œì‘');
                const key = mapEmotionKey(detectedEmotion);
                const artworks = ARTWORKS_BY_EMOTION[key];
                if (artworks && artworks.length > 0) {
                    const firstArtwork = artworks[0];
                    try {
                        await applyComposite(firstArtwork.id, firstArtwork.image);
                    } catch (e) {
                        console.warn('âš ï¸ ìë™ í•©ì„± ì‹¤íŒ¨:', e.message);
                        showMessage('ìë™ í•©ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
                    }
                }

            } catch (error) {
                console.error('âŒ processImageAutomatically ì˜¤ë¥˜:', error);
                showMessage('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
            } finally {
                showLoading(false);
            }
        }

        // checkServerStatus: êµì°© ë°©ì§€ ë¡œì§ìœ¼ë¡œ ìˆ˜ì •
        async function checkServerStatus(base = '') {
            const url = (base ? base.replace(/\/$/, '') : '') + '/api/status?t=' + Date.now();
            try {
                const res = await fetch(url, { cache: 'no-store' });
                if (res.status === 404) {
                    console.warn('âš ï¸ /api/status endpoint missing (404) â€” degraded mode');
                    return null;
                }
                if (!res.ok) {
                    console.warn(`âš ï¸ /api/status error ${res.status} â€” degraded mode`);
                    return null;
                }
                const json = await res.json();
                // AI ë¹„í™œì„±ì€ ì •ë³´ ìˆ˜ì¤€ (ì•± ì°¨ë‹¨í•˜ì§€ ì•ŠìŒ)
                if (json?.ai && !json.ai.ready) {
                    console.info(`â„¹ï¸ AI not ready: ${json.ai.provider} (${json.ai.ready})`);
                }
                return json;
            } catch (e) {
                console.warn('âš ï¸ checkServerStatus failed:', e.message, 'â€” degraded mode');
                return null; // ì•± ë¶€íŠ¸ëŠ” ê³„ì†
            }
        }

        // callAnalyzeEmotion: ê°ì • ë¶„ì„ API í˜¸ì¶œ (ê²½ë¡œ fallback ì§€ì›)
        async function callAnalyzeEmotion({ base = '', file, imageBase64 }) {
            const urlPrimary = (base.replace(/\/$/, '') || '') + '/api/analyze-emotion';
            const urlFallback = (base.replace(/\/$/, '') || '') + '/analyze-emotion';

            const doPost = async (url) => {
                let res;
                if (file) {
                    const fd = new FormData(); fd.append('image', file);
                    res = await fetch(url, { method: 'POST', body: fd });
                } else {
                    res = await fetch(url, {
                        method: 'POST',
                        headers: { 'content-type': 'application/json', 'accept': 'application/json' },
                        body: JSON.stringify({ imageBase64 })
                    });
                }
                const text = await res.text();
                try {
                    const json = JSON.parse(text);
                    if (!res.ok || json?.ok === false) throw new Error(json?.error || `analyze-emotion ${res.status}`);
                    return json;
                } catch {
                    throw new Error(`analyze-emotion non-JSON (${res.status}): ${text.slice(0, 180)}`);
                }
            };

            try { return await doPost(urlPrimary); }
            catch (e1) { if (/404/.test(String(e1))) return await doPost(urlFallback); throw e1; }
        }

        // waitForReady: êµì°© ë°©ì§€ ë¡œì§ìœ¼ë¡œ ìˆ˜ì •
        async function waitForReady({ base = '', maxWaitMs = 60000, baseDelay = 300 } = {}) {
            const target = (base ? base.replace(/\/$/, '') : '') + '/readyz';
            const start = Date.now(); 
            let attempt = 0; 
            let last = '';
            
            console.log('ğŸ”„ ì„œë²„ ì¤€ë¹„ ìƒíƒœ í™•ì¸ ì‹œì‘:', target);
            
            while (Date.now() - start < maxWaitMs) {
                try {
                    const res = await fetch(`${target}?t=${Date.now()}`, { cache: 'no-store' });
                    if (res.status === 200) {
                        console.log('âœ… ì„œë²„ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        return true;
                    }
                    last = `status ${res.status}`;
                } catch (e) { 
                    last = e?.message || 'network error'; 
                }
                
                const delay = Math.min(2500, baseDelay * Math.pow(2, attempt++));
                const elapsed = Math.floor((Date.now() - start) / 1000);
                
                console.log(`â³ ì„œë²„ ì¤€ë¹„ ì¤‘... (${attempt}íšŒ, ${elapsed}ì´ˆ ê²½ê³¼, ${last})`);
                
                await new Promise(r => setTimeout(r, delay));
            }
            
            // êµì°© ë°©ì§€: íƒ€ì„ì•„ì›ƒ ì‹œ false ë°˜í™˜ (ì—ëŸ¬ ë˜ì§€ì§€ ì•ŠìŒ)
            console.warn('âš ï¸ ì„œë²„ ì¤€ë¹„ íƒ€ì„ì•„ì›ƒ â€” degraded modeë¡œ ì§„í–‰');
            return false;
        }

        async function removeBackgroundInternal() {
            try {
                console.log('ğŸ”„ ìƒˆë¡œìš´ API í•¨ìˆ˜ë¡œ ë°°ê²½ ì œê±° ì‹œì‘');
                
                // ìƒˆë¡œìš´ API í•¨ìˆ˜ ì‚¬ìš©
                if (window.callRemoveBg) {
                    const response = await window.callRemoveBg({ file: currentFile });
                    
                    if (response && response.ok !== false) {
                        processedImageUrl = response.processedImageUrl || response.url;
                        if (processedImage) {
                            processedImage.src = processedImageUrl;
                            processedImage.style.display = 'block';
                        }
                        
                        // ì„œë²„ íŒŒì¼ URLì—ì„œ blobì„ ë‹¤ì‹œ ë°›ì•„ì„œ nobgBlob ì„¸íŒ…
                        try {
                            const blobResp = await fetch(processedImageUrl, { cache: 'reload' });
                            let contentType = blobResp.headers.get('content-type');
                            if (!contentType || !contentType.startsWith('image/')) {
                                // ì¬ì‹œë„
                                const retryResp = await fetch(processedImageUrl, { cache: 'no-store' });
                                contentType = retryResp.headers.get('content-type');
                                if (contentType && contentType.startsWith('image/')) {
                                    nobgBlob = await retryResp.blob();
                                } else {
                                    console.warn('âš ï¸ ë°°ê²½ ì œê±° ê²°ê³¼ê°€ ì´ë¯¸ì§€ê°€ ì•„ë‹˜ â€” ì›ë³¸ ì‚¬ìš©');
                                    return { ok: false, reason: 'invalid image response', fallback: true };
                                }
                            } else {
                                nobgBlob = await blobResp.blob();
                            }
                            return { ok: true, data: response };
                        } catch (blobError) {
                            console.warn('âš ï¸ blob ì²˜ë¦¬ ì‹¤íŒ¨:', blobError.message);
                            return { ok: false, reason: blobError.message, fallback: true };
                        }
                    } else {
                        console.warn('âš ï¸ remove-bg ì‘ë‹µì´ ì„±ê³µì´ ì•„ë‹˜:', response);
                        return { ok: false, reason: 'api response not ok', fallback: true };
                    }
                } else {
                    console.warn('âš ï¸ window.callRemoveBg í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ â€” í´ë°± ëª¨ë“œ');
                    return { ok: false, reason: 'API function not available', fallback: true };
                }
            } catch (error) {
                console.error('âŒ removeBackgroundInternal ì˜¤ë¥˜:', error);
                return { ok: false, reason: error.message, fallback: true };
            }
        }

        async function analyzeEmotionInternal() {
            try {
                console.log('ğŸ”„ ìƒˆë¡œìš´ API í•¨ìˆ˜ë¡œ ê°ì • ë¶„ì„ ì‹œì‘');
                
                // ìƒˆë¡œìš´ API í•¨ìˆ˜ ì‚¬ìš©
                if (window.callAnalyzeEmotion) {
                    const result = await window.callAnalyzeEmotion({ file: currentFile });
                    
                    if (result && result.emotion) {
                        // ğŸ¯ í˜„ì¬ ê°ì • ì •ë³´ ì €ì¥
                        currentEmotion = result.emotion;
                        console.log('ğŸ˜Š í˜„ì¬ ê°ì • ì—…ë°ì´íŠ¸:', currentEmotion);
                        
                        // ê°ì • í”¼ë“œë°± í‘œì‹œ (ì„ íƒì )
                        if (result.feedback) {
                            showEmotionFeedback(result.emotion, result.feedback);
                        }
                        return result;
                    } else {
                        console.warn('âš ï¸ ê°ì • ë¶„ì„ ê²°ê³¼ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŒ:', result);
                        return null;
                    }
                } else {
                    console.warn('âš ï¸ window.callAnalyzeEmotion í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ â€” í´ë°± ëª¨ë“œ');
                    return null;
                }
            } catch (error) {
                console.warn('âš ï¸ ê°ì • ë¶„ì„ ì‹¤íŒ¨:', error.message);
                // êµì°© ë°©ì§€: ì—ëŸ¬ë¥¼ ë˜ì§€ì§€ ì•Šê³  null ë°˜í™˜
                return null;
            }
        }

        // ê°ì •ë³„ ëª…í™” ë°ì´í„° (ë°±ì—”ë“œì™€ ë™ì¼í•˜ê²Œ ì‹¤ì œ ì´ë¯¸ì§€/íƒ€ì´í‹€/ì‘ê°€/ìŠ¤íƒ€ì¼ ì •ë³´ë¡œ ì±„ì›€)
        const ARTWORKS_BY_EMOTION = {
            happy: [
                {
                    id: 'hampton',
                    title: 'ì´ˆë¡ì •ì›',
                    artist: 'hampton',
                    image: '/BG_image/hampton_court_green_1970.17.53.jpg'
                },
                {
                    id: 'normandy',
                    title: 'ë…¸ë¥´ë§ë”” í•´ë³€',
                    artist: 'bessin',
                    image: '/BG_image/seascape_at_port-en-bessin_normandy_1972.9.21.jpg'
                },
                {
                    id: 'farmhouse_provence',
                    title: 'í”„ë¡œë°©ìŠ¤ì˜ ë†ê°€',
                    artist: 'Vincent van Gogh',
                    image: '/BG_image/farmhouse_in_provence_1970.17.34.jpg'
                },
                {
                    id: 'harbor_lorient',
                    title: 'ë¡œë¦¬ì•™ í•­êµ¬',
                    artist: 'Berthe Morisot',
                    image: '/BG_image/the_harbor_at_lorient_1970.17.48.jpg'
                }
            ],
            sad: [
                {
                    id: 'hampton',
                    title: 'ì´ˆë¡ì •ì›',
                    artist: 'hampton',
                    image: '/BG_image/hampton_court_green_1970.17.53.jpg'
                },
                {
                    id: 'normandy',
                    title: 'ë…¸ë¥´ë§ë”” í•´ë³€',
                    artist: 'bessin',
                    image: '/BG_image/seascape_at_port-en-bessin_normandy_1972.9.21.jpg'
                },
                {
                    id: 'farmhouse_provence',
                    title: 'í”„ë¡œë°©ìŠ¤ì˜ ë†ê°€',
                    artist: 'Vincent van Gogh',
                    image: '/BG_image/farmhouse_in_provence_1970.17.34.jpg'
                },
                {
                    id: 'harbor_lorient',
                    title: 'ë¡œë¦¬ì•™ í•­êµ¬',
                    artist: 'Berthe Morisot',
                    image: '/BG_image/the_harbor_at_lorient_1970.17.48.jpg'
                }
            ],
            angry: [
                {
                    id: 'hampton',
                    title: 'ì´ˆë¡ì •ì›',
                    artist: 'hampton',
                    image: '/BG_image/hampton_court_green_1970.17.53.jpg'
                },
                {
                    id: 'normandy',
                    title: 'ë…¸ë¥´ë§ë”” í•´ë³€',
                    artist: 'bessin',
                    image: '/BG_image/seascape_at_port-en-bessin_normandy_1972.9.21.jpg'
                },
                {
                    id: 'farmhouse_provence',
                    title: 'í”„ë¡œë°©ìŠ¤ì˜ ë†ê°€',
                    artist: 'Vincent van Gogh',
                    image: '/BG_image/farmhouse_in_provence_1970.17.34.jpg'
                },
                {
                    id: 'harbor_lorient',
                    title: 'ë¡œë¦¬ì•™ í•­êµ¬',
                    artist: 'Berthe Morisot',
                    image: '/BG_image/the_harbor_at_lorient_1970.17.48.jpg'
                }
            ],
            surprised: [
                {
                    id: 'hampton',
                    title: 'ì´ˆë¡ì •ì›',
                    artist: 'hampton',
                    image: '/BG_image/hampton_court_green_1970.17.53.jpg'
                },
                {
                    id: 'normandy',
                    title: 'ë…¸ë¥´ë§ë”” í•´ë³€',
                    artist: 'bessin',
                    image: '/BG_image/seascape_at_port-en-bessin_normandy_1972.9.21.jpg'
                },
                {
                    id: 'farmhouse_provence',
                    title: 'í”„ë¡œë°©ìŠ¤ì˜ ë†ê°€',
                    artist: 'Vincent van Gogh',
                    image: '/BG_image/farmhouse_in_provence_1970.17.34.jpg'
                },
                {
                    id: 'harbor_lorient',
                    title: 'ë¡œë¦¬ì•™ í•­êµ¬',
                    artist: 'Berthe Morisot',
                    image: '/BG_image/the_harbor_at_lorient_1970.17.48.jpg'
                }
            ],
            neutral: [
                {
                    id: 'hampton',
                    title: 'ì´ˆë¡ì •ì›',
                    artist: 'hampton',
                    image: '/BG_image/hampton_court_green_1970.17.53.jpg'
                },
                {
                    id: 'normandy',
                    title: 'ë…¸ë¥´ë§ë”” í•´ë³€',
                    artist: 'bessin',
                    image: '/BG_image/seascape_at_port-en-bessin_normandy_1972.9.21.jpg'
                },
                {
                    id: 'farmhouse_provence',
                    title: 'í”„ë¡œë°©ìŠ¤ì˜ ë†ê°€',
                    artist: 'Vincent van Gogh',
                    image: '/BG_image/farmhouse_in_provence_1970.17.34.jpg'
                },
                {
                    id: 'harbor_lorient',
                    title: 'ë¡œë¦¬ì•™ í•­êµ¬',
                    artist: 'Berthe Morisot',
                    image: '/BG_image/the_harbor_at_lorient_1970.17.48.jpg'
                }
            ]
        };

        // ê°ì • ë¶„ì„ ê²°ê³¼ì˜ emotion ê°’ì„ íƒ­ í‚¤ë¡œ ë³€í™˜
        function mapEmotionKey(emotion) {
            if (emotion === 'happiness' || emotion === 'happy') return 'happy';
            if (emotion === 'sadness' || emotion === 'sad') return 'sad';
            if (emotion === 'anger' || emotion === 'angry') return 'angry';
            if (emotion === 'surprise' || emotion === 'surprised') return 'surprised';
            if (emotion === 'neutral') return 'neutral';
            // fallback
            return 'neutral';
        }

        // recommendArtworks í•¨ìˆ˜ì—ì„œ ê°ì • ë¶„ì„ ê²°ê³¼ë¡œ ìë™ ì„ íƒ
        async function recommendArtworks(emotion) {
            console.log('ğŸ¨ ëª…í™” ì¶”ì²œ ìš”ì²­ - ì…ë ¥ ê°ì •:', emotion);
            const key = mapEmotionKey(emotion);
            console.log('ğŸ¨ ë§¤í•‘ëœ ê°ì • í‚¤:', key);
            console.log('ğŸ¨ í•´ë‹¹ ê°ì •ì˜ ëª…í™” ëª©ë¡:', ARTWORKS_BY_EMOTION[key]);
            displayArtworkRecommendations(ARTWORKS_BY_EMOTION[key], key);
        }

        function displayArtworkRecommendations(artworks, emotion) {
            const emotionText = {
                'happy': 'ê¸°ì¨',
                'happiness': 'ê¸°ì¨',
                'sad': 'ìŠ¬í””',
                'sadness': 'ìŠ¬í””',
                'angry': 'ë¶„ë…¸',
                'anger': 'ë¶„ë…¸',
                'surprised': 'ë†€ëŒ',
                'surprise': 'ë†€ëŒ',
                'fear': 'ë‘ë ¤ì›€',
                'disgust': 'í˜ì˜¤',
                'neutral': 'ì¤‘ë¦½'
            };

            const container = document.getElementById('artworkRecommendationsContainer');
            
            // ì„œë²„ì—ì„œ ë°›ì€ ìƒˆë¡œìš´ í˜•ì‹ ì§€ì›
            if (artworks && artworks.length > 0 && artworks[0].thumbnail) {
                console.log('ğŸ¨ ì¸ë„¤ì¼ ê¸°ë°˜ ëª…í™” ì¶”ì²œ í‘œì‹œ:', artworks);
                container.innerHTML = `
                    <div class="artwork-recommendations">
                        <h3>ğŸ¨ ${emotionText[emotion] || emotion}ì— ì–´ìš¸ë¦¬ëŠ” ëª…í™” ì¶”ì²œ</h3>
                        <div class="artwork-grid">
                            ${artworks.map((artwork, index) => `
                                <div class="artwork-item" onclick="selectArtworkByPath('${artwork.path}')">
                                    <img src="${artwork.thumbnail}" 
                                         alt="${artwork.title}" 
                                         class="artwork-thumbnail loading"
                                         loading="lazy"
                                         data-original="${artwork.path}"
                                         data-thumbnail="${artwork.thumbnail}"
                                         onerror="handleThumbnailError(this, '${artwork.path}')"
                                         onload="handleThumbnailLoad(this)"
                                         ondblclick="loadOriginalImage(this, '${artwork.path}')">
                                    <div class="artwork-info">
                                        <h4>${artwork.title}</h4>
                                        <p>${artwork.artist}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <p style="text-align: center; color: var(--text-tertiary); font-size: 0.75rem; margin-top: var(--space-sm);">
                            ğŸ’¡ ëª…í™”ë¥¼ ë”ë¸”í´ë¦­í•˜ë©´ ê³ í•´ìƒë„ ì´ë¯¸ì§€ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤
                        </p>
                    </div>
                `;
            } else if (artworks && artworks.length > 0) {
                // ê¸°ì¡´ í˜•ì‹ ì§€ì› (í•˜ìœ„ í˜¸í™˜ì„±)
                console.log('ğŸ¨ ê¸°ì¡´ í˜•ì‹ ëª…í™” ì¶”ì²œ í‘œì‹œ:', artworks);
                container.innerHTML = `
                    <div class="artwork-recommendations">
                        <h3>ğŸ¨ ${emotionText[emotion] || emotion}ì— ì–´ìš¸ë¦¬ëŠ” ëª…í™” ì¶”ì²œ</h3>
                        <div class="artwork-grid">
                            ${artworks.map(artwork => `
                                <div class="artwork-item" onclick="selectArtwork('${artwork.id}', '${artwork.image}')">
                                    <img src="${artwork.image}" alt="${artwork.title}" class="artwork-thumbnail" loading="lazy">
                                    <div class="artwork-info">
                                        <h4>${artwork.title}</h4>
                                        <p>${artwork.artist}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                console.log('ğŸ¨ ëª…í™” ì¶”ì²œ ë°ì´í„° ì—†ìŒ');
                container.innerHTML = `
                    <div class="artwork-recommendations">
                        <h3>ğŸ¨ ${emotionText[emotion] || emotion}ì— ì–´ìš¸ë¦¬ëŠ” ëª…í™”</h3>
                        <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            ì¶”ì²œí•  ëª…í™”ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
                        </p>
                    </div>
                `;
            }
        }

        // 1ë‹¨ê³„: ì „ê²½ + ë°°ê²½ í•©ì„± (ë°°ê²½ ì œê±° ì„ í–‰ì¡°ê±´ ì œê±°)
        async function applyComposite(artworkId, backgroundImage) {
            console.log('ğŸ¨ í•©ì„± ì‹œì‘:', { artworkId, backgroundImage });
            
            // ğŸ”§ ìƒíƒœ ê´€ë¦¬: ì›ë³¸ ì´ë¯¸ì§€ì™€ ë°°ê²½ ì œê±°ëœ ì´ë¯¸ì§€ ì¤‘ ì„ íƒ
            let originalBase64 = null;
            let bgRemovedBase64 = null;
            
            // ì›ë³¸ ì´ë¯¸ì§€ ì¤€ë¹„
            if (currentFile) {
                originalBase64 = await fileToBase64(currentFile);
                console.log('âœ… ì›ë³¸ ì´ë¯¸ì§€ ì¤€ë¹„:', currentFile.name, currentFile.size);
            }
            
            // ë°°ê²½ ì œê±°ëœ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì›ë³¸ ì‚¬ìš©
            if (nobgBlob) {
                bgRemovedBase64 = await blobToBase64(nobgBlob);
                console.log('âœ… ë°°ê²½ ì œê±°ëœ ì´ë¯¸ì§€ ì‚¬ìš©');
            } else {
                console.log('âš ï¸ ë°°ê²½ ì œê±°ëœ ì´ë¯¸ì§€ ì—†ìŒ â€” ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©');
            }
            
            // ğŸ”§ í•„ìˆ˜ ë°ì´í„° ê²€ì¦
            if (!originalBase64) {
                showMessage('ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            if (!backgroundImage) {
                showMessage('ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            showLoading(true);
            hideMessage();

            previewImage.src = '';
            previewImage.style.background = 'url(/spinner.svg) center center no-repeat';
            previewImage.style.minHeight = '120px';

            try {
                // ğŸ”§ ìƒˆë¡œìš´ í•©ì„± API í˜¸ì¶œ (3ì´ˆ í´ë°± í¬í•¨)
                const fgBase64 = bgRemovedBase64 || originalBase64;
                const bgKey = backgroundImage.replace('/BG_image/', '');
                
                console.log('ğŸ¨ í•©ì„± API í˜¸ì¶œ:', { 
                    hasBgRemoved: !!bgRemovedBase64, 
                    bgKey, 
                    mode: 'contain' 
                });
                
                window.__HUD && __HUD('composite:start');
                const t0 = Date.now();
                
                const result = await Promise.race([
                    window.callComposite({
                        fgBase64: fgBase64,
                        bgKey: bgKey,
                        mode: 'contain',
                        out: 'png'
                    }),
                    new Promise((_, rej) => setTimeout(() => rej(new Error('timeout:composite>3s')), 3000))
                ]);
                
                window.__HUD && __HUD(`composite:ok ${Date.now()-t0}ms`);
                
                console.log('ğŸ¨ í•©ì„± API ì‘ë‹µ:', result);
                
                if (result.ok && result.compositeBase64) {
                    console.log('âœ… í•©ì„± ì„±ê³µ:', result.meta);
                    
                    // ğŸ¯ ì›ìì  ì»¤ë°‹ìœ¼ë¡œ ë¯¸ë¦¬ë³´ê¸° ë°˜ì˜
                    window.__lastCompositeResult = result;
                    window.__originalBase64 = originalBase64;
                    
                    (async () => {
                        try {
                            // ì„œë²„ê°€ ì–´ë–¤ í‚¤ë¥¼ ì£¼ë“  ì•ˆì „í•˜ê²Œ ì„ íƒ
                            const compositeSrc =
                                result?.compositeBase64 ||
                                result?.fgImage ||    // í˜„ì¬ ì½˜ì†” ë¡œê·¸ì— ì¡´ì¬
                                result?.resultBase64 ||
                                (typeof result === 'string' && result.startsWith('data:') ? result : null);

                            const ok = await window.commitPreviewAtomic(compositeSrc);
                            if (!ok) {
                                console.warn('[flow] composite commit skipped, fallback to original');
                                // ì›ë³¸ìœ¼ë¡œë¼ë„ í™”ë©´ ì „í™˜
                                await window.commitPreviewAtomic(window.__originalBase64 || window?.state?.originalBase64);
                            }
                        } catch (e) {
                            console.error('[flow.commit.error]', e);
                            await window.commitPreviewAtomic(window.__originalBase64 || window?.state?.originalBase64);
                        }
                    })();
                    
                    // ğŸ¯ í•©ì„± ë©”íƒ€ë°ì´í„° ì €ì¥
                    lastNobgPath = result.compositeBase64;
                    console.log('ğŸ”„ í•©ì„± ê²°ê³¼ ì €ì¥:', result.compositeBase64.substring(0, 50) + '...');
                    previewImage.onload = () => {
                        const logMsg = result.imageBase64 ? 'Base64 ì´ë¯¸ì§€' : (result.processedImageUrl || result.url || 'unknown');
                        console.log('âœ… ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:', logMsg);
                        resultSection.style.display = 'block';
                        // ë¸ŒëŸ¬ì‰¬ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ìœ ì§€, ì—†ìœ¼ë©´ ìˆ¨ê¸°ê¸°
                        if (!brushResultImage.src || brushResultImage.src === '') {
                            brushResultSection.style.display = 'none';
                        }
                    };
                    
                    // ğŸ¯ ì—ëŸ¬ í•¸ë“¤ëŸ¬ ì œê±° - ì´ë¯¸ì§€ê°€ ì •ìƒì ìœ¼ë¡œ ë³´ì´ê³  ìˆìœ¼ë¯€ë¡œ ë¶ˆí•„ìš”í•œ ì—ëŸ¬ ë©”ì‹œì§€ ë°©ì§€
                    previewImage.onerror = () => {
                        console.log('âš ï¸ ì´ë¯¸ì§€ ë¡œë“œ ì´ë²¤íŠ¸ ì—ëŸ¬ (ë¬´ì‹œ)');
                    };
                    
                    // ğŸ¯ ê°ì • ë¶„ì„ ê²°ê³¼ í‘œì‹œ (ë³µì›)
                    if (result.emotion && result.feedback) {
                        // ğŸ¯ í˜„ì¬ ê°ì • ì •ë³´ ì €ì¥
                        currentEmotion = result.emotion;
                        console.log('ğŸ˜Š í˜„ì¬ ê°ì • ì—…ë°ì´íŠ¸ (ë°°ê²½ í•©ì„±):', currentEmotion);
                        showEmotionFeedback(result.emotion, result.feedback);
                    }
                    
                    // ğŸ¨ ìƒˆë¡œìš´ ì¸ë„¤ì¼ ê¸°ë°˜ ëª…í™” ì¶”ì²œ í‘œì‹œ
                    if (result.artworkRecommendations && result.artworkRecommendations.length > 0) {
                        console.log('ğŸ¨ ì„œë²„ì—ì„œ ë°›ì€ ì¸ë„¤ì¼ ê¸°ë°˜ ëª…í™” ì¶”ì²œ:', result.artworkRecommendations);
                        displayArtworkRecommendations(result.artworkRecommendations, result.emotion);
                        
                        // ì¸ë„¤ì¼ í”„ë¦¬ë¡œë”© ì‹œì‘
                        setTimeout(() => preloadThumbnails(result.artworkRecommendations), 100);
                    } else if (result.emotion) {
                        // ê¸°ì¡´ ë°©ì‹ í´ë°±
                        console.log('ğŸ¨ ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ëª…í™” ì¶”ì²œ í‘œì‹œ');
                        const emotionKey = {
                            'happiness': 'happy',
                            'sadness': 'sad',
                            'anger': 'angry',
                            'surprise': 'surprised',
                            'fear': 'neutral',
                            'disgust': 'neutral',
                            'neutral': 'neutral'
                        }[result.emotion] || 'neutral';
                        
                        if (ARTWORKS_BY_EMOTION[emotionKey]) {
                            displayArtworkRecommendations(ARTWORKS_BY_EMOTION[emotionKey], emotionKey);
                        }
                    }
                    
                    // ë¸ŒëŸ¬ì‰¬ íš¨ê³¼ ë²„íŠ¼ í‘œì‹œ
                    showBrushEffectButton(result.nobgPath, backgroundImage, result.emotion);
                    
                    // 1ë‹¨ê³„ ì™„ë£Œ ë©”ì‹œì§€
                    showMessage('ë°°ê²½ í•©ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì¸ë¬¼ë¸ŒëŸ¬ì‰¬íš¨ê³¼ë¥¼ ì ìš©í•´ë³´ì„¸ìš”.', 'success');
                } else {
                    throw new Error(result.error || 'ë°°ê²½ í•©ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('âŒ í•©ì„± ì‹¤íŒ¨:', error.message);
                window.__HUD && __HUD('composite:fail->fallback');
                
                // ğŸ”§ êµì°© ë°©ì§€: ì‹¤íŒ¨í•´ë„ ì›ë³¸ ì´ë¯¸ì§€ë¡œ ì¦‰ì‹œ ì§„í–‰
                if (originalBase64) {
                    console.log('ğŸ”„ ì›ë³¸ ì´ë¯¸ì§€ë¡œ ì¦‰ì‹œ ì§„í–‰');
                    previewImage.src = originalBase64;
                    previewImage.style.display = 'block';
                    lastNobgPath = originalBase64;
                    
                    showMessage('í•©ì„±ì— ì‹¤íŒ¨í•˜ì—¬ ì›ë³¸ ì´ë¯¸ì§€ë¡œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤. ì¬ì‹œë„ ê°€ëŠ¥.', 'warning');
                    
                    // ì¬ì‹œë„ ë²„íŠ¼ í‘œì‹œ
                    const retryBtn = document.getElementById('retryBgRemovalBtn');
                    if (retryBtn) retryBtn.style.display = 'inline-flex';
                } else {
                    showMessage('í•©ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                }
                
                previewImage.style.background = '';
                previewImage.style.minHeight = '';
            } finally {
                showLoading(false);
            }
        }

        // 2ë‹¨ê³„: ë¸ŒëŸ¬ì‰¬ íš¨ê³¼ ì ìš©
        async function applyBrushEffect(nobgPath, backgroundPath, emotion) {
            // ğŸ¯ ë§¤ê°œë³€ìˆ˜ ê²€ì¦
            if (!nobgPath || !backgroundPath) {
                showMessage(`ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì ìš©ì— í•„ìš”í•œ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. nobgPath: ${nobgPath}, backgroundPath: ${backgroundPath}`, 'error');
                return;
            }
            
            console.log('ğŸ¨ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì ìš© ì‹œì‘:', { nobgPath, backgroundPath, emotion });
            
            // ğŸ¯ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            if (isBrushProcessing) {
                console.log('â¸ï¸ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì²˜ë¦¬ ì¤‘ - ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ìœ¼ë¡œ ë“±ë¡');
                pendingBrushUpdate = { nobgPath, backgroundPath, emotion };
                return;
            }
            
            isBrushProcessing = true;
            showLoading(true);
            hideMessage();

            try {
                const requestData = {
                    nobgPath: nobgPath,
                    backgroundPath: backgroundPath,
                    emotion: emotion || 'neutral'
                };
                
                console.log('ğŸ¨ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ API ìš”ì²­ ë°ì´í„°:', requestData);
                
                // ğŸ”§ Render ë°°í¬ í™˜ê²½ì— ë§ê²Œ ì ˆëŒ€ URL ì‚¬ìš©
                const brushApiUrl = window.location.hostname === 'localhost' 
                    ? '/api/apply-brush-effect' 
                    : `${window.apiBase ? window.apiBase() : window.location.origin}/api/apply-brush-effect`;
                
                console.log('ğŸŒ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ API í˜¸ì¶œ URL:', brushApiUrl);
                
                console.log('ğŸ“¤ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ìš”ì²­ í—¤ë”:', {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                });
                
                const response = await fetch(brushApiUrl, {
                        method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                    },
                    body: JSON.stringify(requestData)
                });

                // ğŸ”§ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì‘ë‹µ ìƒíƒœ ë¡œê¹…
                console.log('ğŸ” ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì‘ë‹µ ìƒíƒœ ì½”ë“œ:', response.status);
                console.log('ğŸ” ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì‘ë‹µ ìƒíƒœ í…ìŠ¤íŠ¸:', response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì‘ë‹µ ì˜¤ë¥˜:', errorText);
                    console.error('âŒ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
                    throw new Error(`ë¸ŒëŸ¬ì‹œ íš¨ê³¼ API ìš”ì²­ ì‹¤íŒ¨ (${response.status}): ${errorText.substring(0, 100)}`);
                }
                
                // ğŸ”§ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ JSON íŒŒì‹± ê°•í™”
                let result;
                try {
                    result = await response.json();
                    console.log('âœ… ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì‘ë‹µ íŒŒì‹± ì„±ê³µ:', result);
                } catch (err) {
                    console.error('âŒ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ JSON íŒŒì‹± ì‹¤íŒ¨:', err);
                    throw new Error('ë¸ŒëŸ¬ì‹œ íš¨ê³¼ API ì‘ë‹µì´ ì˜¬ë°”ë¥¸ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
                }
                console.log('âœ… ë¸ŒëŸ¬ì‹œ íš¨ê³¼ API ì‘ë‹µ:', result);
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // 2ë‹¨ê³„ ê²°ê³¼ í‘œì‹œ (ë¸ŒëŸ¬ì‰¬ íš¨ê³¼ ì ìš©ë¨)
                                            // ë¸ŒëŸ¬ì‹œ ê²°ê³¼ì—ë„ ê°•ë ¥í•œ ìºì‹œ ë¬´íš¨í™” ì ìš©
                        const brushTimestamp = Date.now();
                        const brushRandom = Math.random().toString(36).substr(2, 9);
                        const brushCacheBuster = `?nocache=${brushTimestamp}&r=${brushRandom}&reload=1&force=${Math.floor(Math.random() * 1000000)}`;
                        const brushImageUrl = (result.processedImageUrl || result.url || '') + brushCacheBuster;
                        
                        console.log('ë¸ŒëŸ¬ì‹œ ì´ë¯¸ì§€ ë¡œë“œ ì‹œë„ (ê°•ë ¥í•œ ìºì‹œ ë¬´íš¨í™”):', brushImageUrl);
                        
                        // ë¸ŒëŸ¬ì‹œ ì´ë¯¸ì§€ë„ ë¦¬ì…‹ í›„ ë¡œë“œ
                        brushResultImage.src = '';
                        brushResultImage.style.display = 'none';
                        
                        setTimeout(() => {
                            brushResultImage.src = brushImageUrl;
                            brushResultImage.style.display = 'block';
                        }, 100);
                        brushResultImage.onload = () => {
                            console.log('ë¸ŒëŸ¬ì‰¬ íš¨ê³¼ ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:', brushImageUrl);
                            brushResultSection.style.display = 'block'; // ë¸ŒëŸ¬ì‰¬ ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
                        };
                        // ğŸ¯ ì—ëŸ¬ í•¸ë“¤ëŸ¬ ë‹¨ìˆœí™” - ë¶ˆí•„ìš”í•œ ì—ëŸ¬ ë©”ì‹œì§€ ë°©ì§€
                        brushResultImage.onerror = () => {
                            console.log('âš ï¸ ë¸ŒëŸ¬ì‹œ ì´ë¯¸ì§€ ë¡œë“œ ì´ë²¤íŠ¸ ì—ëŸ¬ (ë¬´ì‹œ)');
                        };
                        downloadLink.href = result.processedImageUrl || result.url || ''; // ë‹¤ìš´ë¡œë“œëŠ” ì›ë³¸ URL ì‚¬ìš© (ìºì‹œ ë²„ìŠ¤í„° ë¶ˆí•„ìš”)
                    
                    // ë¸ŒëŸ¬ì‰¬ íš¨ê³¼ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                    hideBrushEffectButton();
                    
                    // 2ë‹¨ê³„ ì™„ë£Œ ë©”ì‹œì§€
                    showMessage('ì¸ë¬¼ë¸ŒëŸ¬ì‰¬íš¨ê³¼ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                showMessage('ë¸ŒëŸ¬ì‰¬ íš¨ê³¼ ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                isBrushProcessing = false;
                showLoading(false);
                
                // ğŸ¯ ëŒ€ê¸° ì¤‘ì¸ ë¸ŒëŸ¬ì‹œ ìš”ì²­ì´ ìˆìœ¼ë©´ ì²˜ë¦¬
                if (pendingBrushUpdate) {
                    console.log('ğŸš€ ëŒ€ê¸° ì¤‘ì¸ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ìš”ì²­ ì²˜ë¦¬:', pendingBrushUpdate);
                    const pending = pendingBrushUpdate;
                    pendingBrushUpdate = null;
                    
                    // ì•½ê°„ì˜ ì§€ì—° í›„ ì²˜ë¦¬ (UI ì—…ë°ì´íŠ¸ ì™„ë£Œ ëŒ€ê¸°)
                    setTimeout(() => {
                        applyBrushEffect(pending.nobgPath, pending.backgroundPath, pending.emotion);
                    }, 100);
                }
            }
        }

        // ë¸ŒëŸ¬ì‰¬ íš¨ê³¼ ë²„íŠ¼ í‘œì‹œ
        function showBrushEffectButton(nobgPath, backgroundPath, emotion) {
            const brushButton = document.getElementById('brushEffectBtn');
            if (brushButton) {
                brushButton.style.display = 'block';
                brushButton.onclick = () => applyBrushEffect(nobgPath, backgroundPath, emotion);
            }
        }

        // ë¸ŒëŸ¬ì‰¬ íš¨ê³¼ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        function hideBrushEffectButton() {
            const brushButton = document.getElementById('brushEffectBtn');
            if (brushButton) {
                brushButton.style.display = 'none';
            }
        }

        // ì¸ë„¤ì¼ ë¡œë”© ì™„ë£Œ ì²˜ë¦¬
        function handleThumbnailLoad(img) {
            console.log('ğŸ–¼ï¸ ì¸ë„¤ì¼ ë¡œë“œ ì™„ë£Œ:', img.src);
            img.classList.remove('loading');
            img.classList.add('loaded');
        }
        
        // ì¸ë„¤ì¼ ë¡œë”© ì—ëŸ¬ ì²˜ë¦¬
        function handleThumbnailError(img, originalPath) {
            console.log('âŒ ì¸ë„¤ì¼ ë¡œë“œ ì‹¤íŒ¨, ì›ë³¸ìœ¼ë¡œ í´ë°±:', img.src, 'â†’', originalPath);
            img.classList.remove('loading');
            img.classList.add('error');
            
            // ì›ë³¸ ì´ë¯¸ì§€ë¡œ í´ë°± ì‹œë„
            setTimeout(() => {
                img.src = originalPath;
                img.onerror = () => {
                    console.log('âŒ ì›ë³¸ ì´ë¯¸ì§€ë„ ë¡œë“œ ì‹¤íŒ¨:', originalPath);
                    img.classList.add('error');
                };
                img.onload = () => {
                    console.log('âœ… ì›ë³¸ ì´ë¯¸ì§€ í´ë°± ì„±ê³µ:', originalPath);
                    img.classList.remove('error');
                    img.classList.add('loaded');
                };
            }, 100);
        }
        
        // ì›ë³¸ ì´ë¯¸ì§€ ë¡œë”© (ë”ë¸”í´ë¦­)
        function loadOriginalImage(img, originalPath) {
            console.log('ğŸ” ê³ í•´ìƒë„ ì´ë¯¸ì§€ ë¡œë”©:', originalPath);
            
            // ì´ë¯¸ ì›ë³¸ì´ë©´ ìŠ¤í‚µ
            if (img.src.includes(originalPath)) {
                console.log('â­ï¸ ì´ë¯¸ ì›ë³¸ ì´ë¯¸ì§€ì…ë‹ˆë‹¤');
                return;
            }
            
            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            img.classList.add('loading');
            
            // ì„ì‹œ ì´ë¯¸ì§€ ê°ì²´ë¡œ ì›ë³¸ ë¡œë”© í…ŒìŠ¤íŠ¸
            const tempImg = new Image();
            tempImg.onload = () => {
                console.log('âœ… ê³ í•´ìƒë„ ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ:', originalPath);
                img.src = originalPath;
                img.classList.remove('loading');
                img.classList.add('loaded');
                
                // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
                showMessage('ê³ í•´ìƒë„ ì´ë¯¸ì§€ë¡œ ì—…ê·¸ë ˆì´ë“œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ¨', 'success');
            };
            tempImg.onerror = () => {
                console.log('âŒ ê³ í•´ìƒë„ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', originalPath);
                img.classList.remove('loading');
                showMessage('ê³ í•´ìƒë„ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            };
            tempImg.src = originalPath;
        }
        
        // ì¸ë„¤ì¼ ìºì‹œ í”„ë¦¬ë¡œë”© (ì„±ëŠ¥ í–¥ìƒ)
        function preloadThumbnails(artworks) {
            if (!artworks || !Array.isArray(artworks)) return;
            
            console.log('ğŸš€ ì¸ë„¤ì¼ í”„ë¦¬ë¡œë”© ì‹œì‘:', artworks.length + 'ê°œ');
            let loadedCount = 0;
            
            artworks.forEach((artwork, index) => {
                if (artwork.thumbnail) {
                    const img = new Image();
                    img.onload = () => {
                        loadedCount++;
                        console.log(`ğŸ“¥ ì¸ë„¤ì¼ í”„ë¦¬ë¡œë“œ ${loadedCount}/${artworks.length}: ${artwork.thumbnail}`);
                        
                        if (loadedCount === artworks.length) {
                            console.log('âœ… ëª¨ë“  ì¸ë„¤ì¼ í”„ë¦¬ë¡œë”© ì™„ë£Œ');
                        }
                    };
                    img.onerror = () => {
                        console.log(`âŒ ì¸ë„¤ì¼ í”„ë¦¬ë¡œë“œ ì‹¤íŒ¨: ${artwork.thumbnail}`);
                        loadedCount++;
                    };
                    img.src = artwork.thumbnail;
                }
            });
        }

        // ìƒˆë¡œìš´ ì¸ë„¤ì¼ ê¸°ë°˜ ëª…í™” ì„ íƒ í•¨ìˆ˜
        async function selectArtworkByPath(backgroundPath) {
            console.log('ğŸ¨ ì¸ë„¤ì¼ ê¸°ë°˜ ëª…í™” ì„ íƒ:', backgroundPath);
            
            // ğŸ¯ í˜„ì¬ ë°°ê²½ ì •ë³´ ì €ì¥
            currentBackground = backgroundPath;
            console.log('ğŸ–¼ï¸ í˜„ì¬ ë°°ê²½ ì—…ë°ì´íŠ¸:', currentBackground);
            
            // ğŸ¯ ê¸°ì¡´ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì ìš© ì—¬ë¶€ í™•ì¸
            const hasBrushEffect = brushResultSection.style.display === 'block' && 
                                 brushResultImage.src && 
                                 brushResultImage.src !== '' && 
                                 brushResultImage.src !== window.location.href;
            
            console.log('ë°°ê²½ ë³€ê²½ - ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì ìš© ì—¬ë¶€:', hasBrushEffect);
            
            // ì„ íƒëœ ëª…í™”ë¡œ ë°°ê²½ í•©ì„± ì‹¤í–‰ (artworkIdëŠ” null ì‚¬ìš©)
            await applyComposite(null, backgroundPath);
            
            // ğŸš€ ê¸°ì¡´ì— ë¸ŒëŸ¬ì‹œ íš¨ê³¼ê°€ ì ìš©ë˜ì–´ ìˆì—ˆë‹¤ë©´, ìƒˆ ë°°ê²½ìœ¼ë¡œ ì¦‰ì‹œ ì¬ì ìš©
            if (hasBrushEffect && lastNobgPath) {
                console.log('ğŸ¨ ìƒˆë¡œìš´ ë°°ê²½ìœ¼ë¡œ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì¦‰ì‹œ ì¬ì ìš© ì‹œì‘');
                console.log('ğŸ”„ ì‚¬ìš©í•  nobgPath:', lastNobgPath);
                
                try {
                    await applyBrushEffect(lastNobgPath, backgroundPath, currentEmotion || 'neutral');
                    console.log('âœ… ìƒˆ ë°°ê²½ìœ¼ë¡œ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì¬ì ìš© ì™„ë£Œ');
                } catch (error) {
                    console.error('âŒ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì¬ì ìš© ì‹¤íŒ¨:', error);
                    showMessage('ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì¬ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
        }

        // ê¸°ì¡´ ID ê¸°ë°˜ ëª…í™” ì„ íƒ í•¨ìˆ˜ (í•˜ìœ„ í˜¸í™˜ì„±)
        async function selectArtwork(artworkId, backgroundImage) {
            // ğŸ¯ í˜„ì¬ ë°°ê²½ ì •ë³´ ì €ì¥
            currentBackground = backgroundImage;
            console.log('ğŸ–¼ï¸ í˜„ì¬ ë°°ê²½ ì—…ë°ì´íŠ¸:', currentBackground);
            
            // ğŸ¯ ê¸°ì¡´ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì ìš© ì—¬ë¶€ í™•ì¸
            const hasBrushEffect = brushResultSection.style.display === 'block' && 
                                 brushResultImage.src && 
                                 brushResultImage.src !== '' && 
                                 brushResultImage.src !== window.location.href;
            
            console.log('ë°°ê²½ ë³€ê²½ - ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì ìš© ì—¬ë¶€:', hasBrushEffect);
            
            // ì„ íƒëœ ëª…í™”ë¡œ ë°°ê²½ í•©ì„± ì‹¤í–‰
                await applyComposite(artworkId, backgroundImage);
            
            // ğŸš€ ê¸°ì¡´ì— ë¸ŒëŸ¬ì‹œ íš¨ê³¼ê°€ ì ìš©ë˜ì–´ ìˆì—ˆë‹¤ë©´, ìƒˆ ë°°ê²½ìœ¼ë¡œ ì¦‰ì‹œ ì¬ì ìš©
            if (hasBrushEffect && lastNobgPath) {
                console.log('ğŸ¨ ìƒˆë¡œìš´ ë°°ê²½ìœ¼ë¡œ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì¦‰ì‹œ ì¬ì ìš© ì‹œì‘');
                console.log('ğŸ”„ ì‚¬ìš©í•  nobgPath:', lastNobgPath);
                
                // ğŸ¯ ì¤‘ë³µ ë°©ì§€ ë¡œì§ì— ì˜í•´ ìë™ìœ¼ë¡œ ëŒ€ê¸°ì—´ì— ì¶”ê°€ë¨
                try {
                    await applyBrushEffect(lastNobgPath, backgroundImage, currentEmotion || 'neutral');
                    console.log('âœ… ìƒˆ ë°°ê²½ìœ¼ë¡œ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì¬ì ìš© ì™„ë£Œ');
                } catch (error) {
                    console.error('âŒ ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì¬ì ìš© ì‹¤íŒ¨:', error);
                    showMessage('ë¸ŒëŸ¬ì‹œ íš¨ê³¼ ì¬ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
        }

        async function removeBackground() {
            if (!currentFile) {
                showMessage('ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            showLoading(true);
            hideMessage();

            const formData = new FormData();
            formData.append('image', currentFile);

            try {
                const response = await fetch('/api/remove-bg', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    processedImageUrl = result.processedImageUrl;
                    if (processedImage) processedImage.src = processedImageUrl;
                    if (processedImage) processedImage.style.display = 'block';
                    showMessage('ë°°ê²½ì´ ì„±ê³µì ìœ¼ë¡œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                } else {
                    throw new Error(result.error || 'ë°°ê²½ ì œê±° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                showMessage(error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ğŸ”„ ë°°ê²½ ì œê±° ì¬ì‹œë„ í•¨ìˆ˜
        async function retryBackgroundRemoval() {
            console.log('ğŸ”„ ë°°ê²½ ì œê±° ì¬ì‹œë„ ì‹œì‘');
            
            if (!currentFile) {
                showMessage('ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            showLoading(true);
            hideMessage();
            
            // ì¬ì‹œë„ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            const retryBtn = document.getElementById('retryBgRemovalBtn');
            if (retryBtn) retryBtn.style.display = 'none';

            try {
                const result = await removeBackgroundInternal();
                
                if (result && result.ok) {
                    console.log('âœ… ë°°ê²½ ì œê±° ì¬ì‹œë„ ì„±ê³µ');
                    showMessage('ë°°ê²½ ì œê±°ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!', 'success');
                    
                    // ì„±ê³µ ì‹œ ì¬ì‹œë„ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                    if (retryBtn) retryBtn.style.display = 'none';
                } else {
                    console.warn('âš ï¸ ë°°ê²½ ì œê±° ì¬ì‹œë„ ì‹¤íŒ¨:', result?.reason || 'unknown error');
                    showMessage('ë°°ê²½ ì œê±°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì›ë³¸ ì´ë¯¸ì§€ë¡œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.', 'warning');
                    
                    // ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë²„íŠ¼ í‘œì‹œ
                    if (retryBtn) retryBtn.style.display = 'inline-flex';
                }
            } catch (error) {
                console.error('âŒ ë°°ê²½ ì œê±° ì¬ì‹œë„ ì¤‘ ì˜¤ë¥˜:', error);
                showMessage('ë°°ê²½ ì œê±° ì¬ì‹œë„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                
                // ì˜¤ë¥˜ ì‹œ ì¬ì‹œë„ ë²„íŠ¼ í‘œì‹œ
                if (retryBtn) retryBtn.style.display = 'inline-flex';
            } finally {
                showLoading(false);
            }
        }

        async function analyzeEmotion() {
            if (!currentFile) {
                showMessage('ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            showLoading(true);
            hideMessage();

            const formData = new FormData();
            formData.append('image', currentFile);

            try {
                const response = await fetch('/analyze-emotion', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(`ê°ì • ë¶„ì„ ê²°ê³¼: ${result.emotion} (${result.confidence}%)`, 'success');
                } else {
                    throw new Error(result.error || 'ê°ì • ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                showMessage(error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function resetImage() {
            currentFile = null;
            processedImageUrl = null;
            // ğŸ”§ nobgBlob ì´ˆê¸°í™” ì œê±° - êµì°© ë°©ì§€
            // nobgBlob = null;
            fileInput.value = '';
            if (imagePreview) imagePreview.style.display = 'none';
            controls.style.display = 'none';
            resultSection.style.display = 'none';
            brushResultSection.style.display = 'none';
            hideBrushEffectButton();
            hideMessage();
            hideEmotionFeedback();
            
            // ì¬ì‹œë„ ë²„íŠ¼ë„ ìˆ¨ê¸°ê¸°
            const retryBtn = document.getElementById('retryBgRemovalBtn');
            if (retryBtn) retryBtn.style.display = 'none';
        }

        function showLoading(show) {
            loading.style.display = show ? 'block' : 'none';
            controls.style.display = show ? 'none' : 'flex';
        }

        // ì´ë¯¸ì§€ ì¤€ë¹„ ìƒíƒœ í™•ì¸ í•¨ìˆ˜ (ë‹¨ìˆœí™” ë° ê°•í™”)
        async function waitForImageReady(filename, maxAttempts = 15) {
            console.log('ì´ë¯¸ì§€ ì¤€ë¹„ ìƒíƒœ í™•ì¸ ì‹œì‘:', filename);
            
            for (let i = 0; i < maxAttempts; i++) {
                try {
                    // ì´ë¯¸ì§€ ìƒíƒœ í™•ì¸ API í˜¸ì¶œ
                    const checkResponse = await fetch(`/api/check-image/${filename}`, {
                        method: 'GET',
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    if (checkResponse.ok) {
                        const result = await checkResponse.json();
                        
                        if (result.ready && result.size > 1000) {
                            console.log(`âœ… ì´ë¯¸ì§€ ì¤€ë¹„ ì™„ë£Œ (${i + 1}/${maxAttempts}):`, result.size, 'bytes');
                            
                            // ì¶”ê°€ ê²€ì¦: ì‹¤ì œ ì´ë¯¸ì§€ íŒŒì¼ì— ì§ì ‘ HEAD ìš”ì²­
                            try {
                                const imageResponse = await fetch(`/uploads/${filename}`, {
                                    method: 'HEAD',
                                    cache: 'no-store'
                                });
                                
                                if (imageResponse.ok) {
                                    const contentLength = imageResponse.headers.get('content-length');
                                    console.log(`âœ… ì‹¤ì œ ì´ë¯¸ì§€ íŒŒì¼ í™•ì¸ ì™„ë£Œ:`, contentLength, 'bytes');
                                    return true;
                                } else {
                                    console.log(`âš ï¸ ì´ë¯¸ì§€ íŒŒì¼ HEAD ìš”ì²­ ì‹¤íŒ¨ (${i + 1}/${maxAttempts}):`, imageResponse.status);
                                }
                            } catch (headError) {
                                console.log(`âš ï¸ ì´ë¯¸ì§€ HEAD ìš”ì²­ ì˜¤ë¥˜ (${i + 1}/${maxAttempts}):`, headError.message);
                            }
                        } else {
                            console.log(`â³ ì´ë¯¸ì§€ ì¤€ë¹„ ì¤‘ (${i + 1}/${maxAttempts}):`, result.size || 0, 'bytes');
                        }
                    } else {
                        console.log(`âŒ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨ (${i + 1}/${maxAttempts}):`, checkResponse.status);
                    }
                } catch (error) {
                    console.log(`âŒ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜ (${i + 1}/${maxAttempts}):`, error.message);
                }
                
                // ì ì§„ì ìœ¼ë¡œ ëŒ€ê¸° ì‹œê°„ ì¦ê°€ (ë” ê¸´ ê°„ê²©)
                const waitTime = Math.min(800 + (i * 200), 3000);
                console.log(`â° ${waitTime}ms ëŒ€ê¸° í›„ ì¬ì‹œë„...`);
                await new Promise(resolve => setTimeout(resolve, waitTime));
            }
            
            console.error('âŒ ì´ë¯¸ì§€ ì¤€ë¹„ ìƒíƒœ í™•ì¸ í¬ê¸°:', filename);
            return false;
        }

        function showMessage(text, type) {
            message.innerHTML = `<div class="${type}">${text}</div>`;
        }

        function hideMessage() {
            message.innerHTML = '';
        }

        // ê°ì •ë³„ ì•„ì´ì½˜ ë§¤í•‘ (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ - ì´ë¯¸ì§€ë¡œ ëŒ€ì²´)

        // ê°ì •ë³„ ì œëª© ë§¤í•‘
        const emotionTitles = {
            'happy': 'í–‰ë³µí•œ ìˆœê°„',
            'happiness': 'í–‰ë³µí•œ ìˆœê°„',
            'sad': 'ìŠ¬í”ˆ ë§ˆìŒ',
            'sadness': 'ìŠ¬í”ˆ ë§ˆìŒ',
            'neutral': 'í‰ì˜¨í•œ ìˆœê°„',
            'fear': 'ë¶ˆì•ˆí•œ ë§ˆìŒ',
            'surprise': 'ë†€ë¼ìš´ ìˆœê°„',
            'surprised': 'ë†€ë¼ìš´ ìˆœê°„',
            'angry': 'í™”ë‚œ ë§ˆìŒ',
            'anger': 'í™”ë‚œ ë§ˆìŒ',
            'disgust': 'ì—­ê²¨ìš´ ëŠë‚Œ',
            'contempt': 'ê²½ë©¸í•˜ëŠ” ë§ˆìŒ'
        };

        // ê°ì •ë³„ ì´ë¯¸ì§€ íŒŒì¼ ë§¤í•‘
        function getEmotionImage(emotion) {
            const emotionImages = {
                'happiness': '/happy.png',
                'happy': '/happy.png',
                'sadness': '/sad.png',
                'sad': '/sad.png', 
                'anger': '/angry.png',
                'angry': '/angry.png',
                'surprise': '/surprise.png',
                'surprised': '/surprise.png',
                'fear': '/fear.png',
                'disgust': '/disgust.png',
                'neutral': '/neutral.png',
                'contempt': '/contempt.png'
            };
            return emotionImages[emotion] || '/neutral.png';
        }

        function showEmotionFeedback(emotion, feedback) {
            const emotionImg = document.getElementById('emotionImg');
            if (emotionImg) {
                emotionImg.src = getEmotionImage(emotion);
                emotionImg.alt = emotion;
                
                // ê°•ì œë¡œ í¬ê¸° ì„¤ì •
                emotionImg.style.width = '128px';
                emotionImg.style.height = '128px';
                emotionImg.style.minWidth = '128px';
                emotionImg.style.minHeight = '128px';
                emotionImg.style.maxWidth = '128px';
                emotionImg.style.maxHeight = '128px';
                emotionImg.style.borderRadius = '0';
                emotionImg.style.border = 'none';
                emotionImg.style.objectFit = 'contain';
                emotionImg.style.objectPosition = 'center center';
                emotionImg.style.margin = '20px auto 10px auto';
                emotionImg.style.padding = '0';
                emotionImg.style.boxSizing = 'border-box';
                emotionImg.style.display = 'block';
                emotionImg.style.clipPath = 'none';
                emotionImg.style.mask = 'none';
            }
            
            const title = emotionTitles[emotion] || 'ê°ì • ë¶„ì„ ê²°ê³¼';
            
            emotionTitle.textContent = title;
            emotionMessage.textContent = feedback;
            emotionFeedback.style.display = 'block';
        }

        function hideEmotionFeedback() {
            emotionFeedback.style.display = 'none';
        }

        // Firebase ì¸ì¦ í•¨ìˆ˜ë“¤ (headì— ì´ë¯¸ ì •ì˜ë¨)

        async function handleSignup(e) {
            e.preventDefault();
            const username = document.getElementById('authUsername').value;
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;

            // ğŸ”§ Render ë°°í¬ í™˜ê²½ì— ë§ê²Œ ì ˆëŒ€ URL ì‚¬ìš©
            const signupApiUrl = window.location.hostname === 'localhost' 
                ? '/api/auth/signup' 
                : `${window.apiBase ? window.apiBase() : window.location.origin}/api/auth/signup`;
            
            console.log('ğŸŒ íšŒì›ê°€ì… API í˜¸ì¶œ URL:', signupApiUrl);
            
            try {
                const response = await fetch(signupApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, email, password })
                });

                if (response.status === 503) {
                    showMessage('Firebase Adminì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ íšŒì›ê°€ì… ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }

                const data = await response.json();
                if (data.success || data.token) {
                    // ì„œë²„ JWTë¥¼ ì§ì ‘ ì €ì¥ ë° UI ê°±ì‹ 
                    localStorage.setItem('token', data.token);
                    authToken = data.token;
                    currentUser = data.user;
                    closeAuthModal();
                    updateAuthUI();
                    showMessage('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (error) {
                showMessage('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;

            // ğŸ”§ Render ë°°í¬ í™˜ê²½ì— ë§ê²Œ ì ˆëŒ€ URL ì‚¬ìš©
            const loginApiUrl = window.location.hostname === 'localhost' 
                ? '/api/auth/login' 
                : `${window.apiBase ? window.apiBase() : window.location.origin}/api/auth/login`;
            
            console.log('ğŸŒ ë¡œê·¸ì¸ API í˜¸ì¶œ URL:', loginApiUrl);
            
            try {
                const response = await fetch(loginApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                if (response.status === 503) {
                    showMessage('Firebase Adminì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }

                const data = await response.json();
                console.log('ğŸ” ë¡œê·¸ì¸ ì‘ë‹µ:', data);
                if (data.success || data.token) {
                    // ì„œë²„ JWTë¥¼ ì§ì ‘ ì €ì¥ ë° UI ê°±ì‹ 
                    console.log('âœ… í† í° ì €ì¥:', data.token?.substring(0, 50) + '...');
                    localStorage.setItem('token', data.token);
                    authToken = data.token;
                    currentUser = data.user;
                    console.log('ğŸ‘¤ ì‚¬ìš©ì ì •ë³´ ì„¤ì •:', currentUser);
                    
                    // ì‚¬ìš©ì ì •ë³´ë„ localStorageì— ì €ì¥
                    if (currentUser) {
                        localStorage.setItem('userId', currentUser.id);
                        localStorage.setItem('username', currentUser.username || '');
                        localStorage.setItem('email', currentUser.email || '');
                    }
                    
                    // localStorage ì €ì¥ í™•ì¸
                    console.log('ğŸ’¾ localStorage ì €ì¥ í™•ì¸:', {
                        token: localStorage.getItem('token')?.substring(0, 50) + '...',
                        userId: localStorage.getItem('userId'),
                        username: localStorage.getItem('username'),
                        email: localStorage.getItem('email'),
                        authToken: authToken?.substring(0, 50) + '...'
                    });
                    
                    closeAuthModal();
                    updateAuthUI();
                    showMessage('ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (error) {
                showMessage('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // signInWithCustomToken í•¨ìˆ˜ ë° Firebase ì¸ì¦ ê´€ë ¨ ì½”ë“œ ì œê±° ë˜ëŠ” ë¯¸ì‚¬ìš© ì²˜ë¦¬

        function updateAuthUI() {
            if (currentUser) {
                document.getElementById('navLoginBtn').style.display = 'none';
                document.getElementById('navSignupBtn').style.display = 'none';
                // íšŒì› ì´ë¦„(ë‹‰ë„¤ì„/ì´ë©”ì¼ ì „ì²´) í‘œì‹œ
                document.getElementById('navAvatar').textContent = (currentUser.displayName || currentUser.email);
                document.getElementById('navAvatar').style.display = 'flex';
                document.getElementById('navLogoutBtn').style.display = 'block';
                document.getElementById('gallerySection').style.display = 'block';
            } else {
                document.getElementById('navLoginBtn').style.display = 'block';
                document.getElementById('navSignupBtn').style.display = 'block';
                document.getElementById('navAvatar').style.display = 'none';
                document.getElementById('navLogoutBtn').style.display = 'none';
                document.getElementById('gallerySection').style.display = 'none';
            }
        }

        async function logout() {
            try {
                // Firebase ë¡œê·¸ì•„ì›ƒ ì‹œë„
                await auth.signOut();
                currentUser = null;
                authToken = null;
                
                // localStorageì—ì„œ ëª¨ë“  ì¸ì¦ ì •ë³´ ì‚­ì œ
                localStorage.removeItem('token');
                localStorage.removeItem('userId');
                localStorage.removeItem('username');
                localStorage.removeItem('email');
                
                console.log('ğŸšª ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ, localStorage ì •ë¦¬ë¨');
                updateAuthUI();
                showMessage('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                showMessage('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ê°¤ëŸ¬ë¦¬ ì €ì¥ í•¨ìˆ˜ (ë¡œì»¬ ê°¤ëŸ¬ë¦¬ ì‚¬ìš©)
        async function saveToGallery() {
            console.log('ğŸ¯ ë¡œì»¬ ê°¤ëŸ¬ë¦¬ ì €ì¥ ì‹œì‘');
            
            const brushResultImage = document.getElementById('brushResultImage');
            if (!brushResultImage || !brushResultImage.src) {
                console.log('âŒ ë¸ŒëŸ¬ì‹œ ê²°ê³¼ ì´ë¯¸ì§€ ì—†ìŒ');
                showMessage('ì €ì¥í•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¸ŒëŸ¬ì‹œ íš¨ê³¼ë¥¼ ì ìš©í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            console.log('âœ… ë¸ŒëŸ¬ì‹œ ê²°ê³¼ ì´ë¯¸ì§€ í™•ì¸:', brushResultImage.src.substring(0, 100) + '...');
            
            try {
                const imageUrl = brushResultImage.src;
                // URLì—ì„œ íŒŒì¼ëª…ë§Œ ì¶”ì¶œ (ì˜ˆ: /uploads/filename.png -> filename.png)
                const urlPath = new URL(imageUrl, window.location.origin).pathname;
                
                console.log('ğŸ  ë¡œì»¬ ê°¤ëŸ¬ë¦¬ ì €ì¥ ë°ì´í„°:', { imageUrl: urlPath });
                
                // ğŸ”§ Render ë°°í¬ í™˜ê²½ì— ë§ê²Œ ì ˆëŒ€ URL ì‚¬ìš©
                const galleryApiUrl = window.location.hostname === 'localhost' 
                    ? '/api/my-art' 
                    : `${window.apiBase ? window.apiBase() : window.location.origin}/api/my-art`;
                
                console.log('ğŸŒ ê°¤ëŸ¬ë¦¬ ì €ì¥ API í˜¸ì¶œ URL:', galleryApiUrl);
                
                // ë¡œì»¬ ê°¤ëŸ¬ë¦¬ ì‚¬ìš© (Firebase ì¸ì¦ ë¬¸ì œ ìš°íšŒ)
                const response = await fetch(galleryApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageUrl: urlPath,
                        createdAt: Date.now()
                    })
                });
                
                console.log('ğŸ“¨ ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('âœ… ê°¤ëŸ¬ë¦¬ì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    console.log('âœ… ê°¤ëŸ¬ë¦¬ ì €ì¥ ì™„ë£Œ:', result.id);
                    
                    // ê°¤ëŸ¬ë¦¬ê°€ í˜„ì¬ í‘œì‹œë˜ì–´ ìˆë‹¤ë©´ ìƒˆë¡œê³ ì¹¨
                    const gallerySection = document.getElementById('gallerySection');
                    if (gallerySection && gallerySection.style.display !== 'none') {
                        loadGallery();
                    }
                } else {
                    throw new Error(result.error || 'ê°¤ëŸ¬ë¦¬ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('âŒ ê°¤ëŸ¬ë¦¬ ì €ì¥ ì˜¤ë¥˜:', error);
                showMessage('ê°¤ëŸ¬ë¦¬ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // í† í° ê°±ì‹  í•¨ìˆ˜
        async function refreshAuthToken() {
            try {
                // Firebase authì—ì„œ í˜„ì¬ ì‚¬ìš©ì ê°€ì ¸ì˜¤ê¸°
                const firebaseUser = auth.currentUser;
                if (!firebaseUser) {
                    console.log('Firebase ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    return false;
                }
                
                console.log('ğŸ”„ í† í° ê°±ì‹  ì‹œì‘...', firebaseUser.uid);
                const newToken = await firebaseUser.getIdToken(true); // force refresh
                authToken = newToken;
                console.log('âœ… í† í° ê°±ì‹  ì™„ë£Œ');
                return true;
            } catch (error) {
                console.error('âŒ í† í° ê°±ì‹  ì‹¤íŒ¨:', error);
                return false;
            }
        }

        // ê°¤ëŸ¬ë¦¬ í•¨ìˆ˜ë“¤ (ë¡œì»¬ ê°¤ëŸ¬ë¦¬ ì‚¬ìš©)
        function showGallery() {
            // ë¡œê·¸ì¸ ì—†ì´ë„ ë¡œì»¬ ê°¤ëŸ¬ë¦¬ ì‚¬ìš© ê°€ëŠ¥
            
            // ê°¤ëŸ¬ë¦¬ ì„¹ì…˜ í† ê¸€ (í‘œì‹œ/ìˆ¨ê¹€)
            const gallerySection = document.getElementById('gallerySection');
            if (gallerySection) {
                if (gallerySection.style.display === 'none' || gallerySection.style.display === '') {
                    // ê°¤ëŸ¬ë¦¬ í‘œì‹œ
                    gallerySection.style.display = 'block';
                    // ê°¤ëŸ¬ë¦¬ë¡œ ìŠ¤í¬ë¡¤
                    gallerySection.scrollIntoView({ behavior: 'smooth' });
                    // ê°¤ëŸ¬ë¦¬ ë¡œë“œ
                    loadGallery();
                } else {
                    // ê°¤ëŸ¬ë¦¬ ìˆ¨ê¹€
                    gallerySection.style.display = 'none';
                }
            }
        }
        
        async function loadGallery() {
            console.log('ğŸ¯ ê°¤ëŸ¬ë¦¬ ë¡œë“œ ì‹œì‘');
            console.log('ğŸ” Firebase auth ìƒíƒœ:', auth.currentUser ? 'logged in' : 'not logged in');
            console.log('ğŸ” í˜„ì¬ ì‚¬ìš©ì ì •ë³´:', currentUser);
            
            // ğŸ”§ Render ë°°í¬ í™˜ê²½ì— ë§ê²Œ ì ˆëŒ€ URL ì‚¬ìš©
            const galleryLoadApiUrl = window.location.hostname === 'localhost' 
                ? '/api/my-art' 
                : `${window.apiBase ? window.apiBase() : window.location.origin}/api/my-art`;
            
            console.log('ğŸŒ ê°¤ëŸ¬ë¦¬ ë¡œë“œ API í˜¸ì¶œ URL:', galleryLoadApiUrl);
            
            // ë¡œì»¬ ê°¤ëŸ¬ë¦¬ ì‚¬ìš© (Firebase ì¸ì¦ ë¬¸ì œ ìš°íšŒ)
            try {
                const response = await fetch(galleryLoadApiUrl);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`âœ… ë¡œì»¬ ê°¤ëŸ¬ë¦¬ ë¡œë“œ ì„±ê³µ: ${data.items ? data.items.length : 0}ê°œ í•­ëª©`);
                    displayGallery(data.items || []);
                } else {
                    console.error('âŒ ë¡œì»¬ ê°¤ëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', data.error);
                    displayGallery([]);
                }
            } catch (error) {
                console.error('ê°¤ëŸ¬ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', error);
                displayGallery([]);
            }
            return;

            try {
                // localStorageì—ì„œ í† í° í™•ì¸
                const localToken = localStorage.getItem('token');
                if (!localToken) {
                    console.log('âŒ localStorageì— í† í°ì´ ì—†ìŠµë‹ˆë‹¤.');
                    showMessage('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                    return;
                }
                
                authToken = localToken; // í† í° ì—…ë°ì´íŠ¸
                console.log('âœ… ê°¤ëŸ¬ë¦¬ ì¡°íšŒìš© í† í° í™•ì¸:', authToken.substring(0, 50) + '...');

                const response = await fetch('/api/gallery', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                console.log('ğŸ“¨ ê°¤ëŸ¬ë¦¬ ì¡°íšŒ ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);

                if (response.status === 503) {
                    // Firebase Adminì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì€ ê²½ìš°
                    displayGallery([]);
                    showMessage('Firebase Adminì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ ê°¤ëŸ¬ë¦¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }

                if (response.status === 401) {
                    // í† í° ë§Œë£Œ ë˜ëŠ” ë¬´íš¨ - í† í° ê°±ì‹  ì‹œë„
                    console.log('í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í† í°ì„ ê°±ì‹ í•©ë‹ˆë‹¤.');
                    const refreshSuccess = await refreshAuthToken();
                    if (refreshSuccess) {
                        // í† í° ê°±ì‹  ì„±ê³µ ì‹œ ë‹¤ì‹œ ì‹œë„
                        return loadGallery();
                    } else {
                        // í† í° ê°±ì‹  ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì¸ í•„ìš”
                        showMessage('í† í° ê°±ì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
                        return;
                    }
                }

                if (response.status === 403) {
                    showMessage('ê°¤ëŸ¬ë¦¬ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                const data = await response.json();
                console.log('ğŸ“„ ê°¤ëŸ¬ë¦¬ ì¡°íšŒ ì‘ë‹µ ë°ì´í„°:', data);
                
                if (data.success) {
                    console.log(`âœ… ê°¤ëŸ¬ë¦¬ ë¡œë“œ ì„±ê³µ: ${data.gallery ? data.gallery.length : 0}ê°œ í•­ëª©`);
                    displayGallery(data.gallery);
                } else {
                    console.error('âŒ ê°¤ëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', data.error);
                    showMessage('ê°¤ëŸ¬ë¦¬ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (data.error || ''), 'error');
                }
            } catch (error) {
                console.error('ê°¤ëŸ¬ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', error);
                showMessage('ê°¤ëŸ¬ë¦¬ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        let isAllSelected = false;
        function toggleSelectAllGallery() {
            const checkboxes = document.querySelectorAll('.gallery-checkbox');
            isAllSelected = !isAllSelected;
            checkboxes.forEach(cb => {
                cb.checked = isAllSelected;
                cb.dispatchEvent(new Event('click', { bubbles: true }));
            });
            // ë²„íŠ¼ í…ìŠ¤íŠ¸ í† ê¸€
            document.getElementById('selectAllBtn').textContent = isAllSelected ? 'ì „ì²´í•´ì œ' : 'ì „ì²´ì„ íƒ';
        }

        function displayGallery(gallery) {
            console.log('ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬ í™”ë©´ í‘œì‹œ ì‹œì‘');
            console.log('ğŸ“Š ê°¤ëŸ¬ë¦¬ ë°ì´í„°:', gallery);
            console.log(`ğŸ“ˆ ê°¤ëŸ¬ë¦¬ ì•„ì´í…œ ìˆ˜: ${gallery ? gallery.length : 0}`);
            
            const grid = document.getElementById('galleryGrid');
            if (!grid) {
                console.error('âŒ galleryGrid ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            grid.innerHTML = '';
            // ë¡œì»¬ ê°¤ëŸ¬ë¦¬ì—ì„œëŠ” ì„ íƒ ê¸°ëŠ¥ ë¹„í™œì„±í™”
            selectedGalleryIds = [];
            
            if (!gallery || gallery.length === 0) {
                console.log('ğŸ“­ í‘œì‹œí•  ê°¤ëŸ¬ë¦¬ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                grid.innerHTML = '<p>ì €ì¥ëœ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            gallery.forEach((artwork, index) => {
                console.log(`ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬ ì•„ì´í…œ ${index + 1} ìƒì„± ì¤‘:`, artwork);
                
                const item = document.createElement('div');
                item.className = 'gallery-item';
                
                // ì´ë¯¸ì§€ ì¸ë„¤ì¼ (ë¡œì»¬ ê°¤ëŸ¬ë¦¬ìš© ê°„ì†Œí™”)
                const img = document.createElement('img');
                const imageUrl = artwork.imageUrl.startsWith('/') ? artwork.imageUrl : '/' + artwork.imageUrl;
                img.src = imageUrl;
                img.alt = artwork.title || 'ë‚˜ì˜ ì‘í’ˆ';
                console.log(`ğŸ“¸ ì´ë¯¸ì§€ URL ì„¤ì •: ${imageUrl}`);
                
                img.onload = () => {
                    console.log(`âœ… ê°¤ëŸ¬ë¦¬ ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ: ${imageUrl}`);
                };
                img.onerror = () => {
                    console.error(`âŒ ê°¤ëŸ¬ë¦¬ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ${imageUrl}`);
                };
                
                img.onclick = () => showGalleryModal(artwork.imageUrl, 'ë‚˜ì˜ ì‘í’ˆ', new Date(artwork.createdAt || Date.now()).toLocaleString('ko-KR'));
                item.appendChild(img);
                
                // ì œëª© ë° ë‚ ì§œ ì¶”ê°€ (ë¡œì»¬ ê°¤ëŸ¬ë¦¬ìš©)
                const info = document.createElement('div');
                info.className = 'gallery-item-info';
                info.innerHTML = `
                    <h4>ë‚˜ì˜ ì‘í’ˆ</h4>
                    <p>${new Date(artwork.createdAt || Date.now()).toLocaleDateString('ko-KR')}</p>
                `;
                item.appendChild(info);
                
                grid.appendChild(item);
                console.log(`âœ… ê°¤ëŸ¬ë¦¬ ì•„ì´í…œ ${index + 1} ì¶”ê°€ ì™„ë£Œ`);
            });
        }

        async function deleteArtwork(artworkId) {
            if (!confirm('ì´ ì‘í’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`/api/gallery/${artworkId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    showMessage('ì‘í’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    loadGallery();
                } else {
                    showMessage('ì‘í’ˆ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                console.error('ì‘í’ˆ ì‚­ì œ ì˜¤ë¥˜:', error);
                showMessage('ì‘í’ˆ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // Firebase ì¸ì¦ ìƒíƒœ/í† í° ë³€ê²½ ë¦¬ìŠ¤ë„ˆ (í•­ìƒ ìµœì‹  í† í°ì„ localStorageì— ì €ì¥)
        auth.onIdTokenChanged(async (user) => {
            currentUser = user;
            if (user) {
                const token = await user.getIdToken();
                authToken = token;
                localStorage.setItem('token', token); // í•­ìƒ ìµœì‹  í† í° ì €ì¥
                updateAuthUI();
                loadGallery();
            } else {
                authToken = null;
                localStorage.removeItem('token');
                updateAuthUI();
            }
        });

        // ì„œë²„ ìƒíƒœ í™•ì¸
        async function checkServerStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) {
                    console.log('ì„œë²„ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨');
                } else {
                    console.log('ì„œë²„ ì—°ê²° ì„±ê³µ');
                }
            } catch (error) {
                console.log('ì„œë²„ ì—°ê²° ì˜¤ë¥˜:', error.message);
            }
        }

        // Splash í™”ë©´ ì œì–´ í•¨ìˆ˜
        function initializeSplashScreen() {
            const splashScreen = document.getElementById('splashScreen');
            const splashVideo = document.getElementById('splashVideo');
            const introScreen = document.getElementById('introScreen');
            
            if (!splashScreen || !splashVideo || !introScreen) {
                console.error('Splash í™”ë©´ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë™ì˜ìƒ ì¢…ë£Œ ì‹œ ì¸íŠ¸ë¡œ í™”ë©´ìœ¼ë¡œ ì „í™˜
            splashVideo.addEventListener('ended', function() {
                console.log('ğŸ¬ Splash ë™ì˜ìƒ ì¬ìƒ ì™„ë£Œ - ì¸íŠ¸ë¡œ í™”ë©´ìœ¼ë¡œ ì „í™˜');
                showIntroScreen();
            });
            
            // ë™ì˜ìƒ ë¡œë“œ ì˜¤ë¥˜ ì‹œ ì¦‰ì‹œ ì¸íŠ¸ë¡œ í™”ë©´ìœ¼ë¡œ ì „í™˜
            splashVideo.addEventListener('error', function() {
                console.log('âŒ Splash ë™ì˜ìƒ ë¡œë“œ ì‹¤íŒ¨ - ì¸íŠ¸ë¡œ í™”ë©´ìœ¼ë¡œ ì „í™˜');
                showIntroScreen();
            });
            
            // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ì¸íŠ¸ë¡œ í™”ë©´ìœ¼ë¡œ ì „í™˜ (ìµœëŒ€ ëŒ€ê¸° ì‹œê°„)
            setTimeout(() => {
                if (splashScreen.style.display !== 'none') {
                    console.log('â° Splash í™”ë©´ ìµœëŒ€ ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼ - ì¸íŠ¸ë¡œ í™”ë©´ìœ¼ë¡œ ì „í™˜');
                    showIntroScreen();
                }
            }, 3000);
            
            // í™”ë©´ í„°ì¹˜/í´ë¦­ ì‹œ ì¦‰ì‹œ ì¸íŠ¸ë¡œ í™”ë©´ìœ¼ë¡œ ì „í™˜
            splashScreen.addEventListener('click', function() {
                console.log('ğŸ‘† Splash í™”ë©´ í„°ì¹˜/í´ë¦­ - ì¸íŠ¸ë¡œ í™”ë©´ìœ¼ë¡œ ì „í™˜');
                showIntroScreen();
            });
            
            // í„°ì¹˜ ì´ë²¤íŠ¸ë„ ì¶”ê°€ (ëª¨ë°”ì¼ ìµœì í™”)
            splashScreen.addEventListener('touchstart', function(e) {
                e.preventDefault(); // ê¸°ë³¸ í„°ì¹˜ ë™ì‘ ë°©ì§€
                console.log('ğŸ“± Splash í™”ë©´ í„°ì¹˜ ì‹œì‘ - ì¸íŠ¸ë¡œ í™”ë©´ìœ¼ë¡œ ì „í™˜');
                showIntroScreen();
            });
            
            // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ (ìŠ¤í˜ì´ìŠ¤ë°”, ì—”í„°í‚¤)
            document.addEventListener('keydown', function(e) {
                if ((e.code === 'Space' || e.code === 'Enter') && splashScreen.style.display !== 'none') {
                    e.preventDefault();
                    console.log('âŒ¨ï¸ í‚¤ë³´ë“œ ì…ë ¥ - ì¸íŠ¸ë¡œ í™”ë©´ìœ¼ë¡œ ì „í™˜');
                    showIntroScreen();
                }
            });
            
            function showIntroScreen() {
                splashScreen.classList.add('fade-out');
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    introScreen.style.display = 'block';
                    console.log('âœ… ì¸íŠ¸ë¡œ í™”ë©´ í‘œì‹œ ì™„ë£Œ');
                }, 500); // í˜ì´ë“œì•„ì›ƒ ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ê³¼ ë§ì¶¤
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œë²„ ìƒíƒœ í™•ì¸ ë° ëª¨ë°”ì¼ ì„±ëŠ¥ ìµœì í™” ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            checkServerStatus();
            
            // Splash í™”ë©´ ì´ˆê¸°í™”
            initializeSplashScreen();
            
            // ëª¨ë°”ì¼ ì„±ëŠ¥ ì •ë³´ í™•ì¸
            const performanceInfo = getMobilePerformanceInfo();
            
            // ëª¨ë°”ì¼ ë””ë°”ì´ìŠ¤ì—ì„œ ì¶”ê°€ ìµœì í™” ì ìš©
            if (performanceInfo.isMobile) {
                // ì €ì‚¬ì–‘ ë””ë°”ì´ìŠ¤ ê°ì§€ (ë©”ëª¨ë¦¬ 4GB ë¯¸ë§Œ ë˜ëŠ” CPU ì½”ì–´ 4ê°œ ë¯¸ë§Œ)
                const isLowSpec = (performanceInfo.deviceMemory !== 'unknown' && performanceInfo.deviceMemory < 4) ||
                                 performanceInfo.hardwareConcurrency < 4;
                
                if (isLowSpec) {
                    console.log('ğŸ“± ì €ì‚¬ì–‘ ëª¨ë°”ì¼ ë””ë°”ì´ìŠ¤ ê°ì§€ - ì¶”ê°€ ìµœì í™” ì ìš©');
                    // ì €ì‚¬ì–‘ ë””ë°”ì´ìŠ¤ìš© ì¶”ê°€ ìµœì í™” ì„¤ì •
                    document.documentElement.style.setProperty('--animation-duration', '0.2s'); // ì• ë‹ˆë©”ì´ì…˜ ë‹¨ì¶•
                    document.documentElement.style.setProperty('--transition-duration', '0.1s'); // íŠ¸ëœì§€ì…˜ ë‹¨ì¶•
                }
                
                // ëŠë¦° ë„¤íŠ¸ì›Œí¬ ê°ì§€
                if (performanceInfo.connection !== 'unknown' && 
                    (performanceInfo.connection.effectiveType === 'slow-2g' || 
                     performanceInfo.connection.effectiveType === '2g')) {
                    console.log('ğŸ“¶ ëŠë¦° ë„¤íŠ¸ì›Œí¬ ê°ì§€ - ë°ì´í„° ì ˆì•½ ëª¨ë“œ í™œì„±í™”');
                    // ëŠë¦° ë„¤íŠ¸ì›Œí¬ìš© ìµœì í™” ì„¤ì •
                    window.mobileOptimization = window.mobileOptimization || {};
                    window.mobileOptimization.slowNetwork = true;
                }
            }
        });

        // ëª¨ë°”ì¼ ê°ì§€ í•¨ìˆ˜ (ê°•í™”ëœ ì„±ëŠ¥ ìµœì í™”)
        function isMobileDevice() {
            const userAgent = navigator.userAgent;
            const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile/i.test(userAgent);
            const isSmallScreen = window.innerWidth <= 768;
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            
            return isMobileUA || (isSmallScreen && isTouchDevice);
        }

        // ëª¨ë°”ì¼ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
        function getMobilePerformanceInfo() {
            const info = {
                isMobile: isMobileDevice(),
                deviceMemory: navigator.deviceMemory || 'unknown', // GB
                hardwareConcurrency: navigator.hardwareConcurrency || 1, // CPU ì½”ì–´ ìˆ˜
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink + ' Mbps'
                } : 'unknown',
                userAgent: navigator.userAgent
            };
            
            if (info.isMobile) {
                console.log('ğŸ“± ëª¨ë°”ì¼ ë””ë°”ì´ìŠ¤ ê°ì§€:', info);
            }
            
            return info;
        }

        // ì¸íŠ¸ë¡œ START ë²„íŠ¼ í´ë¦­ ì‹œ ì¸íŠ¸ë¡œ ìˆ¨ê¸°ê³  ë©”ì¸ ì»¨í…Œì´ë„ˆë¥¼ ë³´ì´ë©´ì„œ ë°”ë¡œ íŒŒì¼ ì„ íƒì°½ ì—´ê¸° (ë¡œê·¸ì¸ íŒì—… ë°©ì§€)
        document.getElementById('startBtn').addEventListener('click', function() {
            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            
            // ëª¨ë°”ì¼ì—ì„œëŠ” ì¹´ë©”ë¼ ë°”ë¡œ ì‹¤í–‰, ë°ìŠ¤í¬í†±ì—ì„œëŠ” íŒŒì¼ ì„ íƒì°½
            setTimeout(() => {
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    if (isMobileDevice()) {
                        // ëª¨ë°”ì¼: ì¹´ë©”ë¼ ë°”ë¡œ ì‹¤í–‰
                        fileInput.setAttribute('capture', 'environment'); // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
                        fileInput.setAttribute('accept', 'image/*');
                        console.log('ğŸ“± ëª¨ë°”ì¼ ì¹´ë©”ë¼ ì‹¤í–‰');
                    } else {
                        // ë°ìŠ¤í¬í†±: ì¼ë°˜ íŒŒì¼ ì„ íƒ
                        fileInput.removeAttribute('capture');
                        console.log('ğŸ’» ë°ìŠ¤í¬í†± íŒŒì¼ ì„ íƒ');
                    }
                    fileInput.click();
                }
            }, 100);
        });

        // ì¹´ë©”ë¼ ë²„íŠ¼ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒì°½ ì—´ê¸°
        const cameraBtn = document.getElementById('cameraBtn');
        if (cameraBtn && fileInput) {
          cameraBtn.addEventListener('click', function() {
            if (isMobileDevice()) {
                // ëª¨ë°”ì¼: ì¹´ë©”ë¼ ë°”ë¡œ ì‹¤í–‰
                fileInput.setAttribute('capture', 'environment'); // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
                fileInput.setAttribute('accept', 'image/*');
                console.log('ğŸ“± ëª¨ë°”ì¼ ì¹´ë©”ë¼ ì‹¤í–‰ (ì¹´ë©”ë¼ ë²„íŠ¼)');
            } else {
                // ë°ìŠ¤í¬í†±: ì¼ë°˜ íŒŒì¼ ì„ íƒ
                fileInput.removeAttribute('capture');
                console.log('ğŸ’» ë°ìŠ¤í¬í†± íŒŒì¼ ì„ íƒ (ì¹´ë©”ë¼ ë²„íŠ¼)');
            }
            fileInput.click();
          });
        }
        
        // ğŸ”§ ì¸íŠ¸ë¡œ í™”ë©´ ë²„íŠ¼ì€ HTML onclick ì†ì„±ìœ¼ë¡œ ì²˜ë¦¬ë¨
    </script>
    <script>
    // ê°¤ëŸ¬ë¦¬ ìƒì„¸ ëª¨ë‹¬ ì—´ê¸° (ê²°ê³¼ ì´ë¯¸ì§€ë§Œ)
    function showGalleryModal(resultUrl, title, date) {
        document.getElementById('galleryModal').style.display = 'flex';
        const modalResult = document.getElementById('modalResult');
        if (modalResult) modalResult.src = resultUrl;
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalDate').textContent = date;
    }
    function closeGalleryModal() {
        document.getElementById('galleryModal').style.display = 'none';
    }
    function deleteAllGallery() {
        if (!confirm('ì •ë§ ëª¨ë“  ì‘í’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë¡œì»¬ ê°¤ëŸ¬ë¦¬ ëª¨ë“œ)')) return;
        
        // ë¡œì»¬ ê°¤ëŸ¬ë¦¬ ì „ì²´ ì‚­ì œ (myart.json ì´ˆê¸°í™”)
        try {
            // ê°„ë‹¨í•œ ì•Œë¦¼ë§Œ í‘œì‹œ (ì‹¤ì œ ì‚­ì œëŠ” ì„œë²„ ì¬ì‹œì‘ì‹œ íŒŒì¼ì´ ì´ˆê¸°í™”ë¨)
            showMessage('ëª¨ë“  ì‘í’ˆ ì‚­ì œê°€ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤. (ë¡œì»¬ ê°¤ëŸ¬ë¦¬ ëª¨ë“œ)', 'info');
            loadGallery();
        } catch (error) {
            showMessage('ì „ì²´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    // ì„ íƒ ì‚­ì œ í•¨ìˆ˜ (ë¡œì»¬ ê°¤ëŸ¬ë¦¬ ì‚¬ìš©)
    function deleteSelectedGallery() {
        if (selectedGalleryIds.length === 0) return;
        if (!confirm('ì„ íƒí•œ ì‘í’ˆì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        // ë¡œì»¬ ê°¤ëŸ¬ë¦¬ëŠ” ê°„ë‹¨í•œ ì‚­ì œ ì²˜ë¦¬
        try {
            // í˜„ì¬ëŠ” ë¡œì»¬ ê°¤ëŸ¬ë¦¬ì—ì„œ ê°œë³„ ì‚­ì œë¥¼ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ
            // ì „ì²´ ê°¤ëŸ¬ë¦¬ë¥¼ ë‹¤ì‹œ ë¡œë“œí•˜ê³  ë©”ì‹œì§€ë§Œ í‘œì‹œ
            showMessage(`${selectedGalleryIds.length}ê°œ ì‘í’ˆ ì‚­ì œê°€ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤. (ë¡œì»¬ ê°¤ëŸ¬ë¦¬ ëª¨ë“œ)`, 'info');
            selectedGalleryIds = [];
            document.getElementById('batchDeleteBtn').style.display = 'none';
            isAllSelected = false;
            document.getElementById('selectAllBtn').textContent = 'ì „ì²´ì„ íƒ';
            loadGallery();
        } catch (error) {
            showMessage('ì„ íƒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    </script>
    <script>
    // ë¡œì»¬ ê°¤ëŸ¬ë¦¬ìš© ê°„ì†Œí™”ëœ ìŠ¤í¬ë¦½íŠ¸
    
    // ğŸš€ í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    let isAppInitialized = false;
    function initializeApp() {
        if (isAppInitialized) {
            console.log('âš ï¸ ì•±ì´ ì´ë¯¸ ì´ˆê¸°í™”ë¨, ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€');
                        return;
                    }
        
        console.log('ğŸš€ ì•± ì´ˆê¸°í™” ì‹œì‘');
        isAppInitialized = true;
        
        // ğŸ”§ ì¸íŠ¸ë¡œ ë²„íŠ¼ì€ ì´ì œ onclick ì†ì„±ìœ¼ë¡œ ì§ì ‘ ì²˜ë¦¬ë¨
        
        // localStorageì—ì„œ í† í°ê³¼ ì‚¬ìš©ì ì •ë³´ ë³µì›
        const savedToken = localStorage.getItem('token');
        const savedUserId = localStorage.getItem('userId');
        const savedUsername = localStorage.getItem('username');
        const savedEmail = localStorage.getItem('email');
        
        console.log('ğŸ’¾ ì €ì¥ëœ ì •ë³´ í™•ì¸:', {
            token: savedToken?.substring(0, 50) + '...',
            userId: savedUserId,
            username: savedUsername,
            email: savedEmail
        });
        
        if (savedToken && savedUserId) {
            // í† í°ê³¼ ì‚¬ìš©ì ì •ë³´ ë³µì›
            authToken = savedToken;
            currentUser = {
                id: savedUserId,
                username: savedUsername,
                email: savedEmail
            };
            
            console.log('âœ… ì‚¬ìš©ì ì„¸ì…˜ ë³µì› ì™„ë£Œ:', currentUser);
            updateAuthUI();
                    } else {
            console.log('âš ï¸ ì €ì¥ëœ ì„¸ì…˜ ì—†ìŒ, ë¡œê·¸ì¸ í•„ìš”');
        }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', initializeApp);
    
    // ì¦‰ì‹œ ì‹¤í–‰ìœ¼ë¡œ ì•ˆì „ì¥ì¹˜ ì¶”ê°€ (DOMContentLoadedê°€ ì´ë¯¸ ì‹¤í–‰ëœ ê²½ìš° ëŒ€ë¹„)
    if (document.readyState === 'loading') {
        // DOMì´ ì•„ì§ ë¡œë”© ì¤‘ì´ë©´ DOMContentLoaded ì´ë²¤íŠ¸ë¥¼ ê¸°ë‹¤ë¦¼
        console.log('â³ DOM ë¡œë”© ì¤‘, DOMContentLoaded ì´ë²¤íŠ¸ ëŒ€ê¸°');
    } else {
        // DOMì´ ì´ë¯¸ ë¡œë“œ ì™„ë£Œë˜ì—ˆìœ¼ë©´ ì¦‰ì‹œ ì´ˆê¸°í™”
        console.log('âœ… DOM ì´ë¯¸ ë¡œë“œë¨, ì¦‰ì‹œ ì´ˆê¸°í™” ì‹¤í–‰');
        initializeApp();
    }
    
    // windowì— í•¨ìˆ˜ í• ë‹¹ (ëª¨ë“  í•¨ìˆ˜ ì •ì˜ í›„)
    window.showGallery = showGallery;
    window.saveToGallery = saveToGallery;
    window.showGalleryModal = showGalleryModal;
    window.closeGalleryModal = closeGalleryModal;
    window.deleteAllGallery = deleteAllGallery;
    window.deleteSelectedGallery = deleteSelectedGallery;
    
    </script>
</body>
</html> 